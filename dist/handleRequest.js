var D=Object.create;var{getPrototypeOf:M,defineProperty:Q,getOwnPropertyNames:A}=Object;var F=Object.prototype.hasOwnProperty;var w=(L,G,O)=>{O=L!=null?D(M(L)):{};let z=G||!L||!L.__esModule?Q(O,"default",{value:L,enumerable:!0}):O;for(let J of A(L))if(!F.call(z,J))Q(z,J,{get:()=>L[J],enumerable:!0});return z};var H=((L)=>typeof require!=="undefined"?require:typeof Proxy!=="undefined"?new Proxy(L,{get:(G,O)=>(typeof require!=="undefined"?require:G)[O]}):L)(function(L){if(typeof require!=="undefined")return require.apply(this,arguments);throw Error('Dynamic require of "'+L+'" is not supported')});function W(L){switch(L.split(".").pop()?.toLowerCase()){case"js":return"application/javascript";case"css":return"text/css";case"html":return"text/html";case"json":return"application/json";case"png":return"image/png";case"jpg":case"jpeg":return"image/jpeg";case"svg":return"image/svg+xml";case"gif":return"image/gif";case"woff":return"font/woff";case"woff2":return"font/woff2";default:return"application/octet-stream"}}function _(L,G,O){let z=null,J=null,X=null,j=null,U={},I=new Map([["string","text/plain; charset=utf-8"],["object","application/json; charset=utf-8"],["Uint8Array","application/octet-stream"],["ArrayBuffer","application/octet-stream"]]);return{req:L,server:G,url:O,status:200,headers:new Headers({"Cache-Control":"no-cache"}),setHeader(K,Z){return this.headers.set(K,Z),this},removeHeader(K){return this.headers.delete(K),this},get ip(){return this.server.requestIP(this.req)?.address??null},get query(){if(!z)try{z=Object.fromEntries(this.url.searchParams)}catch(K){throw new Error("Failed to parse query parameters")}return z},get params(){if(!J&&this.req.routePattern)try{J=f(this.req.routePattern,this.url.pathname)}catch(K){throw new Error("Failed to extract route parameters")}return J??{}},get body(){if(this.req.method==="GET")return Promise.resolve({});if(!j)j=(async()=>{let K=await S(this.req);if(K.error)throw new Error(K.error);return Object.keys(K).length===0?null:K})();return j},set(K,Z){return U[K]=Z,this},get(K){return U[K]},text(K,Z){if(Z)this.status=Z;if(!this.headers.has("Content-Type"))this.headers.set("Content-Type","text/plain; charset=utf-8");return new Response(K,{status:this.status,headers:this.headers})},send(K,Z){if(Z)this.status=Z;let Y;if(K instanceof Uint8Array)Y="Uint8Array";else if(K instanceof ArrayBuffer)Y="ArrayBuffer";else Y=typeof K;if(!this.headers.has("Content-Type"))this.headers.set("Content-Type",I.get(Y)??"text/plain; charset=utf-8");let $=Y==="object"&&K!==null?JSON.stringify(K):K;return new Response($,{status:this.status,headers:this.headers})},json(K,Z){if(Z)this.status=Z;if(!this.headers.has("Content-Type"))this.headers.set("Content-Type","application/json; charset=utf-8");return Response.json(K,{status:this.status,headers:this.headers})},file(K,Z,Y){if(Y)this.status=Y;let $=Bun.file(K);if(!this.headers.has("Content-Type"))this.headers.set("Content-Type",Z??W(K));return new Response($,{status:this.status,headers:this.headers})},async ejs(K,Z={},Y){if(Y)this.status=Y;let $;try{$=await import("ejs"),$=$.default||$}catch(V){return console.error("EJS not installed! Please run `bun add ejs`"),new Response("EJS not installed! Please run `bun add ejs`",{status:500})}try{let V=await Bun.file(K).text(),B=$.render(V,Z),C=new Headers({"Content-Type":"text/html; charset=utf-8"});return new Response(B,{status:this.status,headers:C})}catch(V){return console.error("EJS Rendering Error:",V),new Response("Error rendering template",{status:500})}},redirect(K,Z){if(Z)this.status=Z;else this.status=302;return this.headers.set("Location",K),new Response(null,{status:this.status,headers:this.headers})},stream(K){let Z=new Headers(this.headers),Y=new ReadableStream({async start($){await K($),$.close()}});return new Response(Y,{headers:Z})},yieldStream(K){return new Response({async*[Symbol.asyncIterator](){yield*K()}},{headers:this.headers})},setCookie(K,Z,Y={}){let $=`${encodeURIComponent(K)}=${encodeURIComponent(Z)}`;if(Y.maxAge)$+=`; Max-Age=${Y.maxAge}`;if(Y.expires)$+=`; Expires=${Y.expires.toUTCString()}`;if(Y.path)$+=`; Path=${Y.path}`;if(Y.domain)$+=`; Domain=${Y.domain}`;if(Y.secure)$+="; Secure";if(Y.httpOnly)$+="; HttpOnly";if(Y.sameSite)$+=`; SameSite=${Y.sameSite}`;return this.headers.append("Set-Cookie",$),this},get cookies(){if(!X){let K=this.req.headers.get("cookie");X=K?b(K):{}}return X}}}function b(L){return Object.fromEntries(L.split(";").map((G)=>{let[O,...z]=G.trim().split("=");return[O,decodeURIComponent(z.join("="))]}))}function f(L,G){let O={},z=L.split("/"),[J]=G.split("?"),X=J.split("/");if(z.length!==X.length)return null;for(let j=0;j<z.length;j++)if(z[j].startsWith(":"))O[z[j].slice(1)]=X[j];return O}async function S(L){let G=L.headers.get("Content-Type");if(!G)return{};if(L.headers.get("Content-Length")==="0"||!L.body)return{};try{if(G.startsWith("application/json"))return await L.json();if(G.startsWith("application/x-www-form-urlencoded")){let z=await L.text();return Object.fromEntries(new URLSearchParams(z))}if(G.startsWith("multipart/form-data")){let z=await L.formData(),J={};for(let[X,j]of z.entries())J[X]=j;return J}return{error:"Unknown request body type"}}catch(z){return{error:"Invalid request body format"}}}async function T(L,G,O,z){let J=_(L,G,O),X=z.trie.search(O.pathname,L.method);L.routePattern=X?.path;try{if(z.hooks.onRequest)await N("onRequest",z.hooks.onRequest,[L,O,G]);if(z.hasMiddleware){let I=await P(z,O.pathname,J,G);if(I)return I}if(z.hasFilterEnabled){let I=L.routePattern??O.pathname,K=await R(z,I,J,G);if(K)return K}if(!X)return await q(z,J,O.pathname);if(z.hooks.preHandler){let I=await N("preHandler",z.hooks.preHandler,[J,G]);if(I)return I}let j=X.handler(J),U=j instanceof Promise?await j:j;if(z.hasOnSendHook){let I=await N("onSend",z.hooks.onSend,[J,U,G]);if(I)return I}if(U instanceof Response)return U;return E(500,"No response returned from handler.")}catch(j){return await N("onError",z.hooks.onError,[j,L,O,G])||E(500,"Internal Server Error")}}async function N(L,G,O){if(!G?.length)return;for(let z=0;z<G.length;z++){let J=G[z](...O),X=J instanceof Promise?await J:J;if(X&&L!=="onRequest")return X}}async function P(L,G,O,z){if(L.globalMiddlewares.length){let X=await g(L.globalMiddlewares,O,z);if(X)return X}let J=L.middlewares.get(G)||[];if(J.length){let X=await g(J,O,z);if(X)return X}return null}async function g(L,G,O){for(let z of L){let J=await z(G,O);if(J)return J}return null}async function n(L,G,O){for(let z of L){let J=await z(G,O);if(J)return J}}async function R(L,G,O,z){let J=await x(L,G,O,z),X=J instanceof Promise?await J:J;if(X)return X}async function x(L,G,O,z){if(G.endsWith("/"))G=G.slice(0,-1);if(!L.filters.has(G))if(L.filterFunction.length)for(let J of L.filterFunction){let X=await J(O,z);if(X)return X}else return Response.json({error:"Protected route, authentication required"},{status:401})}async function u(L,G,O,z){if(!L.filters.has(G))if(L.filterFunction.length)for(let J of L.filterFunction){let X=await J(O,z);if(X)return X}else return Response.json({error:"Protected route, authentication required"},{status:401})}async function q(L,G,O){if(L.staticPath){let J=await v(L,O,G);if(J)return J;let X=L.trie.search("*",G.req.method);if(X?.handler)return await X.handler(G)}return L.routeNotFoundFunc(G)||E(404,`Route not found for ${O}`)}function E(L,G){return new Response(JSON.stringify({error:G}),{status:L,headers:{"Content-Type":"application/json"}})}async function v(L,G,O){if(!L.staticPath)return null;let z=`${L.staticPath}${G}`;if(await Bun.file(z).exists()){let X=W(z);return O.file(z,X,200)}return null}export{v as handleStaticFiles,x as handleFilterRequest,u as handleBunFilterRequest,E as generateErrorResponse,g as executeMiddlewares,n as executeBunMiddlewares,T as default};
