var g=Object.create;var{getPrototypeOf:D,defineProperty:_,getOwnPropertyNames:E}=Object;var F=Object.prototype.hasOwnProperty;var C=(A,J,X)=>{X=A!=null?g(D(A)):{};let z=J||!A||!A.__esModule?_(X,"default",{value:A,enumerable:!0}):X;for(let O of E(A))if(!F.call(z,O))_(z,O,{get:()=>A[O],enumerable:!0});return z};var M=((A)=>typeof require!=="undefined"?require:typeof Proxy!=="undefined"?new Proxy(A,{get:(J,X)=>(typeof require!=="undefined"?require:J)[X]}):A)(function(A){if(typeof require!=="undefined")return require.apply(this,arguments);throw Error('Dynamic require of "'+A+'" is not supported')});function U(A){switch(A.split(".").pop()?.toLowerCase()){case"js":return"application/javascript";case"css":return"text/css";case"html":return"text/html";case"json":return"application/json";case"png":return"image/png";case"jpg":case"jpeg":return"image/jpeg";case"svg":return"image/svg+xml";case"gif":return"image/gif";case"woff":return"font/woff";case"woff2":return"font/woff2";default:return"application/octet-stream"}}function V(A,J,X){let z=null,O=null,Z=null,$=null,j={};return{req:A,server:J,url:X,status:200,headers:new Headers({"Cache-Control":"no-cache"}),setHeader(L,G){return this.headers.set(L,G),this},removeHeader(L){return this.headers.delete(L),this},get ip(){return this.server.requestIP(this.req)?.address??null},get query(){if(!z)try{z=Object.fromEntries(this.url.searchParams)}catch(L){throw new Error("Failed to parse query parameters")}return z},get params(){if(!O&&this.req.routePattern)try{O=w(this.req.routePattern,this.url.pathname)}catch(L){throw new Error("Failed to extract route parameters")}return O??{}},get body(){if(this.req.method==="GET")return Promise.resolve({});if(!$)$=(async()=>{let L=await H(this.req);if(L.error)throw new Error(L.error);return Object.keys(L).length===0?null:L})();return $},set(L,G){return j[L]=G,this},get(L){return j[L]},text(L,G){if(G)this.status=G;if(!this.headers.has("Content-Type"))this.headers.set("Content-Type","text/plain; charset=utf-8");return new Response(L,{status:this.status,headers:this.headers})},send(L,G){if(G)this.status=G;let K=new Map([["string","text/plain; charset=utf-8"],["object","application/json; charset=utf-8"],["Uint8Array","application/octet-stream"],["ArrayBuffer","application/octet-stream"]]),Y;if(L instanceof Uint8Array)Y="Uint8Array";else if(L instanceof ArrayBuffer)Y="ArrayBuffer";else Y=typeof L;if(!this.headers.has("Content-Type"))this.headers.set("Content-Type",K.get(Y)??"text/plain; charset=utf-8");let I=Y==="object"&&L!==null?JSON.stringify(L):L;return new Response(I,{status:this.status,headers:this.headers})},json(L,G){if(G)this.status=G;if(!this.headers.has("Content-Type"))this.headers.set("Content-Type","application/json; charset=utf-8");return Response.json(L,{status:this.status,headers:this.headers})},file(L,G,K){if(K)this.status=K;let Y=Bun.file(L);if(!this.headers.has("Content-Type"))this.headers.set("Content-Type",G??U(L));return new Response(Y,{status:this.status,headers:this.headers})},async ejs(L,G={},K){if(K)this.status=K;let Y;try{Y=await import("ejs"),Y=Y.default||Y}catch(I){return console.error("EJS not installed! Please run `bun add ejs`"),new Response("EJS not installed! Please run `bun add ejs`",{status:500})}try{let I=await Bun.file(L).text(),B=Y.render(I,G),Q=new Headers({"Content-Type":"text/html; charset=utf-8"});return new Response(B,{status:this.status,headers:Q})}catch(I){return console.error("EJS Rendering Error:",I),new Response("Error rendering template",{status:500})}},redirect(L,G){if(G)this.status=G;else this.status=302;return this.headers.set("Location",L),new Response(null,{status:this.status,headers:this.headers})},stream(L){let G=new Headers(this.headers),K=new ReadableStream({async start(Y){await L(Y),Y.close()}});return new Response(K,{headers:G})},yieldStream(L){return new Response({async*[Symbol.asyncIterator](){yield*L()}},{headers:this.headers})},setCookie(L,G,K={}){let Y=`${encodeURIComponent(L)}=${encodeURIComponent(G)}`;if(K.maxAge)Y+=`; Max-Age=${K.maxAge}`;if(K.expires)Y+=`; Expires=${K.expires.toUTCString()}`;if(K.path)Y+=`; Path=${K.path}`;if(K.domain)Y+=`; Domain=${K.domain}`;if(K.secure)Y+="; Secure";if(K.httpOnly)Y+="; HttpOnly";if(K.sameSite)Y+=`; SameSite=${K.sameSite}`;return this.headers.append("Set-Cookie",Y),this},get cookies(){if(!Z){let L=this.req.headers.get("cookie");Z=L?b(L):{}}return Z}}}function b(A){return Object.fromEntries(A.split(";").map((J)=>{let[X,...z]=J.trim().split("=");return[X,decodeURIComponent(z.join("="))]}))}function w(A,J){let X={},z=A.split("/"),[O]=J.split("?"),Z=O.split("/");if(z.length!==Z.length)return null;for(let $=0;$<z.length;$++)if(z[$].startsWith(":"))X[z[$].slice(1)]=Z[$];return X}async function H(A){let J=A.headers.get("Content-Type");if(!J)return{};if(A.headers.get("Content-Length")==="0"||!A.body)return{};try{if(J.startsWith("application/json"))return await A.json();if(J.startsWith("application/x-www-form-urlencoded")){let z=await A.text();return Object.fromEntries(new URLSearchParams(z))}if(J.startsWith("multipart/form-data")){let z=await A.formData(),O={};for(let[Z,$]of z.entries())O[Z]=$;return O}return{error:"Unknown request body type"}}catch(z){return{error:"Invalid request body format"}}}async function f(A,J,X,z){let O=V(A,J,X),Z=z.trie.search(X.pathname,A.method);A.routePattern=Z?.path;try{if(z.hasMiddleware){if(z.globalMiddlewares.length){let G=await N(z.globalMiddlewares,O,J);if(G)return G}let L=z.middlewares.get(X.pathname)||[];if(L?.length){let G=await N(L,O,J);if(G)return G}}if(z.hasFilterEnabled){let L=A.routePattern??X.pathname,G=await T(z,L,O,J),K=G instanceof Promise?await G:G;if(K)return K}if(!Z?.handler||Z.method!==A.method){if(z.staticPath){let G=await P(z,X.pathname,O);if(G)return G;let K=z.trie.search("*",A.method);if(K?.handler)return await K.handler(O)}let L=z.routeNotFoundFunc(O);if(L)return L;return W(404,`Route not found for ${X.pathname}`)}if(z.hooks.preHandler?.length&&Array.isArray(z.hooks.preHandler)){let L=z.hooks.preHandler;for(let G=0;G<L.length;G++){let K=L[G](O),Y=K instanceof Promise?await K:K;if(Y)return Y}}let $=Z.handler(O);return($ instanceof Promise?await $:$)??W(204,"")}catch($){if(z.hooks.onError&&Array.isArray(z.hooks.onError)){let j=z.hooks.onError;for(let L=0;L<j.length;L++){let G=z.hooks.onError[L]($,A,X,J),K=G instanceof Promise?await G:G;if(K)return K}}return W(500,"Internal Server Error")}finally{if(z.hooks.onSend&&Array.isArray(z.hooks.onSend)){let $=z.hooks.onSend;for(let j=0;j<$.length;j++){let L=$[j](O),G=L instanceof Promise?await L:L;if(G)return G}}}}async function N(A,J,X){for(let z of A){let O=await z(J,X);if(O)return O}return null}async function R(A,J,X){for(let z of A){let O=await z(J,X);if(O)return O}}async function T(A,J,X,z){if(J.endsWith("/"))J=J.slice(0,-1);if(!A.filters.has(J))if(A.filterFunction.length)for(let O of A.filterFunction){let Z=await O(X,z);if(Z)return Z}else return Response.json({error:"Protected route, authentication required"},{status:401})}async function k(A,J,X,z){if(!A.filters.has(J))if(A.filterFunction.length)for(let O of A.filterFunction){let Z=await O(X,z);if(Z)return Z}else return Response.json({error:"Protected route, authentication required"},{status:401})}function W(A,J){return new Response(JSON.stringify({error:J}),{status:A,headers:{"Content-Type":"application/json"}})}async function P(A,J,X){if(!A.staticPath)return null;let z=`${A.staticPath}${J}`;if(await Bun.file(z).exists()){let Z=U(z);return X.file(z,Z,200)}return null}export{P as handleStaticFiles,T as handleFilterRequest,k as handleBunFilterRequest,W as generateErrorResponse,N as executeMiddlewares,R as executeBunMiddlewares,f as default};
