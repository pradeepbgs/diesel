var f0=Object.create;var{getPrototypeOf:K0,defineProperty:_,getOwnPropertyNames:K1,getOwnPropertyDescriptor:F0}=Object,F1=Object.prototype.hasOwnProperty;var U0=($,z,Z)=>{Z=$!=null?f0(K0($)):{};let C=z||!$||!$.__esModule?_(Z,"default",{value:$,enumerable:!0}):Z;for(let J of K1($))if(!F1.call(C,J))_(C,J,{get:()=>$[J],enumerable:!0});return C},f1=new WeakMap,D0=($)=>{var z=f1.get($),Z;if(z)return z;if(z=_({},"__esModule",{value:!0}),$&&typeof $==="object"||typeof $==="function")K1($).map((C)=>!F1.call(z,C)&&_(z,C,{get:()=>$[C],enumerable:!(Z=F0($,C))||Z.enumerable}));return f1.set($,z),z},p=($,z)=>()=>(z||$((z={exports:{}}).exports,z),z.exports);var N0=($,z)=>{for(var Z in z)_($,Z,{get:z[Z],enumerable:!0,configurable:!0,set:(C)=>z[Z]=()=>C})};var q0=($,z)=>()=>($&&(z=$($=0)),z);var A0=(($)=>typeof require!=="undefined"?require:typeof Proxy!=="undefined"?new Proxy($,{get:(z,Z)=>(typeof require!=="undefined"?require:z)[Z]}):$)(function($){if(typeof require!=="undefined")return require.apply(this,arguments);throw Error('Dynamic require of "'+$+'" is not supported')});var R1={};N0(R1,{sep:()=>M1,resolve:()=>c,relative:()=>q1,posix:()=>I1,parse:()=>H1,normalize:()=>s,join:()=>N1,isAbsolute:()=>D1,format:()=>j1,extname:()=>L1,dirname:()=>S1,delimiter:()=>O1,default:()=>O,basename:()=>w1,_makeLong:()=>A1});function S($){if(typeof $!=="string")throw new TypeError("Path must be a string. Received "+JSON.stringify($))}function U1($,z){var Z="",C=0,J=-1,X=0,Q;for(var Y=0;Y<=$.length;++Y){if(Y<$.length)Q=$.charCodeAt(Y);else if(Q===47)break;else Q=47;if(Q===47){if(J===Y-1||X===1);else if(J!==Y-1&&X===2){if(Z.length<2||C!==2||Z.charCodeAt(Z.length-1)!==46||Z.charCodeAt(Z.length-2)!==46){if(Z.length>2){var B=Z.lastIndexOf("/");if(B!==Z.length-1){if(B===-1)Z="",C=0;else Z=Z.slice(0,B),C=Z.length-1-Z.lastIndexOf("/");J=Y,X=0;continue}}else if(Z.length===2||Z.length===1){Z="",C=0,J=Y,X=0;continue}}if(z){if(Z.length>0)Z+="/..";else Z="..";C=2}}else{if(Z.length>0)Z+="/"+$.slice(J+1,Y);else Z=$.slice(J+1,Y);C=Y-J-1}J=Y,X=0}else if(Q===46&&X!==-1)++X;else X=-1}return Z}function S0($,z){var Z=z.dir||z.root,C=z.base||(z.name||"")+(z.ext||"");if(!Z)return C;if(Z===z.root)return Z+C;return Z+$+C}function c(){var $="",z=!1,Z;for(var C=arguments.length-1;C>=-1&&!z;C--){var J;if(C>=0)J=arguments[C];else{if(Z===void 0)Z=process.cwd();J=Z}if(S(J),J.length===0)continue;$=J+"/"+$,z=J.charCodeAt(0)===47}if($=U1($,!z),z)if($.length>0)return"/"+$;else return"/";else if($.length>0)return $;else return"."}function s($){if(S($),$.length===0)return".";var z=$.charCodeAt(0)===47,Z=$.charCodeAt($.length-1)===47;if($=U1($,!z),$.length===0&&!z)$=".";if($.length>0&&Z)$+="/";if(z)return"/"+$;return $}function D1($){return S($),$.length>0&&$.charCodeAt(0)===47}function N1(){if(arguments.length===0)return".";var $;for(var z=0;z<arguments.length;++z){var Z=arguments[z];if(S(Z),Z.length>0)if($===void 0)$=Z;else $+="/"+Z}if($===void 0)return".";return s($)}function q1($,z){if(S($),S(z),$===z)return"";if($=c($),z=c(z),$===z)return"";var Z=1;for(;Z<$.length;++Z)if($.charCodeAt(Z)!==47)break;var C=$.length,J=C-Z,X=1;for(;X<z.length;++X)if(z.charCodeAt(X)!==47)break;var Q=z.length,Y=Q-X,B=J<Y?J:Y,G=-1,V=0;for(;V<=B;++V){if(V===B){if(Y>B){if(z.charCodeAt(X+V)===47)return z.slice(X+V+1);else if(V===0)return z.slice(X+V)}else if(J>B){if($.charCodeAt(Z+V)===47)G=V;else if(V===0)G=0}break}var W=$.charCodeAt(Z+V),f=z.charCodeAt(X+V);if(W!==f)break;else if(W===47)G=V}var K="";for(V=Z+G+1;V<=C;++V)if(V===C||$.charCodeAt(V)===47)if(K.length===0)K+="..";else K+="/..";if(K.length>0)return K+z.slice(X+G);else{if(X+=G,z.charCodeAt(X)===47)++X;return z.slice(X)}}function A1($){return $}function S1($){if(S($),$.length===0)return".";var z=$.charCodeAt(0),Z=z===47,C=-1,J=!0;for(var X=$.length-1;X>=1;--X)if(z=$.charCodeAt(X),z===47){if(!J){C=X;break}}else J=!1;if(C===-1)return Z?"/":".";if(Z&&C===1)return"//";return $.slice(0,C)}function w1($,z){if(z!==void 0&&typeof z!=="string")throw new TypeError('"ext" argument must be a string');S($);var Z=0,C=-1,J=!0,X;if(z!==void 0&&z.length>0&&z.length<=$.length){if(z.length===$.length&&z===$)return"";var Q=z.length-1,Y=-1;for(X=$.length-1;X>=0;--X){var B=$.charCodeAt(X);if(B===47){if(!J){Z=X+1;break}}else{if(Y===-1)J=!1,Y=X+1;if(Q>=0)if(B===z.charCodeAt(Q)){if(--Q===-1)C=X}else Q=-1,C=Y}}if(Z===C)C=Y;else if(C===-1)C=$.length;return $.slice(Z,C)}else{for(X=$.length-1;X>=0;--X)if($.charCodeAt(X)===47){if(!J){Z=X+1;break}}else if(C===-1)J=!1,C=X+1;if(C===-1)return"";return $.slice(Z,C)}}function L1($){S($);var z=-1,Z=0,C=-1,J=!0,X=0;for(var Q=$.length-1;Q>=0;--Q){var Y=$.charCodeAt(Q);if(Y===47){if(!J){Z=Q+1;break}continue}if(C===-1)J=!1,C=Q+1;if(Y===46){if(z===-1)z=Q;else if(X!==1)X=1}else if(z!==-1)X=-1}if(z===-1||C===-1||X===0||X===1&&z===C-1&&z===Z+1)return"";return $.slice(z,C)}function j1($){if($===null||typeof $!=="object")throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof $);return S0("/",$)}function H1($){S($);var z={root:"",dir:"",base:"",ext:"",name:""};if($.length===0)return z;var Z=$.charCodeAt(0),C=Z===47,J;if(C)z.root="/",J=1;else J=0;var X=-1,Q=0,Y=-1,B=!0,G=$.length-1,V=0;for(;G>=J;--G){if(Z=$.charCodeAt(G),Z===47){if(!B){Q=G+1;break}continue}if(Y===-1)B=!1,Y=G+1;if(Z===46){if(X===-1)X=G;else if(V!==1)V=1}else if(X!==-1)V=-1}if(X===-1||Y===-1||V===0||V===1&&X===Y-1&&X===Q+1){if(Y!==-1)if(Q===0&&C)z.base=z.name=$.slice(1,Y);else z.base=z.name=$.slice(Q,Y)}else{if(Q===0&&C)z.name=$.slice(1,X),z.base=$.slice(1,Y);else z.name=$.slice(Q,X),z.base=$.slice(Q,Y);z.ext=$.slice(X,Y)}if(Q>0)z.dir=$.slice(0,Q-1);else if(C)z.dir="/";return z}var M1="/",O1=":",I1,O;var r=q0(()=>{I1=(($)=>($.posix=$,$))({resolve:c,normalize:s,isAbsolute:D1,join:N1,relative:q1,_makeLong:A1,dirname:S1,basename:w1,extname:L1,format:j1,parse:H1,sep:M1,delimiter:O1,win32:null,posix:null}),O=I1});var b1=p((I0)=>{var w0=/[|\\{}()[\]^$+*?.]/g,L0=Object.prototype.hasOwnProperty,t=function($,z){return L0.apply($,[z])};I0.escapeRegExpChars=function($){if(!$)return"";return String($).replace(w0,"\\$&")};var j0={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&#34;","'":"&#39;"},H0=/[&<>'"]/g;function M0($){return j0[$]||$}var O0=`var _ENCODE_HTML_RULES = {
      "&": "&amp;"
    , "<": "&lt;"
    , ">": "&gt;"
    , '"': "&#34;"
    , "'": "&#39;"
    }
  , _MATCH_HTML = /[&<>'"]/g;
function encode_char(c) {
  return _ENCODE_HTML_RULES[c] || c;
};
`;I0.escapeXML=function($){return $==null?"":String($).replace(H0,M0)};function T1(){return Function.prototype.toString.call(this)+`;
`+O0}try{if(typeof Object.defineProperty==="function")Object.defineProperty(I0.escapeXML,"toString",{value:T1});else I0.escapeXML.toString=T1}catch($){console.warn("Unable to set escapeXML.toString (is the Function prototype frozen?)")}I0.shallowCopy=function($,z){if(z=z||{},$!==null&&$!==void 0)for(var Z in z){if(!t(z,Z))continue;if(Z==="__proto__"||Z==="constructor")continue;$[Z]=z[Z]}return $};I0.shallowCopyFromList=function($,z,Z){if(Z=Z||[],z=z||{},$!==null&&$!==void 0)for(var C=0;C<Z.length;C++){var J=Z[C];if(typeof z[J]!="undefined"){if(!t(z,J))continue;if(J==="__proto__"||J==="constructor")continue;$[J]=z[J]}}return $};I0.cache={_data:{},set:function($,z){this._data[$]=z},get:function($){return this._data[$]},remove:function($){delete this._data[$]},reset:function(){this._data={}}};I0.hyphenToCamel=function($){return $.replace(/-[a-z]/g,function(z){return z[1].toUpperCase()})};I0.createNullProtoObjWherePossible=function(){if(typeof Object.create=="function")return function(){return Object.create(null)};if(!({__proto__:null}instanceof Object))return function(){return{__proto__:null}};return function(){return{}}}();I0.hasOwnOnlyObject=function($){var z=I0.createNullProtoObjWherePossible();for(var Z in $)if(t($,Z))z[Z]=$[Z];return z}});var E1=p((M4,v0)=>{v0.exports={name:"ejs",description:"Embedded JavaScript templates",keywords:["template","engine","ejs"],version:"3.1.10",author:"Matthew Eernisse <mde@fleegix.org> (http://fleegix.org)",license:"Apache-2.0",bin:{ejs:"./bin/cli.js"},main:"./lib/ejs.js",jsdelivr:"ejs.min.js",unpkg:"ejs.min.js",repository:{type:"git",url:"git://github.com/mde/ejs.git"},bugs:"https://github.com/mde/ejs/issues",homepage:"https://github.com/mde/ejs",dependencies:{jake:"^10.8.5"},devDependencies:{browserify:"^16.5.1",eslint:"^6.8.0","git-directory-deploy":"^1.5.1",jsdoc:"^4.0.2","lru-cache":"^4.0.1",mocha:"^10.2.0","uglify-js":"^3.3.16"},engines:{node:">=0.10.0"},scripts:{test:"npx jake test"}}});var l1=p((m1)=>{var Z1=(()=>({})),E=(r(),D0(R1)),U=b1(),P1=!1,g0=E1().version,x0="<",k0=">",y0="%",c1="locals",c0="ejs",u0="(<%%|%%>|<%=|<%-|<%_|<%#|<%|%>|-%>|_%>)",u1=["delimiter","scope","context","debug","compileDebug","client","_with","rmWhitespace","strict","filename","async"],m0=u1.concat("cache"),v1=/^\uFEFF/,e=/^[a-zA-Z_$][0-9a-zA-Z_$]*$/;m1.cache=U.cache;m1.fileLoader=Z1.readFileSync;m1.localsName=c1;m1.promiseImpl=new Function("return this;")().Promise;m1.resolveInclude=function($,z,Z){var{dirname:C,extname:J,resolve:X}=E,Q=X(Z?z:C(z),$),Y=J($);if(!Y)Q+=".ejs";return Q};function g1($,z){var Z;if(z.some(function(C){return Z=m1.resolveInclude($,C,!0),Z1.existsSync(Z)}))return Z}function h0($,z){var Z,C,J=z.views,X=/^[A-Za-z]+:\\|^\//.exec($);if(X&&X.length)if($=$.replace(/^\/*/,""),Array.isArray(z.root))Z=g1($,z.root);else Z=m1.resolveInclude($,z.root||"/",!0);else{if(z.filename){if(C=m1.resolveInclude($,z.filename),Z1.existsSync(C))Z=C}if(!Z&&Array.isArray(J))Z=g1($,J);if(!Z&&typeof z.includer!=="function")throw new Error('Could not find the include file "'+z.escapeFunction($)+'"')}return Z}function P($,z){var Z,C=$.filename,J=arguments.length>1;if($.cache){if(!C)throw new Error("cache option requires a filename");if(Z=m1.cache.get(C),Z)return Z;if(!J)z=x1(C).toString().replace(v1,"")}else if(!J){if(!C)throw new Error("Internal EJS error: no file name or template provided");z=x1(C).toString().replace(v1,"")}if(Z=m1.compile(z,$),$.cache)m1.cache.set(C,Z);return Z}function d0($,z,Z){var C;if(!Z)if(typeof m1.promiseImpl=="function")return new m1.promiseImpl(function(J,X){try{C=P($)(z),J(C)}catch(Q){X(Q)}});else throw new Error("Please provide a callback function");else{try{C=P($)(z)}catch(J){return Z(J)}Z(null,C)}}function x1($){return m1.fileLoader($)}function i0($,z){var Z=U.shallowCopy(U.createNullProtoObjWherePossible(),z);if(Z.filename=h0($,Z),typeof z.includer==="function"){var C=z.includer($,Z.filename);if(C){if(C.filename)Z.filename=C.filename;if(C.template)return P(Z,C.template)}}return P(Z)}function k1($,z,Z,C,J){var X=z.split(`
`),Q=Math.max(C-3,0),Y=Math.min(X.length,C+3),B=J(Z),G=X.slice(Q,Y).map(function(V,W){var f=W+Q+1;return(f==C?" >> ":"    ")+f+"| "+V}).join(`
`);throw $.path=B,$.message=(B||"ejs")+":"+C+`
`+G+`

`+$.message,$}function y1($){return $.replace(/;(\s*$)/,"$1")}m1.compile=function $(z,Z){var C;if(Z&&Z.scope){if(!P1)console.warn("`scope` option is deprecated and will be removed in EJS 3"),P1=!0;if(!Z.context)Z.context=Z.scope;delete Z.scope}return C=new q(z,Z),C.compile()};m1.render=function($,z,Z){var C=z||U.createNullProtoObjWherePossible(),J=Z||U.createNullProtoObjWherePossible();if(arguments.length==2)U.shallowCopyFromList(J,C,u1);return P(J,$)(C)};m1.renderFile=function(){var $=Array.prototype.slice.call(arguments),z=$.shift(),Z,C={filename:z},J,X;if(typeof arguments[arguments.length-1]=="function")Z=$.pop();if($.length){if(J=$.shift(),$.length)U.shallowCopy(C,$.pop());else{if(J.settings){if(J.settings.views)C.views=J.settings.views;if(J.settings["view cache"])C.cache=!0;if(X=J.settings["view options"],X)U.shallowCopy(C,X)}U.shallowCopyFromList(C,J,m0)}C.filename=z}else J=U.createNullProtoObjWherePossible();return d0(C,J,Z)};m1.Template=q;m1.clearCache=function(){m1.cache.reset()};function q($,z){var Z=U.hasOwnOnlyObject(z),C=U.createNullProtoObjWherePossible();if(this.templateText=$,this.mode=null,this.truncate=!1,this.currentLine=1,this.source="",C.client=Z.client||!1,C.escapeFunction=Z.escape||Z.escapeFunction||U.escapeXML,C.compileDebug=Z.compileDebug!==!1,C.debug=!!Z.debug,C.filename=Z.filename,C.openDelimiter=Z.openDelimiter||m1.openDelimiter||x0,C.closeDelimiter=Z.closeDelimiter||m1.closeDelimiter||k0,C.delimiter=Z.delimiter||m1.delimiter||y0,C.strict=Z.strict||!1,C.context=Z.context,C.cache=Z.cache||!1,C.rmWhitespace=Z.rmWhitespace,C.root=Z.root,C.includer=Z.includer,C.outputFunctionName=Z.outputFunctionName,C.localsName=Z.localsName||m1.localsName||c1,C.views=Z.views,C.async=Z.async,C.destructuredLocals=Z.destructuredLocals,C.legacyInclude=typeof Z.legacyInclude!="undefined"?!!Z.legacyInclude:!0,C.strict)C._with=!1;else C._with=typeof Z._with!="undefined"?Z._with:!0;this.opts=C,this.regex=this.createRegex()}q.modes={EVAL:"eval",ESCAPED:"escaped",RAW:"raw",COMMENT:"comment",LITERAL:"literal"};q.prototype={createRegex:function(){var $=u0,z=U.escapeRegExpChars(this.opts.delimiter),Z=U.escapeRegExpChars(this.opts.openDelimiter),C=U.escapeRegExpChars(this.opts.closeDelimiter);return $=$.replace(/%/g,z).replace(/</g,Z).replace(/>/g,C),new RegExp($)},compile:function(){var $,z,Z=this.opts,C="",J="",X=Z.escapeFunction,Q,Y=Z.filename?JSON.stringify(Z.filename):"undefined";if(!this.source){if(this.generateSource(),C+=`  var __output = "";
  function __append(s) { if (s !== undefined && s !== null) __output += s }
`,Z.outputFunctionName){if(!e.test(Z.outputFunctionName))throw new Error("outputFunctionName is not a valid JS identifier.");C+="  var "+Z.outputFunctionName+` = __append;
`}if(Z.localsName&&!e.test(Z.localsName))throw new Error("localsName is not a valid JS identifier.");if(Z.destructuredLocals&&Z.destructuredLocals.length){var B="  var __locals = ("+Z.localsName+` || {}),
`;for(var G=0;G<Z.destructuredLocals.length;G++){var V=Z.destructuredLocals[G];if(!e.test(V))throw new Error("destructuredLocals["+G+"] is not a valid JS identifier.");if(G>0)B+=`,
  `;B+=V+" = __locals."+V}C+=B+`;
`}if(Z._with!==!1)C+="  with ("+Z.localsName+` || {}) {
`,J+=`  }
`;J+=`  return __output;
`,this.source=C+this.source+J}if(Z.compileDebug)$=`var __line = 1
  , __lines = `+JSON.stringify(this.templateText)+`
  , __filename = `+Y+`;
try {
`+this.source+`} catch (e) {
  rethrow(e, __lines, __filename, __line, escapeFn);
}
`;else $=this.source;if(Z.client){if($="escapeFn = escapeFn || "+X.toString()+`;
`+$,Z.compileDebug)$="rethrow = rethrow || "+k1.toString()+`;
`+$}if(Z.strict)$=`"use strict";
`+$;if(Z.debug)console.log($);if(Z.compileDebug&&Z.filename)$=$+`
//# sourceURL=`+Y+`
`;try{if(Z.async)try{Q=new Function("return (async function(){}).constructor;")()}catch(N){if(N instanceof SyntaxError)throw new Error("This environment does not support async/await");else throw N}else Q=Function;z=new Q(Z.localsName+", escapeFn, include, rethrow",$)}catch(N){if(N instanceof SyntaxError){if(Z.filename)N.message+=" in "+Z.filename;if(N.message+=` while compiling ejs

`,N.message+=`If the above error is not helpful, you may want to try EJS-Lint:
`,N.message+="https://github.com/RyanZim/EJS-Lint",!Z.async)N.message+=`
`,N.message+="Or, if you meant to create an async function, pass `async: true` as an option."}throw N}var W=Z.client?z:function N(T){var w=function(A,o){var n=U.shallowCopy(U.createNullProtoObjWherePossible(),T);if(o)n=U.shallowCopy(n,o);return i0(A,Z)(n)};return z.apply(Z.context,[T||U.createNullProtoObjWherePossible(),X,w,k1])};if(Z.filename&&typeof Object.defineProperty==="function"){var f=Z.filename,K=E.basename(f,E.extname(f));try{Object.defineProperty(W,"name",{value:K,writable:!1,enumerable:!1,configurable:!0})}catch(N){}}return W},generateSource:function(){var $=this.opts;if($.rmWhitespace)this.templateText=this.templateText.replace(/[\r\n]+/g,`
`).replace(/^\s+|\s+$/gm,"");this.templateText=this.templateText.replace(/[ \t]*<%_/gm,"<%_").replace(/_%>[ \t]*/gm,"_%>");var z=this,Z=this.parseTemplateText(),C=this.opts.delimiter,J=this.opts.openDelimiter,X=this.opts.closeDelimiter;if(Z&&Z.length)Z.forEach(function(Q,Y){var B;if(Q.indexOf(J+C)===0&&Q.indexOf(J+C+C)!==0){if(B=Z[Y+2],!(B==C+X||B=="-"+C+X||B=="_"+C+X))throw new Error('Could not find matching close tag for "'+Q+'".')}z.scanLine(Q)})},parseTemplateText:function(){var $=this.templateText,z=this.regex,Z=z.exec($),C=[],J;while(Z){if(J=Z.index,J!==0)C.push($.substring(0,J)),$=$.slice(J);C.push(Z[0]),$=$.slice(Z[0].length),Z=z.exec($)}if($)C.push($);return C},_addOutput:function($){if(this.truncate)$=$.replace(/^(?:\r\n|\r|\n)/,""),this.truncate=!1;if(!$)return $;$=$.replace(/\\/g,"\\\\"),$=$.replace(/\n/g,"\\n"),$=$.replace(/\r/g,"\\r"),$=$.replace(/"/g,"\\\""),this.source+='    ; __append("'+$+`")
`},scanLine:function($){var z=this,Z=this.opts.delimiter,C=this.opts.openDelimiter,J=this.opts.closeDelimiter,X=0;switch(X=$.split(`
`).length-1,$){case C+Z:case C+Z+"_":this.mode=q.modes.EVAL;break;case C+Z+"=":this.mode=q.modes.ESCAPED;break;case C+Z+"-":this.mode=q.modes.RAW;break;case C+Z+"#":this.mode=q.modes.COMMENT;break;case C+Z+Z:this.mode=q.modes.LITERAL,this.source+='    ; __append("'+$.replace(C+Z+Z,C+Z)+`")
`;break;case Z+Z+J:this.mode=q.modes.LITERAL,this.source+='    ; __append("'+$.replace(Z+Z+J,Z+J)+`")
`;break;case Z+J:case"-"+Z+J:case"_"+Z+J:if(this.mode==q.modes.LITERAL)this._addOutput($);this.mode=null,this.truncate=$.indexOf("-")===0||$.indexOf("_")===0;break;default:if(this.mode){switch(this.mode){case q.modes.EVAL:case q.modes.ESCAPED:case q.modes.RAW:if($.lastIndexOf("//")>$.lastIndexOf(`
`))$+=`
`}switch(this.mode){case q.modes.EVAL:this.source+="    ; "+$+`
`;break;case q.modes.ESCAPED:this.source+="    ; __append(escapeFn("+y1($)+`))
`;break;case q.modes.RAW:this.source+="    ; __append("+y1($)+`)
`;break;case q.modes.COMMENT:break;case q.modes.LITERAL:this._addOutput($);break}}else this._addOutput($)}if(z.opts.compileDebug&&X)this.currentLine+=X,this.source+="    ; __line = "+this.currentLine+`
`}};m1.escapeXML=U.escapeXML;m1.__express=m1.renderFile;m1.VERSION=g0;m1.name=c0;if(typeof window!="undefined")window.ejs=m1});class k{children;isEndOfWord;handler;isDynamic;pattern;path;method;constructor(){this.children={},this.isEndOfWord=!1,this.handler=[],this.isDynamic=!1,this.pattern="",this.path="",this.method=[]}}class y{root;constructor(){this.root=new k}pushMidl($,...z){let Z=this.root,C=$.split("/").filter(Boolean);if($==="/"){Z.handler.push(...z);return}for(let J of C){let X=J;if(J.startsWith(":"))X=":";if(!Z.children[X])Z.children[X]=new k;Z=Z.children[X]}Z.handler.push(...z)}insert($,z){let Z=this.root,C=$.split("/").filter(Boolean);if($==="/"){Z.isEndOfWord=!0,Z.handler.push(z.handler),Z.path=$,Z.method.push(z.method);return}for(let J of C){let X=!1,Q=J;if(J.startsWith(":"))X=!0,Q=":";if(!Z.children[Q])Z.children[Q]=new k;Z=Z.children[Q],Z.isDynamic=X,Z.pattern=J}Z.isEndOfWord=!0,Z.path=$,Z.method.push(z.method),Z.handler.push(z.handler)}search($,z){let Z=this.root,C=$.split("/").filter(Boolean),J=C.length;for(let Y of C){let B=Y;if(!Z.children[B])if(Z.children[":"])Z=Z.children[":"];else return null;else Z=Z.children[B]}let X=Z.path.split("/").filter(Boolean);if(J!==X.length)return null;if(Z.method.indexOf(z)!==-1)return{path:Z.path,handler:Z.handler[0],pattern:Z.pattern};return null}}function b($){switch($.split(".").pop()?.toLowerCase()){case"js":return"application/javascript";case"css":return"text/css";case"html":return"text/html";case"json":return"application/json";case"png":return"image/png";case"jpg":case"jpeg":return"image/jpeg";case"svg":return"image/svg+xml";case"gif":return"image/gif";case"woff":return"font/woff";case"woff2":return"font/woff2";default:return"application/octet-stream"}}var z1=null;async function o1(){if(!z1){let $=await Promise.resolve().then(() => U0(l1(),1));z1=$.default||$}return z1}class v{req;server;pathname;routePattern;headers=new Headers;parsedQuery=null;parsedParams=null;parsedCookies=null;parsedBody=null;contextData={};urlObject=null;constructor($,z,Z,C=""){this.req=$,this.server=z,this.pathname=Z,this.routePattern=C}setHeader($,z){return this.headers.set($,z),this}removeHeader($){return this.headers.delete($),this}set($,z){return this.contextData[$]=z,this}get($){return this.contextData[$]}get ip(){return this.server.requestIP(this.req)?.address??null}get url(){if(!this.urlObject)this.urlObject=new URL(this.req.url);return this.urlObject}get query(){if(!this.parsedQuery)this.parsedQuery=this.url.search?Object.fromEntries(this.url.searchParams):{};return this.parsedQuery}get params(){if(!this.parsedParams&&this.routePattern)try{this.parsedParams=p1(this.routePattern,this.pathname)}catch($){let z=$ instanceof Error?$.message:String($);throw new Error(`Failed to extract route parameters: ${z}`)}return this.parsedParams??{}}get body(){if(this.req.method==="GET")return Promise.resolve({});if(!this.parsedBody)this.parsedBody=(async()=>{try{let $=await s1(this.req);if($.error)throw new Error($.error);return Object.keys($).length===0?null:$}catch($){throw new Error("Invalid request body format")}})();return this.parsedBody}text($,z=200){return new Response($,{status:z,headers:this.headers})}send($,z=200){let Z;if($ instanceof Uint8Array)Z="Uint8Array";else if($ instanceof ArrayBuffer)Z="ArrayBuffer";else Z=typeof $;let C=Z==="object"&&$!==null?JSON.stringify($):$;return new Response(C,{status:z,headers:this.headers})}json($,z=200){return Response.json($,{status:z,headers:this.headers})}file($,z,Z=200){let C=Bun.file($);if(!this.headers.has("Content-Type"))this.headers.set("Content-Type",z??b($));return new Response(C,{status:Z,headers:this.headers})}async ejs($,z={},Z=200){let C=await o1();try{let J=await Bun.file($).text(),X=C.render(J,z),Q=new Headers({"Content-Type":"text/html; charset=utf-8"});return new Response(X,{status:Z,headers:Q})}catch(J){return console.error("EJS Rendering Error:",J),new Response("Error rendering template",{status:500})}}redirect($,z=302){return this.headers.set("Location",$),new Response(null,{status:z,headers:this.headers})}setCookie($,z,Z={}){let C=`${encodeURIComponent($)}=${encodeURIComponent(z)}`;if(Z.maxAge)C+=`; Max-Age=${Z.maxAge}`;if(Z.expires)C+=`; Expires=${Z.expires.toUTCString()}`;if(Z.path)C+=`; Path=${Z.path}`;if(Z.domain)C+=`; Domain=${Z.domain}`;if(Z.secure)C+="; Secure";if(Z.httpOnly)C+="; HttpOnly";if(Z.sameSite)C+=`; SameSite=${Z.sameSite}`;return this.headers.append("Set-Cookie",C),this}get cookies(){if(!this.parsedCookies){let $=this.req.headers.get("cookie");this.parsedCookies=$?n1($):{}}return this.parsedCookies}stream($){let z=new Headers(this.headers),Z=new ReadableStream({async start(C){await $(C),C.close()}});return new Response(Z,{headers:z})}yieldStream($){return new Response}}function e0($,z,Z,C){let J=null,X=null,Q=null,Y=null,B={},G=null;return{req:$,server:z,pathname:Z,headers:new Headers,setHeader(V,W){return this.headers.set(V,W),this},removeHeader(V){return this.headers.delete(V),this},set(V,W){return B[V]=W,this},get(V){return B[V]},get ip(){return this.server.requestIP($)?.address??null},get url(){if(!G)G=new URL($.url);return G},get query(){if(!J){if(!this.url.search)return{};J=Object.fromEntries(this.url.searchParams)}return J},get params(){if(!X&&C)try{X=p1(C,Z)}catch(V){let W=V instanceof Error?V.message:String(V);throw new Error(`Failed to extract route parameters: ${W}`)}return X??{}},get body(){if($.method==="GET")return Promise.resolve({});if(!Y)Y=(async()=>{try{let V=await s1($);if(V.error)throw new Error(V.error);return Object.keys(V).length===0?null:V}catch(V){throw new Error("Invalid request body format")}})();return Y},text(V,W=200){return new Response(V,{status:W,headers:this.headers})},send(V,W=200){let f;if(V instanceof Uint8Array)f="Uint8Array";else if(V instanceof ArrayBuffer)f="ArrayBuffer";else f=typeof V;let K=f==="object"&&V!==null?JSON.stringify(V):V;return new Response(K,{status:W,headers:this.headers})},json(V,W=200){return Response.json(V,{status:W,headers:this.headers})},file(V,W,f=200){let K=Bun.file(V);if(!this.headers.has("Content-Type"))this.headers.set("Content-Type",W??b(V));return new Response(K,{status:f,headers:this.headers})},async ejs(V,W={},f=200){let K=await o1();try{let N=await Bun.file(V).text(),T=K.render(N,W),w=new Headers({"Content-Type":"text/html; charset=utf-8"});return new Response(T,{status:f,headers:w})}catch(N){return console.error("EJS Rendering Error:",N),new Response("Error rendering template",{status:500})}},redirect(V,W=302){return this.headers.set("Location",V),new Response(null,{status:W,headers:this.headers})},stream(V){let W=new Headers(this.headers),f=new ReadableStream({async start(K){await V(K),K.close()}});return new Response(f,{headers:W})},yieldStream(V){return new Response("not working stream yet.")},setCookie(V,W,f={}){let K=`${encodeURIComponent(V)}=${encodeURIComponent(W)}`;if(f.maxAge)K+=`; Max-Age=${f.maxAge}`;if(f.expires)K+=`; Expires=${f.expires.toUTCString()}`;if(f.path)K+=`; Path=${f.path}`;if(f.domain)K+=`; Domain=${f.domain}`;if(f.secure)K+="; Secure";if(f.httpOnly)K+="; HttpOnly";if(f.sameSite)K+=`; SameSite=${f.sameSite}`;return this.headers.append("Set-Cookie",K),this},get cookies(){if(!Q){let V=this.req.headers.get("cookie");Q=V?n1(V):{}}return Q}}}function n1($){return Object.fromEntries($.split(";").map((z)=>{let[Z,...C]=z.trim().split("=");return[Z,decodeURIComponent(C.join("="))]}))}function p1($,z){let Z={},C=$.split("/"),[J]=z.split("?"),X=J.split("/");if(C.length!==X.length)return null;for(let Q=0;Q<C.length;Q++){let Y=C[Q];if(Y.charCodeAt(0)===58)Z[Y.slice(1)]=X[Q]}return Z}async function s1($){let z=$.headers.get("Content-Type")||"";if(!z)return{};if($.headers.get("Content-Length")==="0"||!$.body)return{};if(z.startsWith("application/json"))return await $.json();if(z.startsWith("application/x-www-form-urlencoded")){let C=await $.text();return Object.fromEntries(new URLSearchParams(C))}if(z.startsWith("multipart/form-data")){let C=await $.formData(),J={};for(let[X,Q]of C.entries())J[X]=Q;return J}return{error:"Unknown request body type"}}async function L($,z,Z){if(!z?.length)return;for(let C=0;C<z.length;C++){let J=z[C](...Z),X=J instanceof Promise?await J:J;if(X&&$!=="onRequest")return X}}async function r1($,z,Z){let C=$.globalMiddlewares;if(C.length)for(let X of C){let Q=await X(Z);if(Q)return Q}let J=$.middlewares.get(z);if(J&&J.length)for(let X of J){let Q=await X(Z);if(Q)return Q}return null}async function a1($,z,Z){for(let C of $){let J=await C(z,Z);if(J)return J}}async function h($,z,Z){let C=await $4($,z,Z),J=C instanceof Promise?await C:C;if(J)return J}async function $4($,z,Z){if(z.endsWith("/"))z=z.slice(0,-1);if(!$.filters.has(z))if($.filterFunction.length)for(let C of $.filterFunction){let J=await C(Z);if(J)return J}else return Response.json({error:"Protected route, authentication required"},{status:401})}async function d($,z,Z){if($.staticPath){let J=!0;if($.staticRequestPath)J=Z.startsWith($.staticRequestPath);if(J){let X=await Z4($,Z,z);if(X)return X;let Q=$.trie.search("*",z.req.method);if(Q?.handler)return await Q.handler(z)}}let C=$.routeNotFoundFunc(z);return C instanceof Promise?await C:C||I(404,`404 Route not found for ${Z}`)}function I($,z){return new Response(JSON.stringify({error:z}),{status:$,headers:{"Content-Type":"application/json"}})}async function Z4($,z,Z){if(!$.staticPath)return null;let C=`${$.staticPath}${z}`;if(await Bun.file(C).exists()){let X=b(C);return Z.file(C,X,200)}return null}var i=($)=>$.constructor.name==="AsyncFunction",C1=($,z,Z,...C)=>{if(z.length>5)$.push(`
      for (let i = 0; i < diesel.hooks.${Z}.length; i++) {
        const result = diesel.hooks.${Z}[i](${C});
        const finalResult = result instanceof Promise ? await result : result;
        if (finalResult && '${Z}' !== 'onRequest') return finalResult
    }
  `);else z?.forEach((J,X)=>{if(i(J))$.push(`
            const ${Z}${X}Result = await diesel.hooks.${Z}[${X}](${C})
            if (${Z}${X}Result && '${Z}' !== 'onRequest') return ${Z}${X}Result
            `);else $.push(`
            const ${Z}${X}Result = diesel.hooks.${Z}[${X}](${C})
             if (${Z}${X}Result && '${Z}' !== 'onRequest') return ${Z}${X}Result
            `)})},z4=($)=>{$.push(`
    let pathname;
    const start = req.url.indexOf('/', req.url.indexOf(':') + 4);
    let i = start;
    for (; i < req.url.length; i++) {
        const charCode = req.url.charCodeAt(i);
        if (charCode === 37) { // percent-encoded
            const queryIndex = req.url.indexOf('?', i);
            const path = req.url.slice(start, queryIndex === -1 ? undefined : queryIndex);
            pathname = tryDecodeURI(path.includes('%25') ? path.replace(/%25/g, '%2525') : path);
            break;
        } else if (charCode === 63) { // ?
            break;
        }
    }
    if (!pathname) {
      pathname = req.url.slice(start, i);
    }
  `)},C4=($,z)=>{if(z.length<=5)for(let Z=0;Z<z.length;Z++)if(i(z[Z]))$.push(`
          const resultMiddleware${Z} = await globalMiddlewares[${Z}](ctx);
          if (resultMiddleware${Z}) return resultMiddleware${Z};
      `);else $.push(`
        const resultMiddleware${Z} = globalMiddlewares[${Z}](ctx);
        if (resultMiddleware${Z}) return resultMiddleware${Z};
    `);else $.push(`
    for (let i = 0; i < globalMiddlewares.length; i++) {
      const result = await globalMiddlewares[i](ctx);
      if (result) return result;
    }
  `)},t1=($,z)=>{let Z=[],C=z.globalMiddlewares||[],J=$?.hasOnReqHook?z.hooks.onRequest:[],X=$?.hasPreHandlerHook?z.hooks.preHandler:[],Q=$?.hasOnSendHook?z.hooks.onSend:[];if(z4(Z),Z.push(`
      const routeHandler = diesel.trie.search(pathname, req.method);
    `),J&&J.length>0)C1(Z,J,"onRequest","req","pathname","server");if(Z.push(`
          const ctx = new Context(req, server, pathname, routeHandler?.path)
    `),$?.hasMiddleware){if(C.length>0)C4(Z,C);if(z.middlewares.size>0)Z.push(`
      const local = diesel.middlewares.get(pathname)
      if (local && local.length) {
        for (const middleware of local) {
          const result = await middleware(ctx);
          if (result) return result;
        }
      }
        `)}if($.hasFilterEnabled)Z.push(`
        const filterResponse = await runFilter(diesel, pathname, ctx);
        if (filterResponse) return filterResponse;
      `);if(Z.push(`
      if (!routeHandler) return await handleRouteNotFound(diesel, ctx, pathname);
    `),$.hasPreHandlerHook)C1(Z,X,"preHandler","ctx");if(Z.push(`
      const result = routeHandler.handler(ctx);
      const finalResult = result instanceof Promise ? await result : result;
    `),$.hasOnSendHook)C1(Z,Q,"onSend","ctx","finalResult");Z.push(`
      if (finalResult instanceof Response) return finalResult;
      return generateErrorResponse(500, "No response returned from handler.");
    `);let Y=`
      return async function pipeline(req, server, diesel) {
          ${Z.join(`
`)}
      }
    `;return new Function("runFilter","handleRouteNotFound","generateErrorResponse","globalMiddlewares","Context",Y)(h,d,I,C,v)},e1=($,z,Z,C,...J)=>{let X=[],Q;if(typeof J[0]==="string"||typeof J[0]==="object")Q=J[0];let Y=J,B=$?.hasMiddleware?z.globalMiddlewares:[],G=$?.hasMiddleware?z.middlewares.get(C)||[]:[],V=[...B,...G],W=$?.hasOnReqHook?z.hooks.onRequest:[],f=z.filters.has(C),K=z.filterFunction;if(W&&W?.length>0)X.push(`
      const onRequestResult = await runHooks(
        "onRequest",
        onRequestHooks,
        [req, "${C}", server]
      );
      if (onRequestResult) return onRequestResult;
    `);if(V.length)X.push(`
      const globalMiddlewareResponse = await executeBunMiddlewares(
        allMiddlewares,
        req,
        server
      );
      if (globalMiddlewareResponse) return globalMiddlewareResponse;
    `);if($.hasFilterEnabled){if(!f)X.push(`if (${K.length}) {
        for (const filterFunction of filterFunctions) {
          const filterResult = await filterFunction(req, server);
          if (filterResult) return filterResult;
        }
      } else {
        return Response.json({ error: "Protected route, authentication required" }, { status: 401 });
      }`)}if(X.push(`
            if ("${Z}" !== req.method)
        return new Response("Method Not Allowed", { status: 405 });
      `),typeof Q!=="undefined")if(typeof Q==="string")X.push(`
        return new Response(${JSON.stringify(Q)});
      `);else{let w=JSON.stringify(Q);X.push(`
        return new Response(${JSON.stringify(w)}, {
          headers: { "content-type": "application/json; charset=utf-8" }
        });
      `)}else if(Y.length===1){let w=Y[0];if(i(w))X.push(`
        const response = await handlers[0](req, server);
        if (response instanceof Response) return response;
      `);else X.push(`
        const response = handlers[0](req, server);
        if (response instanceof Response) return response;
      `)}else Y.forEach((w,A)=>{if(i(w))X.push(`
            const response${A} = await handlers[${A}](req, server);
            if (response${A} instanceof Response) return response${A};
        `);else X.push(`
            const response${A} = handlers[${A}](req, server);
            if (response${A} instanceof Response) return response${A};
        `)});let N=`
    return async function(req, server) {
      ${X.join(`
`)}
    }
  `;return new Function("executeBunMiddlewares","handlers","runHooks","filterFunctions","onRequestHooks","allMiddlewares",N)(a1,Y,L,K,W,V)};r();var{default:W1}=(()=>({}));var D={reset:"\x1B[0m",info:"\x1B[36m",warn:"\x1B[33m",error:"\x1B[31m",method:{GET:"\x1B[32m",POST:"\x1B[34m",PUT:"\x1B[35m",DELETE:"\x1B[31m",PATCH:"\x1B[36m"}},J1=($,z,Z)=>{let C=D[$]||D.reset,J=Z?.method?D.method[Z.method]||D.reset:D.reset,X=Z?.status?Z.status>=500?D.error:Z.status>=400?D.warn:D.info:D.reset;console.log(`
${C}[${$.toUpperCase()}]${D.reset} ${z} - ${J}${Z?.method||""}${D.reset}`);let Q={timestamp:new Date().toISOString(),...Z,status:Z?.status?`${X}${Z.status}${D.reset}`:void 0,method:Z?.method?`${J>C}${Z.method}${D.reset}`:void 0};console.log(JSON.stringify(Q,null,2)+`
`)},$0=($)=>{let{app:z,logger:Z,logLevel:C="info",onRequest:J,onSend:X,onError:Q}=$||{};z?.addHooks("onRequest",(Y)=>{Y.req.startTime=Date.now(),Z?.()??J1(C,"Incoming Request",{method:Y.req.method,url:Y.pathname,headers:{"user-agent":Y.req.headers.get("user-agent"),"content-type":Y.req.headers.get("content-type")}}),J?.(Y)}),z?.addHooks("onSend",async(Y,B)=>{let G=`${Date.now()-Y.req.startTime}ms`;Z?.()??J1(C,"Response Sent",{method:Y.req.method,url:Y.url.toString(),status:B.status,duration:G,reqId:Y.get?.("requestId"),headers:{"content-type":B.headers.get("content-type")}});let V=await X?.(Y);if(V instanceof Response)return V}),z?.addHooks("onError",async(Y,B)=>{Z?.()??J1("error","Unhandled Error",{method:B.req.method,url:B.pathname,status:500,error:Y.message});let G=await Q?.(Y,B);if(G instanceof Response)return G})},X1=($,z,Z,C=0,J,X)=>{let Q=D.method[z]||D.reset,Y=C>=500?D.error:C>=400?D.warn:D.info,B=X?`[${X}] `:"",G=$==="<--"?`${$} ${Q}${z}${D.reset} ${Z} ${B}`:`${$} ${Q}${z}${D.reset} ${Z} ${Y}${C}${D.reset} ${J??""} ${B}`;console.log(G)},J4=($)=>{let z=Date.now()-$;return z<1000?`${z}ms`:`${Math.round(z/1000)}s`},Z0=($)=>{let{app:z,log:Z,onRequest:C,onSend:J,onError:X}=$;z.addHooks("onRequest",(Q)=>{let{req:Y,pathname:B}=Q;Y.startTime=Date.now(),Z?.()??X1("<--",Y.method,B),C?.(Y,B)}),z.addHooks("onSend",async(Q,Y)=>{let{method:B,url:G}=Q.req,V=new URL(G).pathname,W=Q.get?.("requestId");Z?.()??X1("-->",B,V,Y.status,J4(Q.req.startTime),W);let f=await J?.(Q);if(f instanceof Response)return f}),z.addHooks("onError",async(Q,Y)=>{let{req:B,pathname:G}=Y;Z?.()??X1(Q.message,B.method,G,500);let V=await X?.(Q,B,G);if(V instanceof Response)return V})};function z0($,z){if(!$)throw new Error("JWT library is not defined, please provide jwt to authenticateJwt Function");return(Z)=>{try{let C=Z.cookies?.accessToken??Z.req?.headers?.get("Authorization");if(!C)return Z.json({message:"Unauthorized",error:"No token provided"},401);if(C.startsWith("Bearer "))C=C.slice(7);let J=$?.verify(C,z);if(!J)return Z.json({message:"Unauthorized",error:"Token could not be decoded"},401);Z.set("user",J)}catch(C){let J="Invalid token";if(C.name==="TokenExpiredError")J="Token expired";else if(C.name==="JsonWebTokenError")J="Malformed or tampered token";return Z.json({message:"Unauthorized",error:J},401)}}}function C0($,z,Z){if(!$)throw new Error("JWT library is not defined, please provide jwt to authenticateJwtDB Function");if(!z)throw new Error("User model is not defined, please provide UserModel to authenticateJwtDB Function");return async(C)=>{try{let J=C.cookies?.accessToken??C.req?.headers?.get("Authorization");if(!J)return C.json({message:"Unauthorized",error:"No token provided"},401);if(J.startsWith("Bearer "))J=J.slice(7);let X=$?.verify(J,Z);if(!X)return C.json({message:"Unauthorized",error:"Token could not be decoded"},401);let Q=await z.findById(X._id).select("-password -refreshToken");if(!Q)return C.json({message:"Unauthorized: User not found"},404);C.set("user",Q);return}catch(J){let X="Invalid token";if(J.name==="TokenExpiredError")X="Token expired";else if(J.name==="JsonWebTokenError")X="Malformed or tampered token";return C.json({message:"Unauthorized",error:X},401)}}}var X4=($,z)=>{try{return z($)}catch{return $.replace(/(?:%[0-9A-Fa-f]{2})+/g,(Z)=>{try{return z(Z)}catch{return Z}})}},Q1=($)=>X4($,decodeURI),Y1=($)=>{let z=$.indexOf("/",$.indexOf(":")+4),Z=z;for(;Z<$.length;Z++){let C=$.charCodeAt(Z);if(C===37){let J=$.indexOf("?",Z),X=$.slice(z,J===-1?void 0:J);return Q1(X.includes("%25")?X.replace(/%25/g,"%2525"):X)}else if(C===63)break}return $.slice(z,Z)};var B1=Symbol.for,H=Symbol("kCapture"),Y0=B1("events.errorMonitor"),Q4=Symbol("events.maxEventTargetListeners"),Y4=Symbol("events.maxEventTargetListenersWarned"),J0=B1("nodejs.rejection"),V4=B1("nodejs.rejection"),X0=Array.prototype.slice,M=10,j=function $(z){if(this._events===void 0||this._events===this.__proto__._events)this._events={__proto__:null},this._eventsCount=0;if(this._maxListeners??=void 0,this[H]=z?.captureRejections?Boolean(z?.captureRejections):F[H])this.emit=f4},F=j.prototype={};F._events=void 0;F._eventsCount=0;F._maxListeners=void 0;F.setMaxListeners=function $(z){return G1(z,"setMaxListeners",0),this._maxListeners=z,this};F.constructor=j;F.getMaxListeners=function $(){return this?._maxListeners??M};function V0($,z){var{_events:Z}=$;if(z[0]??=new Error("Unhandled error."),!Z)throw z[0];var C=Z[Y0];if(C)for(var J of X0.call(C))J.apply($,z);var X=Z.error;if(!X)throw z[0];for(var J of X0.call(X))J.apply($,z);return!0}function B4($,z,Z,C){z.then(void 0,function(J){queueMicrotask(()=>G4($,J,Z,C))})}function G4($,z,Z,C){if(typeof $[J0]==="function")$[J0](z,Z,...C);else try{$[H]=!1,$.emit("error",z)}finally{$[H]=!0}}var W4=function $(z,...Z){if(z==="error")return V0(this,Z);var{_events:C}=this;if(C===void 0)return!1;var J=C[z];if(J===void 0)return!1;let X=J.length>1?J.slice():J;for(let Q=0,{length:Y}=X;Q<Y;Q++){let B=X[Q];switch(Z.length){case 0:B.call(this);break;case 1:B.call(this,Z[0]);break;case 2:B.call(this,Z[0],Z[1]);break;case 3:B.call(this,Z[0],Z[1],Z[2]);break;default:B.apply(this,Z);break}}return!0},f4=function $(z,...Z){if(z==="error")return V0(this,Z);var{_events:C}=this;if(C===void 0)return!1;var J=C[z];if(J===void 0)return!1;let X=J.length>1?J.slice():J;for(let Q=0,{length:Y}=X;Q<Y;Q++){let B=X[Q],G;switch(Z.length){case 0:G=B.call(this);break;case 1:G=B.call(this,Z[0]);break;case 2:G=B.call(this,Z[0],Z[1]);break;case 3:G=B.call(this,Z[0],Z[1],Z[2]);break;default:G=B.apply(this,Z);break}if(G!==void 0&&typeof G?.then==="function"&&G.then===Promise.prototype.then)B4(this,G,z,Z)}return!0};F.emit=W4;F.addListener=function $(z,Z){g(Z);var C=this._events;if(!C)C=this._events={__proto__:null},this._eventsCount=0;else if(C.newListener)this.emit("newListener",z,Z.listener??Z);var J=C[z];if(!J)C[z]=[Z],this._eventsCount++;else{J.push(Z);var X=this._maxListeners??M;if(X>0&&J.length>X&&!J.warned)B0(this,z,J)}return this};F.on=F.addListener;F.prependListener=function $(z,Z){g(Z);var C=this._events;if(!C)C=this._events={__proto__:null},this._eventsCount=0;else if(C.newListener)this.emit("newListener",z,Z.listener??Z);var J=C[z];if(!J)C[z]=[Z],this._eventsCount++;else{J.unshift(Z);var X=this._maxListeners??M;if(X>0&&J.length>X&&!J.warned)B0(this,z,J)}return this};function B0($,z,Z){Z.warned=!0;let C=new Error(`Possible EventEmitter memory leak detected. ${Z.length} ${String(z)} listeners added to [${$.constructor.name}]. Use emitter.setMaxListeners() to increase limit`);C.name="MaxListenersExceededWarning",C.emitter=$,C.type=z,C.count=Z.length,console.warn(C)}function G0($,z,...Z){this.removeListener($,z),z.apply(this,Z)}F.once=function $(z,Z){g(Z);let C=G0.bind(this,z,Z);return C.listener=Z,this.addListener(z,C),this};F.prependOnceListener=function $(z,Z){g(Z);let C=G0.bind(this,z,Z);return C.listener=Z,this.prependListener(z,C),this};F.removeListener=function $(z,Z){g(Z);var{_events:C}=this;if(!C)return this;var J=C[z];if(!J)return this;var X=J.length;let Q=-1;for(let Y=X-1;Y>=0;Y--)if(J[Y]===Z||J[Y].listener===Z){Q=Y;break}if(Q<0)return this;if(Q===0)J.shift();else J.splice(Q,1);if(J.length===0)delete C[z],this._eventsCount--;return this};F.off=F.removeListener;F.removeAllListeners=function $(z){var{_events:Z}=this;if(z&&Z){if(Z[z])delete Z[z],this._eventsCount--}else this._events={__proto__:null};return this};F.listeners=function $(z){var{_events:Z}=this;if(!Z)return[];var C=Z[z];if(!C)return[];return C.map((J)=>J.listener??J)};F.rawListeners=function $(z){var{_events:Z}=this;if(!Z)return[];var C=Z[z];if(!C)return[];return C.slice()};F.listenerCount=function $(z){var{_events:Z}=this;if(!Z)return 0;return Z[z]?.length??0};F.eventNames=function $(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};F[H]=!1;function K4($,z,Z){var C=Z?.signal;if(W0(C,"options.signal"),C?.aborted)throw new V1(void 0,{cause:C?.reason});let{resolve:J,reject:X,promise:Q}=$newPromiseCapability(Promise),Y=(V)=>{if($.removeListener(z,B),C!=null)l(C,"abort",G);X(V)},B=(...V)=>{if(typeof $.removeListener==="function")$.removeListener("error",Y);if(C!=null)l(C,"abort",G);J(V)};if(Q0($,z,B,{once:!0}),z!=="error"&&typeof $.once==="function")$.once("error",Y);function G(){l($,z,B),l($,"error",Y),X(new V1(void 0,{cause:C?.reason}))}if(C!=null)Q0(C,"abort",G,{once:!0});return Q}function F4($,z){return $.listeners(z)}function U4($,...z){G1($,"setMaxListeners",0);var Z;if(z&&(Z=z.length))for(let C=0;C<Z;C++)z[C].setMaxListeners($);else M=$}function D4($,z){return $.listenerCount(z)}function l($,z,Z,C){if(typeof $.removeListener==="function")$.removeListener(z,Z);else $.removeEventListener(z,Z,C)}function Q0($,z,Z,C){if(typeof $.on==="function")if(C.once)$.once(z,Z);else $.on(z,Z);else $.addEventListener(z,Z,C)}class V1 extends Error{constructor($="The operation was aborted",z=void 0){if(z!==void 0&&typeof z!=="object")throw R("options","Object",z);super($,z);this.code="ABORT_ERR",this.name="AbortError"}}function R($,z,Z){let C=new TypeError(`The "${$}" argument must be of type ${z}. Received ${Z}`);return C.code="ERR_INVALID_ARG_TYPE",C}function N4($,z,Z){let C=new RangeError(`The "${$}" argument is out of range. It must be ${z}. Received ${Z}`);return C.code="ERR_OUT_OF_RANGE",C}function W0($,z){if($!==void 0&&($===null||typeof $!=="object"||!("aborted"in $)))throw R(z,"AbortSignal",$)}function G1($,z,Z,C){if(typeof $!=="number")throw R(z,"number",$);if(Z!=null&&$<Z||C!=null&&$>C||(Z!=null||C!=null)&&Number.isNaN($))throw N4(z,`${Z!=null?`>= ${Z}`:""}${Z!=null&&C!=null?" && ":""}${C!=null?`<= ${C}`:""}`,$)}function g($){if(typeof $!=="function")throw new TypeError("The listener must be a function")}function q4($,z){if(typeof $!=="boolean")throw R(z,"boolean",$)}function A4($){return $?._maxListeners??M}function S4($,z){if($===void 0)throw R("signal","AbortSignal",$);if(W0($,"signal"),typeof z!=="function")throw R("listener","function",z);let Z;if($.aborted)queueMicrotask(()=>z());else $.addEventListener("abort",z,{__proto__:null,once:!0}),Z=()=>{$.removeEventListener("abort",z)};return{__proto__:null,[Symbol.dispose](){Z?.()}}}Object.defineProperties(j,{captureRejections:{get(){return F[H]},set($){q4($,"EventEmitter.captureRejections"),F[H]=$},enumerable:!0},defaultMaxListeners:{enumerable:!0,get:()=>{return M},set:($)=>{G1($,"defaultMaxListeners",0),M=$}},kMaxEventTargetListeners:{value:Q4,enumerable:!1,configurable:!1,writable:!1},kMaxEventTargetListenersWarned:{value:Y4,enumerable:!1,configurable:!1,writable:!1}});Object.assign(j,{once:K4,getEventListeners:F4,getMaxListeners:A4,setMaxListeners:U4,EventEmitter:j,usingDomains:!1,captureRejectionSymbol:V4,errorMonitor:Y0,addAbortListener:S4,init:j,listenerCount:D4});class x{static instance;fecth;routes;tempRoutes;globalMiddlewares;middlewares;trie;hasOnReqHook;hasMiddleware;hasPreHandlerHook;hasPostHandlerHook;hasOnSendHook;hasOnError;hooks;corsConfig;FilterRoutes;filters;filterFunction;hasFilterEnabled;serverInstance;staticFiles;user_jwt_secret;baseApiUrl;enableFileRouter;idleTimeOut;routeNotFoundFunc;prefixApiUrl;compileConfig;#$=!1;emitter;errorFormat;staticPath;staticRequestPath=void 0;constructor({jwtSecret:$,baseApiUrl:z,enableFileRouting:Z,idleTimeOut:C,prefixApiUrl:J,onError:X,logger:Q,pipelineArchitecture:Y,errorFormat:B="json"}={}){if(this.errorFormat=B,!x.instance)x.instance=this;if(Y)this.#$=!0;if(this.errorFormat=B,this.emitter=new j,this.prefixApiUrl=J??"",this.fetch=this.fetch.bind(this),this.routes={},this.idleTimeOut=C??10,this.enableFileRouter=Z??!1,this.baseApiUrl=z||"",this.user_jwt_secret=$||process.env.DIESEL_JWT_SECRET||"feault_diesel_secret_for_jwt",this.tempRoutes=new Map,this.globalMiddlewares=[],this.middlewares=new Map,this.trie=new y,this.corsConfig=null,this.hasMiddleware=!1,this.hasOnReqHook=!1,this.hasPreHandlerHook=!1,this.hasPostHandlerHook=!1,this.hasOnSendHook=!1,this.hasOnError=!1,this.hooks={onRequest:[],preHandler:[],postHandler:[],onSend:[],onError:[],onClose:[]},X)this.addHooks("onError",(G,V)=>{console.log("Got an exception:",G),console.log("Request Path:",V.pathname)});if(Q)this.useLogger({app:this,onError(G){console.error("Got an exception:",G)}});this.FilterRoutes=[],this.filters=new Set,this.filterFunction=[],this.hasFilterEnabled=!1,this.serverInstance=null,this.staticPath=null,this.staticFiles={},this.routeNotFoundFunc=()=>{},this.compileConfig=null}static router($){if(!this.instance)this.instance=new x;return new Proxy(this.instance,{get(z,Z,C){return(J,X)=>{let Q=$+J;return z[Z](Q,X)}}})}setupFilter(){return this.hasFilterEnabled=!0,{publicRoutes:(...$)=>{return this.FilterRoutes=$,this.setupFilter()},permitAll:()=>{for(let $ of this?.FilterRoutes){if($.endsWith("/"))$=$.slice(0,-1);this.filters.add($)}return this.FilterRoutes=null,this.setupFilter()},authenticate:($)=>{if($?.length)for(let z of $)this.filterFunction.push(z)},authenticateJwt:($)=>{this.filterFunction.push(z0($,this.user_jwt_secret))},authenticateJwtDB:($,z)=>{this.filterFunction.push(C0($,z,this.user_jwt_secret))}}}redirect($,z,Z){return this.any($,(C)=>{let J=C.params,X=z;if(J)for(let Y in J)X=X.replace(`:${Y}`,J[Y]);let Q=C.url.search;if(Q)X+=Q;return C.redirect(X,Z)}),this}serveStatic($,z){return this.staticPath=$,this.staticRequestPath=z,this}static($,z){return this.staticPath=$,this.staticRequestPath=z,this}staticHtml($){return this.staticFiles={...this.staticFiles,...$},this}addHooks($,z){if(typeof $!=="string")throw new Error("hookName must be a string");if(typeof z!=="function")throw new Error("callback must be a instance of function");switch($){case"onRequest":this.hooks.onRequest?.push(z);break;case"preHandler":this.hooks.preHandler?.push(z);break;case"postHandler":this.hooks.postHandler?.push(z);break;case"onSend":this.hooks.onSend?.push(z);break;case"onError":this.hooks.onError?.push(z);break;case"onClose":this.hooks.onClose?.push(z);break;default:throw new Error(`Unknown hook type: ${$}`)}return this}compile(){let $={hasMiddleware:!1,hasOnReqHook:!1,hasPreHandlerHook:!1,hasOnError:!1,hasPostHandlerHook:!1,hasOnSendHook:!1,hasFilterEnabled:!1};if(this.hasFilterEnabled)$.hasFilterEnabled=!0,this.hasFilterEnabled=!0;if(this?.globalMiddlewares?.length>0)$.hasMiddleware=!0,this.hasMiddleware=!0;for(let[z,Z]of this?.middlewares?.entries())if(Z.length>0){$.hasMiddleware=!0,this.hasMiddleware=!0;break}if(this?.enableFileRouter){let z=process.cwd(),Z=O.join(z,"src","routes");if(W1?.existsSync(Z))this.loadRoutes(Z,"")}if(this?.hooks?.onRequest&&this.hooks.onRequest.length>0)$.hasOnReqHook=!0,this.hasOnReqHook=!0;if(this?.hooks?.preHandler&&this.hooks.preHandler.length>0)$.hasPreHandlerHook=!0,this.hasPreHandlerHook=!0;if(this?.hooks?.postHandler&&this.hooks.postHandler?.length>0)$.hasPostHandlerHook=!0,this.hasPostHandlerHook=!0;if(this?.hooks?.onSend&&this.hooks.onSend?.length>0)$.hasOnSendHook=!0,this.hasOnSendHook=!0;if(this?.hooks?.onError&&this.hooks.onError?.length>0)$.hasOnError=!0,this.hasOnError=!0;return this.tempRoutes=null,this.compileConfig=$,$}async registerFileRoutes($,z,Z){let C=await import($),J;if(Z===".ts")J=O.basename($,".ts");else if(Z===".js")J=O.basename($,".js");let X=z+"/"+J;if(X.endsWith("/index"))X=z;else if(X.endsWith("/api"))X=z;X=X.replace(/\[(.*?)\]/g,":$1");let Q=["GET","POST","PUT","PATCH","DELETE","ANY","HEAD","OPTIONS","PROPFIND"];for(let Y of Q)if(C[Y]){let B=Y.toLowerCase(),G=C[Y];this[B](`${this.baseApiUrl}${X}`,G)}}async loadRoutes($,z){let Z=await W1.promises.readdir($);for(let C of Z){let J=O.join($,C);if((await W1.promises.stat(J)).isDirectory())await this.loadRoutes(J,z+"/"+C);else if(C.endsWith(".ts"))await this.registerFileRoutes(J,z,".ts");else if(C.endsWith(".js"))await this.registerFileRoutes(J,z,".js")}}useLogger($){return Z0($),this}useAdvancedLogger($){return $0($),this}BunRoute($,z,...Z){if(!z||typeof z!=="string")throw new Error("give a path in string format");if(!this.compileConfig)this.compile();let C;if(typeof Z[0]==="string"||typeof Z[0]==="object")C=Z[0];if(typeof C!=="undefined"){let X=typeof C==="string"?C:JSON.stringify(C)}let J=e1(this.compileConfig,this,$.toUpperCase(),z,...Z);return this.routes[z]=J,this}listen($,...z){if(typeof Bun==="undefined")throw new Error(".listen() is designed to run on Bun only...");let Z="0.0.0.0",C=void 0,J={};for(let Q of z)if(typeof Q==="string")Z=Q;else if(typeof Q==="function")C=Q;else if(typeof Q==="object"&&Q!==null)J=Q;let X={port:$,hostname:Z,idleTimeOut:this.idleTimeOut,fetch:this.fetch(),static:this.staticFiles};if(this.routes&&Object.keys(this.routes).length>0)X.routes=this.routes;if(J.cert&&J.key)X.certFile=J.cert,X.keyFile=J.key;if(this.serverInstance=Bun?.serve(X),C)C();return this.serverInstance}close($){if(this.serverInstance)this.serverInstance.stop(!0),this.serverInstance=null,$?$():console.log("Server has been stopped");else console.warn("Server is not running.")}fetch(){let $=this.compile();if(this.#$){let z=t1($,this);return(Z,C)=>{return z(Z,C,this).catch(async(J)=>{return console.error("Unhandled handler error:",J),await L("onError",this.hooks.onError,[J,Z,Y1(Z.url),C])||I(500,"Internal Server Error")})}}return this.handleRequests.bind(this)}async handleRequests($,z){let Z,C=$.url.indexOf("/",$.url.indexOf(":")+4),J=C;for(;J<$.url.length;J++){let Y=$.url.charCodeAt(J);if(Y===37){let B=$.url.indexOf("?",J),G=$.url.slice(C,B===-1?void 0:B);Z=Q1(G.includes("%25")?G.replace(/%25/g,"%2525"):G);break}else if(Y===63)break}if(!Z)Z=$.url.slice(C,J);let X=this.trie.search(Z,$.method),Q=new v($,z,Z,X?.path);try{if(this.hasOnReqHook)await L("onRequest",this.hooks.onRequest,[Q]);if(this.hasMiddleware){let G=await r1(this,Z,Q);if(G)return G}if(this.hasFilterEnabled){let G=await h(this,Z,Q);if(G)return G}if(!X)return await d(this,Q,Z);if(this.hasPreHandlerHook){let G=await L("preHandler",this.hooks.preHandler,[Q]);if(G)return G}let Y=X.handler(Q),B=Y instanceof Promise?await Y:Y;if(this.hasOnSendHook){let G=await L("onSend",this.hooks.onSend,[Q,B]);if(G)return G}if(B instanceof Response)return B}catch(Y){return this.handleError(Y,Q)}return I(500,"No response returned from handler.")}async handleError($,z){let C=this.errorFormat,J=Y1(z.req.url),X=await L("onError",this.hooks.onError,[$,z]);if(X)return X;if($&&typeof $==="object"&&$.name==="HTTPException"){let B=$;if(B.res)return B.res;return C==="json"?Response.json({error:B.message},{status:B.status}):new Response(B.message,{status:B.status})}let Q=$ instanceof Error?$.message:"Internal Server Error",Y=$ instanceof Error?$.stack:void 0;if(C==="json"){let B={error:Q,...!1,path:J};return Response.json(B,{status:500,headers:{"Content-Type":"application/json"}})}else{let B=`Error: ${Q}`;return new Response(B,{headers:{"Content-Type":"text/plain"},status:500})}}route($,z){$=$&&$.length>0?$:z?.prefixApiUrl;let Z=z?.tempRoutes??new Map;for(let[C,J]of Z.entries()){let X=C.replace(/::\w+$/,""),Q=`${$}${X}`;if(!this.middlewares.has(Q))this.middlewares.set(Q,[]);J.handlers.slice(0,-1).forEach((V)=>{let W=this.middlewares.get(Q);if(!W.includes(V))W.push(V)});let B=J.handlers[J.handlers.length-1],G=J.method;try{this.trie.insert(Q,{handler:B,method:G})}catch(V){console.error(`Error inserting ${Q}:`,V)}}return z=null,this}register($,z){return this.route($,z)}addRoute($,z,Z){if(typeof z!=="string")throw new Error(`Error in ${Z[Z.length-1]}: Path must be a string. Received: ${typeof z}`);if(typeof $!=="string")throw new Error(`Error in addRoute: Method must be a string. Received: ${typeof $}`);this.tempRoutes?.set(z+"::"+$,{method:$,handlers:Z});let C=Z.slice(0,-1),J=Z[Z.length-1];if(C.length>0){if(!this.middlewares.has(z))this.middlewares.set(z,[]);C.forEach((X)=>{if(z==="/")this.globalMiddlewares=[...new Set([...this.globalMiddlewares,...C])];else if(!this.middlewares.get(z)?.includes(X))this.middlewares.get(z)?.push(X)})}try{if($==="ANY"){let X=["GET","POST","PUT","DELETE","PATCH","OPTIONS","HEAD","PROPFIND"];for(let Q of X)this.trie.insert(z,{handler:J,method:Q})}this.trie.insert(z,{handler:J,method:$})}catch(X){console.error(`Error inserting ${z}:`,X)}}use($,z){if(Array.isArray($))$.forEach((C)=>{if(typeof C==="function")this.globalMiddlewares.push(C)});if(typeof $==="function"){if(this.globalMiddlewares.push($),Array.isArray(z))z.forEach((C)=>{this.globalMiddlewares.push(C)});return this}return(Array.isArray($)?$.filter((C)=>typeof C==="string"):[$].filter((C)=>typeof C==="string")).forEach((C)=>{if(!this.middlewares.has(C))this.middlewares.set(C,[]);if(z)(Array.isArray(z)?z:[z]).forEach((X)=>{this.middlewares.get(C)?.push(X)})}),this}get($,...z){return this.addRoute("GET",$,z),this}post($,...z){return this.addRoute("POST",$,z),this}put($,...z){return this.addRoute("PUT",$,z),this}patch($,...z){return this.addRoute("PATCH",$,z),this}delete($,...z){return this.addRoute("DELETE",$,z),this}any($,...z){return this.addRoute("ANY",$,z),this}head($,...z){return this.addRoute("HEAD",$,z),this}options($,...z){return this.addRoute("OPTIONS",$,z),this}propfind($,...z){return this.addRoute("PROPFIND",$,z),this}routeNotFound($){return this.routeNotFoundFunc=$,this}on($,z){this.emitter.on($,z)}emit($,...z){this.emitter.emit($,...z)}}export{x as default};
