var k=Object.create;var{getPrototypeOf:i,defineProperty:b,getOwnPropertyNames:u}=Object;var x=Object.prototype.hasOwnProperty;var o=(g,f,L)=>{L=g!=null?k(i(g)):{};let $=f||!g||!g.__esModule?b(L,"default",{value:g,enumerable:!0}):L;for(let A of u(g))if(!x.call($,A))b($,A,{get:()=>g[A],enumerable:!0});return $};var l=((g)=>typeof require!=="undefined"?require:typeof Proxy!=="undefined"?new Proxy(g,{get:(f,L)=>(typeof require!=="undefined"?require:f)[L]}):g)(function(g){if(typeof require!=="undefined")return require.apply(this,arguments);throw Error('Dynamic require of "'+g+'" is not supported')});class I{children;isEndOfWord;handler;isDynamic;pattern;path;method;constructor(){this.children={},this.isEndOfWord=!1,this.handler=[],this.isDynamic=!1,this.pattern="",this.path="",this.method=[]}}class V{root;constructor(){this.root=new I}insert(g,f){let L=this.root,$=g.split("/").filter(Boolean);if(g==="/"){L.isEndOfWord=!0,L.handler.push(f.handler),L.path=g,L.method.push(f.method);return}for(let A of $){let C=!1,E=A;if(A.startsWith(":"))C=!0,E=":";if(!L.children[E])L.children[E]=new I;L=L.children[E],L.isDynamic=C,L.pattern=A}L.isEndOfWord=!0,L.path=g,L.method.push(f.method),L.handler.push(f.handler)}search(g,f){let L=this.root,$=g.split("/").filter(Boolean),A=$.length;for(let D of $){let n=D;if(!L.children[n])if(L.children[":"])L=L.children[":"];else return null;else L=L.children[n]}let C=L.path.split("/").filter(Boolean);if(A!==C.length)return null;let E=L.method.indexOf(f);if(E!==-1)return{path:L.path,handler:L.handler[E],isDynamic:L.isDynamic,pattern:L.pattern,method:L.method[E]};return null}}function W(g){switch(g.split(".").pop()?.toLowerCase()){case"js":return"application/javascript";case"css":return"text/css";case"html":return"text/html";case"json":return"application/json";case"png":return"image/png";case"jpg":case"jpeg":return"image/jpeg";case"svg":return"image/svg+xml";case"gif":return"image/gif";case"woff":return"font/woff";case"woff2":return"font/woff2";default:return"application/octet-stream"}}function Q(g,f,L){let $=null,A=null,C=null,E=null,D={},n=new Map([["string","text/plain; charset=utf-8"],["object","application/json; charset=utf-8"],["Uint8Array","application/octet-stream"],["ArrayBuffer","application/octet-stream"]]);return{req:g,server:f,url:L,status:200,headers:new Headers({"Cache-Control":"no-cache"}),setHeader(U,G){return this.headers.set(U,G),this},removeHeader(U){return this.headers.delete(U),this},get ip(){return this.server.requestIP(this.req)?.address??null},get query(){if(!$)try{$=Object.fromEntries(this.url.searchParams)}catch(U){throw new Error("Failed to parse query parameters")}return $},get params(){if(!A&&this.req.routePattern)try{A=r(this.req.routePattern,this.url.pathname)}catch(U){throw new Error("Failed to extract route parameters")}return A??{}},get body(){if(this.req.method==="GET")return Promise.resolve({});if(!E)E=(async()=>{let U=await p(this.req);if(U.error)throw new Error(U.error);return Object.keys(U).length===0?null:U})();return E},set(U,G){return D[U]=G,this},get(U){return D[U]},text(U,G){if(G)this.status=G;if(!this.headers.has("Content-Type"))this.headers.set("Content-Type","text/plain; charset=utf-8");return new Response(U,{status:this.status,headers:this.headers})},send(U,G){if(G)this.status=G;let S;if(U instanceof Uint8Array)S="Uint8Array";else if(U instanceof ArrayBuffer)S="ArrayBuffer";else S=typeof U;if(!this.headers.has("Content-Type"))this.headers.set("Content-Type",n.get(S)??"text/plain; charset=utf-8");let v=S==="object"&&U!==null?JSON.stringify(U):U;return new Response(v,{status:this.status,headers:this.headers})},json(U,G){if(G)this.status=G;if(!this.headers.has("Content-Type"))this.headers.set("Content-Type","application/json; charset=utf-8");return Response.json(U,{status:this.status,headers:this.headers})},file(U,G,S){if(S)this.status=S;let v=Bun.file(U);if(!this.headers.has("Content-Type"))this.headers.set("Content-Type",G??W(U));return new Response(v,{status:this.status,headers:this.headers})},async ejs(U,G={},S){if(S)this.status=S;let v;try{v=await import("ejs"),v=v.default||v}catch(X){return console.error("EJS not installed! Please run `bun add ejs`"),new Response("EJS not installed! Please run `bun add ejs`",{status:500})}try{let X=await Bun.file(U).text(),P=v.render(X,G),c=new Headers({"Content-Type":"text/html; charset=utf-8"});return new Response(P,{status:this.status,headers:c})}catch(X){return console.error("EJS Rendering Error:",X),new Response("Error rendering template",{status:500})}},redirect(U,G){if(G)this.status=G;else this.status=302;return this.headers.set("Location",U),new Response(null,{status:this.status,headers:this.headers})},stream(U){let G=new Headers(this.headers),S=new ReadableStream({async start(v){await U(v),v.close()}});return new Response(S,{headers:G})},yieldStream(U){return new Response({async*[Symbol.asyncIterator](){yield*U()}},{headers:this.headers})},setCookie(U,G,S={}){let v=`${encodeURIComponent(U)}=${encodeURIComponent(G)}`;if(S.maxAge)v+=`; Max-Age=${S.maxAge}`;if(S.expires)v+=`; Expires=${S.expires.toUTCString()}`;if(S.path)v+=`; Path=${S.path}`;if(S.domain)v+=`; Domain=${S.domain}`;if(S.secure)v+="; Secure";if(S.httpOnly)v+="; HttpOnly";if(S.sameSite)v+=`; SameSite=${S.sameSite}`;return this.headers.append("Set-Cookie",v),this},get cookies(){if(!C){let U=this.req.headers.get("cookie");C=U?s(U):{}}return C}}}function s(g){return Object.fromEntries(g.split(";").map((f)=>{let[L,...$]=f.trim().split("=");return[L,decodeURIComponent($.join("="))]}))}function r(g,f){let L={},$=g.split("/"),[A]=f.split("?"),C=A.split("/");if($.length!==C.length)return null;for(let E=0;E<$.length;E++)if($[E].startsWith(":"))L[$[E].slice(1)]=C[E];return L}async function p(g){let f=g.headers.get("Content-Type");if(!f)return{};if(g.headers.get("Content-Length")==="0"||!g.body)return{};try{if(f.startsWith("application/json"))return await g.json();if(f.startsWith("application/x-www-form-urlencoded")){let $=await g.text();return Object.fromEntries(new URLSearchParams($))}if(f.startsWith("multipart/form-data")){let $=await g.formData(),A={};for(let[C,E]of $.entries())A[C]=E;return A}return{error:"Unknown request body type"}}catch($){return{error:"Invalid request body format"}}}async function _(g,f,L,$){let A=Q(g,f,L),C=$.trie.search(L.pathname,g.method);g.routePattern=C?.path;try{if($.hooks.onRequest)await J("onRequest",$.hooks.onRequest,[g,L,f]);if($.hasMiddleware){let n=await h($,L.pathname,A,f);if(n)return n}if($.hasFilterEnabled){let n=g.routePattern??L.pathname,U=await d($,n,A,f);if(U)return U}if(!C)return await a($,A,L.pathname);if($.hooks.preHandler){let n=await J("preHandler",$.hooks.preHandler,[A,f]);if(n)return n}let E=C.handler(A),D=E instanceof Promise?await E:E;if($.hasOnSendHook){let n=await J("onSend",$.hooks.onSend,[A,D,f]);if(n)return n}if(D instanceof Response)return D;return F(500,"No response returned from handler.")}catch(E){return await J("onError",$.hooks.onError,[E,g,L,f])||F(500,"Internal Server Error")}}async function J(g,f,L){if(!f?.length)return;for(let $=0;$<f.length;$++){let A=f[$](...L),C=A instanceof Promise?await A:A;if(C&&g!=="onRequest")return C}}async function h(g,f,L,$){if(g.globalMiddlewares.length){let C=await j(g.globalMiddlewares,L,$);if(C)return C}let A=g.middlewares.get(f)||[];if(A.length){let C=await j(A,L,$);if(C)return C}return null}async function j(g,f,L){for(let $ of g){let A=await $(f,L);if(A)return A}return null}async function Z(g,f,L){for(let $ of g){let A=await $(f,L);if(A)return A}}async function d(g,f,L,$){let A=await t(g,f,L,$),C=A instanceof Promise?await A:A;if(C)return C}async function t(g,f,L,$){if(f.endsWith("/"))f=f.slice(0,-1);if(!g.filters.has(f))if(g.filterFunction.length)for(let A of g.filterFunction){let C=await A(L,$);if(C)return C}else return Response.json({error:"Protected route, authentication required"},{status:401})}async function I1(g,f,L,$){if(!g.filters.has(f))if(g.filterFunction.length)for(let A of g.filterFunction){let C=await A(L,$);if(C)return C}else return Response.json({error:"Protected route, authentication required"},{status:401})}async function a(g,f,L){if(g.staticPath){let A=await e(g,L,f);if(A)return A;let C=g.trie.search("*",f.req.method);if(C?.handler)return await C.handler(f)}return g.routeNotFoundFunc(f)||F(404,`Route not found for ${L}`)}function F(g,f){return new Response(JSON.stringify({error:f}),{status:g,headers:{"Content-Type":"application/json"}})}async function e(g,f,L){if(!g.staticPath)return null;let $=`${g.staticPath}${f}`;if(await Bun.file($).exists()){let C=W($);return L.file($,C,200)}return null}function Y(g){if(typeof g!=="string")throw new TypeError("Path must be a string. Received "+JSON.stringify(g))}function H(g,f){var L="",$=0,A=-1,C=0,E;for(var D=0;D<=g.length;++D){if(D<g.length)E=g.charCodeAt(D);else if(E===47)break;else E=47;if(E===47){if(A===D-1||C===1);else if(A!==D-1&&C===2){if(L.length<2||$!==2||L.charCodeAt(L.length-1)!==46||L.charCodeAt(L.length-2)!==46){if(L.length>2){var n=L.lastIndexOf("/");if(n!==L.length-1){if(n===-1)L="",$=0;else L=L.slice(0,n),$=L.length-1-L.lastIndexOf("/");A=D,C=0;continue}}else if(L.length===2||L.length===1){L="",$=0,A=D,C=0;continue}}if(f){if(L.length>0)L+="/..";else L="..";$=2}}else{if(L.length>0)L+="/"+g.slice(A+1,D);else L=g.slice(A+1,D);$=D-A-1}A=D,C=0}else if(E===46&&C!==-1)++C;else C=-1}return L}function g1(g,f){var L=f.dir||f.root,$=f.base||(f.name||"")+(f.ext||"");if(!L)return $;if(L===f.root)return L+$;return L+g+$}function B(){var g="",f=!1,L;for(var $=arguments.length-1;$>=-1&&!f;$--){var A;if($>=0)A=arguments[$];else{if(L===void 0)L=process.cwd();A=L}if(Y(A),A.length===0)continue;g=A+"/"+g,f=A.charCodeAt(0)===47}if(g=H(g,!f),f)if(g.length>0)return"/"+g;else return"/";else if(g.length>0)return g;else return"."}function R(g){if(Y(g),g.length===0)return".";var f=g.charCodeAt(0)===47,L=g.charCodeAt(g.length-1)===47;if(g=H(g,!f),g.length===0&&!f)g=".";if(g.length>0&&L)g+="/";if(f)return"/"+g;return g}function f1(g){return Y(g),g.length>0&&g.charCodeAt(0)===47}function L1(){if(arguments.length===0)return".";var g;for(var f=0;f<arguments.length;++f){var L=arguments[f];if(Y(L),L.length>0)if(g===void 0)g=L;else g+="/"+L}if(g===void 0)return".";return R(g)}function $1(g,f){if(Y(g),Y(f),g===f)return"";if(g=B(g),f=B(f),g===f)return"";var L=1;for(;L<g.length;++L)if(g.charCodeAt(L)!==47)break;var $=g.length,A=$-L,C=1;for(;C<f.length;++C)if(f.charCodeAt(C)!==47)break;var E=f.length,D=E-C,n=A<D?A:D,U=-1,G=0;for(;G<=n;++G){if(G===n){if(D>n){if(f.charCodeAt(C+G)===47)return f.slice(C+G+1);else if(G===0)return f.slice(C+G)}else if(A>n){if(g.charCodeAt(L+G)===47)U=G;else if(G===0)U=0}break}var S=g.charCodeAt(L+G),v=f.charCodeAt(C+G);if(S!==v)break;else if(S===47)U=G}var X="";for(G=L+U+1;G<=$;++G)if(G===$||g.charCodeAt(G)===47)if(X.length===0)X+="..";else X+="/..";if(X.length>0)return X+f.slice(C+U);else{if(C+=U,f.charCodeAt(C)===47)++C;return f.slice(C)}}function C1(g){return g}function A1(g){if(Y(g),g.length===0)return".";var f=g.charCodeAt(0),L=f===47,$=-1,A=!0;for(var C=g.length-1;C>=1;--C)if(f=g.charCodeAt(C),f===47){if(!A){$=C;break}}else A=!1;if($===-1)return L?"/":".";if(L&&$===1)return"//";return g.slice(0,$)}function E1(g,f){if(f!==void 0&&typeof f!=="string")throw new TypeError('"ext" argument must be a string');Y(g);var L=0,$=-1,A=!0,C;if(f!==void 0&&f.length>0&&f.length<=g.length){if(f.length===g.length&&f===g)return"";var E=f.length-1,D=-1;for(C=g.length-1;C>=0;--C){var n=g.charCodeAt(C);if(n===47){if(!A){L=C+1;break}}else{if(D===-1)A=!1,D=C+1;if(E>=0)if(n===f.charCodeAt(E)){if(--E===-1)$=C}else E=-1,$=D}}if(L===$)$=D;else if($===-1)$=g.length;return g.slice(L,$)}else{for(C=g.length-1;C>=0;--C)if(g.charCodeAt(C)===47){if(!A){L=C+1;break}}else if($===-1)A=!1,$=C+1;if($===-1)return"";return g.slice(L,$)}}function D1(g){Y(g);var f=-1,L=0,$=-1,A=!0,C=0;for(var E=g.length-1;E>=0;--E){var D=g.charCodeAt(E);if(D===47){if(!A){L=E+1;break}continue}if($===-1)A=!1,$=E+1;if(D===46){if(f===-1)f=E;else if(C!==1)C=1}else if(f!==-1)C=-1}if(f===-1||$===-1||C===0||C===1&&f===$-1&&f===L+1)return"";return g.slice(f,$)}function U1(g){if(g===null||typeof g!=="object")throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof g);return g1("/",g)}function n1(g){Y(g);var f={root:"",dir:"",base:"",ext:"",name:""};if(g.length===0)return f;var L=g.charCodeAt(0),$=L===47,A;if($)f.root="/",A=1;else A=0;var C=-1,E=0,D=-1,n=!0,U=g.length-1,G=0;for(;U>=A;--U){if(L=g.charCodeAt(U),L===47){if(!n){E=U+1;break}continue}if(D===-1)n=!1,D=U+1;if(L===46){if(C===-1)C=U;else if(G!==1)G=1}else if(C!==-1)G=-1}if(C===-1||D===-1||G===0||G===1&&C===D-1&&C===E+1){if(D!==-1)if(E===0&&$)f.base=f.name=g.slice(1,D);else f.base=f.name=g.slice(E,D)}else{if(E===0&&$)f.name=g.slice(1,C),f.base=g.slice(1,D);else f.name=g.slice(E,C),f.base=g.slice(E,D);f.ext=g.slice(C,D)}if(E>0)f.dir=g.slice(0,E-1);else if($)f.dir="/";return f}var G1="/",S1=":",v1=((g)=>(g.posix=g,g))({resolve:B,normalize:R,isAbsolute:f1,join:L1,relative:$1,_makeLong:C1,dirname:A1,basename:E1,extname:D1,format:U1,parse:n1,sep:G1,delimiter:S1,win32:null,posix:null}),z=v1;var{default:O}=(()=>({}));var K={reset:"\x1B[0m",info:"\x1B[36m",warn:"\x1B[33m",error:"\x1B[31m",method:{GET:"\x1B[32m",POST:"\x1B[34m",PUT:"\x1B[35m",DELETE:"\x1B[31m",PATCH:"\x1B[36m"}},N=(g,f,L)=>{let $=K[g]||K.reset,A=L?.method?K.method[L.method]||K.reset:K.reset,C=L?.status?L.status>=500?K.error:L.status>=400?K.warn:K.info:K.reset;console.log(`
${$}[${g.toUpperCase()}]${K.reset} ${f} - ${A}${L?.method||""}${K.reset}`);let E={timestamp:new Date().toISOString(),...L,status:L?.status?`${C}${L.status}${K.reset}`:void 0,method:L?.method?`${A>$}${L.method}${K.reset}`:void 0};console.log(JSON.stringify(E,null,2)+`
`)},y=(g)=>{let{app:f,logger:L,logLevel:$="info",onRequest:A,onSend:C,onError:E}=g||{};f?.addHooks("onRequest",(D,n)=>{D.startTime=Date.now(),L?.()??N($,"Incoming Request",{method:D.method,url:n.toString(),headers:{"user-agent":D.headers.get("user-agent"),"content-type":D.headers.get("content-type")}}),A?.(D,n)}),f?.addHooks("onSend",async(D)=>{let n=`${Date.now()-D.req.startTime}ms`;L?.()??N($,"Response Sent",{method:D.req.method,url:D.url.toString(),status:D.status,duration:n,reqId:D.get?.("requestId"),headers:{"content-type":D.headers.get("content-type")}});let U=await C?.(D);if(U instanceof Response)return U}),f?.addHooks("onError",async(D,n,U)=>{L?.()??N("error","Unhandled Error",{method:n.method,url:U.toString(),status:500,error:D.message});let G=await E?.(D,n,U);if(G instanceof Response)return G})},T=(g,f,L,$=0,A,C)=>{let E=K.method[f]||K.reset,D=$>=500?K.error:$>=400?K.warn:K.info,n=C?`[${C}] `:"",U=g==="<--"?`${g} ${E}${f}${K.reset} ${L} ${n}`:`${g} ${E}${f}${K.reset} ${L} ${D}${$}${K.reset} ${A??""} ${n}`;console.log(U)},K1=(g)=>{let f=Date.now()-g;return f<1000?`${f}ms`:`${Math.round(f/1000)}s`},M=(g)=>{let{app:f,log:L,onRequest:$,onSend:A,onError:C}=g;f.addHooks("onRequest",(E,D)=>{E.startTime=Date.now(),L?.()??T("<--",E.method,D.pathname),$?.(E,D)}),f.addHooks("onSend",async(E)=>{let{method:D,url:n}=E.req,U=new URL(n).pathname,G=E.get?.("requestId");L?.()??T("-->",D,U,E.status,K1(E.req.startTime),G);let S=await A?.(E);if(S instanceof Response)return S}),f.addHooks("onError",async(E,D,n)=>{L?.()??T(E.message,D.method,n.toString(),500);let U=await C?.(E,D,n);if(U instanceof Response)return U})};function q(g,f){if(!g)throw new Error("JWT library is not defined, please provide jwt to authenticateJwt Function");return(L)=>{try{let $=L.cookies?.accessToken??L.req?.headers?.get("Authorization");if(!$)return L.json({message:"Unauthorized",error:"No token provided"},401);if($.startsWith("Bearer "))$=$.slice(7);let A=g?.verify($,f);if(!A)return L.json({message:"Unauthorized",error:"Token could not be decoded"},401);L.set("user",A)}catch($){let A="Invalid token";if($.name==="TokenExpiredError")A="Token expired";else if($.name==="JsonWebTokenError")A="Malformed or tampered token";return L.json({message:"Unauthorized",error:A},401)}}}function m(g,f,L){if(!g)throw new Error("JWT library is not defined, please provide jwt to authenticateJwtDB Function");if(!f)throw new Error("User model is not defined, please provide UserModel to authenticateJwtDB Function");return async($)=>{try{let A=$.cookies?.accessToken??$.req?.headers?.get("Authorization");if(!A)return $.json({message:"Unauthorized",error:"No token provided"},401);if(A.startsWith("Bearer "))A=A.slice(7);let C=g?.verify(A,L);if(!C)return $.json({message:"Unauthorized",error:"Token could not be decoded"},401);let E=await f.findById(C._id).select("-password -refreshToken");if(!E)return $.json({message:"Unauthorized: User not found"},404);$.set("user",E);return}catch(A){let C="Invalid token";if(A.name==="TokenExpiredError")C="Token expired";else if(A.name==="JsonWebTokenError")C="Malformed or tampered token";return $.json({message:"Unauthorized",error:C},401)}}}class w{fecth;routes;tempRoutes;globalMiddlewares;middlewares;trie;hasOnReqHook;hasMiddleware;hasPreHandlerHook;hasPostHandlerHook;hasOnSendHook;hasOnError;hooks;corsConfig;FilterRoutes;filters;filterFunction;hasFilterEnabled;serverInstance;staticPath;staticFiles;user_jwt_secret;baseApiUrl;enableFileRouter;idleTimeOut;routeNotFoundFunc;constructor({jwtSecret:g,baseApiUrl:f,enableFileRouting:L,idleTimeOut:$}={}){this.fetch=this.fetch.bind(this),this.routes={},this.idleTimeOut=$??10,this.enableFileRouter=L??!1,this.baseApiUrl=f||"",this.user_jwt_secret=g||process.env.DIESEL_JWT_SECRET||"feault_diesel_secret_for_jwt",this.tempRoutes=new Map,this.globalMiddlewares=[],this.middlewares=new Map,this.trie=new V,this.corsConfig=null,this.hasMiddleware=!1,this.hasOnReqHook=!1,this.hasPreHandlerHook=!1,this.hasPostHandlerHook=!1,this.hasOnSendHook=!1,this.hasOnError=!1,this.hooks={onRequest:[],preHandler:[],postHandler:[],onSend:[],onError:[],onClose:[]},this.FilterRoutes=[],this.filters=new Set,this.filterFunction=[],this.hasFilterEnabled=!1,this.serverInstance=null,this.staticPath=null,this.staticFiles={},this.routeNotFoundFunc=()=>{}}setupFilter(){return this.hasFilterEnabled=!0,{publicRoutes:(...g)=>{return this.FilterRoutes=g,this.setupFilter()},permitAll:()=>{for(let g of this?.FilterRoutes){if(g.endsWith("/"))g=g.slice(0,-1);this.filters.add(g)}return this.FilterRoutes=null,this.setupFilter()},authenticate:(g)=>{if(g?.length)for(let f of g)this.filterFunction.push(f)},authenticateJwt:(g)=>{this.filterFunction.push(q(g,this.user_jwt_secret))},authenticateJwtDB:(g,f)=>{this.filterFunction.push(m(g,f,this.user_jwt_secret))}}}redirect(g,f,L){return this.any(g,($)=>{let A=$.params,C=f;if(A)for(let D in A)C=C.replace(`:${D}`,A[D]);let E=$.url.search;if(E)C+=E;return $.redirect(C,L)}),this}serveStatic(g){return this.staticPath=g,this}static(g){return this.staticPath=g,this}staticHtml(g){return this.staticFiles={...this.staticFiles,...g},this}addHooks(g,f){if(typeof g!=="string")throw new Error("hookName must be a string");if(typeof f!=="function")throw new Error("callback must be a instance of function");switch(g){case"onRequest":this.hooks.onRequest?.push(f);break;case"preHandler":this.hooks.preHandler?.push(f);break;case"postHandler":this.hooks.postHandler?.push(f);break;case"onSend":this.hooks.onSend?.push(f);break;case"onError":this.hooks.onError?.push(f);break;case"onClose":this.hooks.onClose?.push(f);break;default:throw new Error(`Unknown hook type: ${g}`)}return this}compile(){if(this?.globalMiddlewares?.length>0)this.hasMiddleware=!0;for(let[g,f]of this?.middlewares.entries())if(f.length>0){this.hasMiddleware=!0;break}if(this?.enableFileRouter){let g=process.cwd(),f=z.join(g,"src","routes");if(O?.existsSync(f))this.loadRoutes(f,"")}setTimeout(()=>{this.tempRoutes=null},2000)}async registerFileRoutes(g,f,L){let $=await import(g),A;if(L===".ts")A=z.basename(g,".ts");else if(L===".js")A=z.basename(g,".js");let C=f+"/"+A;if(C.endsWith("/index"))C=f;else if(C.endsWith("/api"))C=f;C=C.replace(/\[(.*?)\]/g,":$1");let E=["GET","POST","PUT","PATCH","DELETE","ANY","HEAD","OPTIONS","PROPFIND"];for(let D of E)if($[D]){let n=D.toLowerCase(),U=$[D];this[n](`${this.baseApiUrl}${C}`,U)}}async loadRoutes(g,f){let L=await O.promises.readdir(g);for(let $ of L){let A=z.join(g,$);if((await O.promises.stat(A)).isDirectory())this.loadRoutes(A,f+"/"+$);else if($.endsWith(".ts"))this.registerFileRoutes(A,f,".ts");else if($.endsWith(".js"))this.registerFileRoutes(A,f,".js")}}useLogger(g){return M(g),this}useAdvancedLogger(g){return y(g),this}BunRoute(g,f,...L){if(!f||typeof f!=="string")throw new Error("give a path in string format");if(L.length===1){let $=L[0];this.routes[f]=async(A,C)=>{if(this.hasMiddleware){if(this.globalMiddlewares.length){let n=await Z(this.globalMiddlewares,A,C);if(n)return n}let D=this.middlewares.get(f)||[];if(D?.length){let n=await Z(D,A,C);if(n)return n}}if(g!==A.method)return new Response("Method Not Allowed",{status:405});let E=await $(A,C);if(E instanceof Promise)return await E??new Response("Not Found",{status:404});return E??new Response("Not Found",{status:404})}}else this.routes[f]=async($,A)=>{if(this.hasMiddleware){if(this.globalMiddlewares.length){let E=await Z(this.globalMiddlewares,$,A);if(E)return E}let C=this.middlewares.get(f)||[];if(C?.length){let E=await Z(C,$,A);if(E)return E}}if(g!==$.method)return new Response("Method Not Allowed",{status:405});for(let C=0;C<L.length;C++){let E=L[C]($,A);if(E instanceof Promise)return await E??new Response("Not Found",{status:404});return E??new Response("Not Found",{status:404})}}}listen(g,...f){if(typeof Bun==="undefined")throw new Error(".listen() is designed to run on Bun only...");let L="0.0.0.0",$=void 0,A={};for(let E of f)if(typeof E==="string")L=E;else if(typeof E==="function")$=E;else if(typeof E==="object"&&E!==null)A=E;this.compile();let C={port:g,hostname:L,idleTimeOut:this.idleTimeOut,fetch:this.fetch(),static:this.staticFiles};if(this.routes&&Object.keys(this.routes).length>0)C.routes=this.routes;if(A.cert&&A.key)C.certFile=A.cert,C.keyFile=A.key;if(this.serverInstance=Bun?.serve(C),$)return $();return this.serverInstance}fetch(){return this.compile(),async(g,f)=>{let L=new URL(g.url);return _(g,f,L,this)}}close(g){if(this.serverInstance)this.serverInstance.stop(!0),this.serverInstance=null,g?g():console.log("Server has been stopped");else console.warn("Server is not running.")}route(g,f){if(!g||typeof g!=="string")throw new Error("Path must be a string");let L=Object.fromEntries(f.tempRoutes);return Object.entries(L).forEach(([A,C])=>{let E=A.replace(/::\w+$/,""),D=`${g}${E}`;if(!this.middlewares.has(D))this.middlewares.set(D,[]);C.handlers.slice(0,-1).forEach((S)=>{if(!this.middlewares.get(D)?.includes(S))this.middlewares.get(D)?.push(S)});let U=C.handlers[C.handlers.length-1],G=C.method;try{this.trie.insert(D,{handler:U,method:G})}catch(S){console.error(`Error inserting ${D}:`,S)}}),f=null,this}register(g,f){return this.route(g,f)}addRoute(g,f,L){if(typeof f!=="string")throw new Error(`Error in ${L[L.length-1]}: Path must be a string. Received: ${typeof f}`);if(typeof g!=="string")throw new Error(`Error in addRoute: Method must be a string. Received: ${typeof g}`);this.tempRoutes?.set(f+"::"+g,{method:g,handlers:L});let $=L.slice(0,-1),A=L[L.length-1];if(!this.middlewares.has(f))this.middlewares.set(f,[]);$.forEach((C)=>{if(f==="/")this.globalMiddlewares=[...new Set([...this.globalMiddlewares,...$])];else if(!this.middlewares.get(f)?.includes(C))this.middlewares.get(f)?.push(C)});try{if(g==="ANY"){let C=["GET","POST","PUT","DELETE","PATCH","OPTIONS","HEAD","PROPFIND"];for(let E of C)this.trie.insert(f,{handler:A,method:E})}this.trie.insert(f,{handler:A,method:g})}catch(C){console.error(`Error inserting ${f}:`,C)}}use(g,f){if(Array.isArray(g))g.forEach(($)=>{if(typeof $==="function")this.globalMiddlewares.push($)});if(typeof g==="function"){if(this.globalMiddlewares.push(g),Array.isArray(f))f.forEach(($)=>{this.globalMiddlewares.push($)});return this}return(Array.isArray(g)?g.filter(($)=>typeof $==="string"):[g].filter(($)=>typeof $==="string")).forEach(($)=>{if(!this.middlewares.has($))this.middlewares.set($,[]);if(f)(Array.isArray(f)?f:[f]).forEach((C)=>{this.middlewares.get($)?.push(C)})}),this}get(g,...f){return this.addRoute("GET",g,f),this}post(g,...f){return this.addRoute("POST",g,f),this}put(g,...f){return this.addRoute("PUT",g,f),this}patch(g,...f){return this.addRoute("PATCH",g,f),this}delete(g,...f){return this.addRoute("DELETE",g,f),this}any(g,...f){return this.addRoute("ANY",g,f),this}head(g,...f){return this.addRoute("HEAD",g,f),this}options(g,...f){return this.addRoute("OPTIONS",g,f),this}propfind(g,...f){return this.addRoute("PROPFIND",g,f),this}routeNotFound(g){return this.routeNotFoundFunc=g,this}on(g,f,...L){let $=Array.isArray(g)?g:[g];for(let A of $){let C=A.toUpperCase();if(C.toLocaleLowerCase()in this)this[C.toLocaleLowerCase()](f,...L);else this.addRoute(C,f,L)}}}export{w as default};
