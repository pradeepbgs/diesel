var k=Object.create;var{getPrototypeOf:u,defineProperty:R,getOwnPropertyNames:x}=Object;var i=Object.prototype.hasOwnProperty;var o=(g,f,L)=>{L=g!=null?k(u(g)):{};let $=f||!g||!g.__esModule?R(L,"default",{value:g,enumerable:!0}):L;for(let A of x(g))if(!i.call($,A))R($,A,{get:()=>g[A],enumerable:!0});return $};var l=((g)=>typeof require!=="undefined"?require:typeof Proxy!=="undefined"?new Proxy(g,{get:(f,L)=>(typeof require!=="undefined"?require:f)[L]}):g)(function(g){if(typeof require!=="undefined")return require.apply(this,arguments);throw Error('Dynamic require of "'+g+'" is not supported')});class Q{children;isEndOfWord;handler;isDynamic;pattern;path;method;constructor(){this.children={},this.isEndOfWord=!1,this.handler=[],this.isDynamic=!1,this.pattern="",this.path="",this.method=[]}}class D{root;constructor(){this.root=new Q}insert(g,f){let L=this.root,$=g.split("/").filter(Boolean);if(g==="/"){L.isEndOfWord=!0,L.handler.push(f.handler),L.path=g,L.method.push(f.method);return}for(let A of $){let C=!1,E=A;if(A.startsWith(":"))C=!0,E=":";if(!L.children[E])L.children[E]=new Q;L=L.children[E],L.isDynamic=C,L.pattern=A}L.isEndOfWord=!0,L.path=g,L.method.push(f.method),L.handler.push(f.handler)}search(g,f){let L=this.root,$=g.split("/").filter(Boolean),A=$.length;for(let v of $){let U=v;if(!L.children[U])if(L.children[":"])L=L.children[":"];else return null;else L=L.children[U]}let C=L.path.split("/").filter(Boolean);if(A!==C.length)return null;let E=L.method.indexOf(f);if(E!==-1)return{path:L.path,handler:L.handler[E],isDynamic:L.isDynamic,pattern:L.pattern,method:L.method[E]};return null}}function W(g){switch(g.split(".").pop()?.toLowerCase()){case"js":return"application/javascript";case"css":return"text/css";case"html":return"text/html";case"json":return"application/json";case"png":return"image/png";case"jpg":case"jpeg":return"image/jpeg";case"svg":return"image/svg+xml";case"gif":return"image/gif";case"woff":return"font/woff";case"woff2":return"font/woff2";default:return"application/octet-stream"}}function I(g,f,L){let $=null,A=null,C=null,E=null,v={},U=new Map([["string","text/plain; charset=utf-8"],["object","application/json; charset=utf-8"],["Uint8Array","application/octet-stream"],["ArrayBuffer","application/octet-stream"]]);return{req:g,server:f,url:L,status:200,headers:new Headers({"Cache-Control":"no-cache"}),setHeader(G,S){return this.headers.set(G,S),this},removeHeader(G){return this.headers.delete(G),this},get ip(){return this.server.requestIP(this.req)?.address??null},get query(){if(!$)try{$=Object.fromEntries(this.url.searchParams)}catch(G){throw new Error("Failed to parse query parameters")}return $},get params(){if(!A&&this.req.routePattern)try{A=s(this.req.routePattern,this.url.pathname)}catch(G){throw new Error("Failed to extract route parameters")}return A??{}},get body(){if(this.req.method==="GET")return Promise.resolve({});if(!E)E=(async()=>{let G=await p(this.req);if(G.error)throw new Error(G.error);return Object.keys(G).length===0?null:G})();return E},set(G,S){return v[G]=S,this},get(G){return v[G]},text(G,S){if(S)this.status=S;if(!this.headers.has("Content-Type"))this.headers.set("Content-Type","text/plain; charset=utf-8");return new Response(G,{status:this.status,headers:this.headers})},send(G,S){if(S)this.status=S;let K;if(G instanceof Uint8Array)K="Uint8Array";else if(G instanceof ArrayBuffer)K="ArrayBuffer";else K=typeof G;if(!this.headers.has("Content-Type"))this.headers.set("Content-Type",U.get(K)??"text/plain; charset=utf-8");let X=K==="object"&&G!==null?JSON.stringify(G):G;return new Response(X,{status:this.status,headers:this.headers})},json(G,S){if(S)this.status=S;if(!this.headers.has("Content-Type"))this.headers.set("Content-Type","application/json; charset=utf-8");return Response.json(G,{status:this.status,headers:this.headers})},file(G,S,K){if(K)this.status=K;let X=Bun.file(G);if(!this.headers.has("Content-Type"))this.headers.set("Content-Type",S??W(G));return new Response(X,{status:this.status,headers:this.headers})},async ejs(G,S={},K){if(K)this.status=K;let X;try{X=await import("ejs"),X=X.default||X}catch(Z){return console.error("EJS not installed! Please run `bun add ejs`"),new Response("EJS not installed! Please run `bun add ejs`",{status:500})}try{let Z=await Bun.file(G).text(),P=X.render(Z,S),c=new Headers({"Content-Type":"text/html; charset=utf-8"});return new Response(P,{status:this.status,headers:c})}catch(Z){return console.error("EJS Rendering Error:",Z),new Response("Error rendering template",{status:500})}},redirect(G,S){if(S)this.status=S;else this.status=302;return this.headers.set("Location",G),new Response(null,{status:this.status,headers:this.headers})},stream(G){let S=new Headers(this.headers),K=new ReadableStream({async start(X){await G(X),X.close()}});return new Response(K,{headers:S})},yieldStream(G){return new Response({async*[Symbol.asyncIterator](){yield*G()}},{headers:this.headers})},setCookie(G,S,K={}){let X=`${encodeURIComponent(G)}=${encodeURIComponent(S)}`;if(K.maxAge)X+=`; Max-Age=${K.maxAge}`;if(K.expires)X+=`; Expires=${K.expires.toUTCString()}`;if(K.path)X+=`; Path=${K.path}`;if(K.domain)X+=`; Domain=${K.domain}`;if(K.secure)X+="; Secure";if(K.httpOnly)X+="; HttpOnly";if(K.sameSite)X+=`; SameSite=${K.sameSite}`;return this.headers.append("Set-Cookie",X),this},get cookies(){if(!C){let G=this.req.headers.get("cookie");C=G?r(G):{}}return C}}}function r(g){return Object.fromEntries(g.split(";").map((f)=>{let[L,...$]=f.trim().split("=");return[L,decodeURIComponent($.join("="))]}))}function s(g,f){let L={},$=g.split("/"),[A]=f.split("?"),C=A.split("/");if($.length!==C.length)return null;for(let E=0;E<$.length;E++)if($[E].startsWith(":"))L[$[E].slice(1)]=C[E];return L}async function p(g){let f=g.headers.get("Content-Type");if(!f)return{};if(g.headers.get("Content-Length")==="0"||!g.body)return{};try{if(f.startsWith("application/json"))return await g.json();if(f.startsWith("application/x-www-form-urlencoded")){let $=await g.text();return Object.fromEntries(new URLSearchParams($))}if(f.startsWith("multipart/form-data")){let $=await g.formData(),A={};for(let[C,E]of $.entries())A[C]=E;return A}return{error:"Unknown request body type"}}catch($){return{error:"Invalid request body format"}}}async function _(g,f,L,$){let A=I(g,f,L),C=$.trie.search(L.pathname,g.method);g.routePattern=C?.path;try{if($.hooks.onRequest)await J("onRequest",$.hooks.onRequest,[g,L,f]);if($.hasMiddleware){let U=await d($,L.pathname,A,f);if(U)return U}if($.hasFilterEnabled){let U=g.routePattern??L.pathname,G=await h($,U,A,f);if(G)return G}if(!C)return await a($,A,L.pathname);if($.hooks.preHandler){let U=await J("preHandler",$.hooks.preHandler,[A,f]);if(U)return U}let E=C.handler(A),v=E instanceof Promise?await E:E;if($.hasOnSendHook){let U=await J("onSend",$.hooks.onSend,[A,v,f]);if(U)return U}if(v instanceof Response)return v;return B(500,"No response returned from handler.")}catch(E){return await J("onError",$.hooks.onError,[E,g,L,f])||B(500,"Internal Server Error")}}async function J(g,f,L){if(!f?.length)return;for(let $=0;$<f.length;$++){let A=f[$](...L),C=A instanceof Promise?await A:A;if(C&&g!=="onRequest")return C}}async function d(g,f,L,$){if(g.globalMiddlewares.length){let C=await H(g.globalMiddlewares,L,$);if(C)return C}let A=g.middlewares.get(f)||[];if(A.length){let C=await H(A,L,$);if(C)return C}return null}async function H(g,f,L){for(let $ of g){let A=await $(f,L);if(A)return A}return null}async function F(g,f,L){for(let $ of g){let A=await $(f,L);if(A)return A}}async function h(g,f,L,$){let A=await t(g,f,L,$),C=A instanceof Promise?await A:A;if(C)return C}async function t(g,f,L,$){if(f.endsWith("/"))f=f.slice(0,-1);if(!g.filters.has(f))if(g.filterFunction.length)for(let A of g.filterFunction){let C=await A(L,$);if(C)return C}else return Response.json({error:"Protected route, authentication required"},{status:401})}async function Q1(g,f,L,$){if(!g.filters.has(f))if(g.filterFunction.length)for(let A of g.filterFunction){let C=await A(L,$);if(C)return C}else return Response.json({error:"Protected route, authentication required"},{status:401})}async function a(g,f,L){if(g.staticPath){let A=await e(g,L,f);if(A)return A;let C=g.trie.search("*",f.req.method);if(C?.handler)return await C.handler(f)}return g.routeNotFoundFunc(f)||B(404,`Route not found for ${L}`)}function B(g,f){return new Response(JSON.stringify({error:f}),{status:g,headers:{"Content-Type":"application/json"}})}async function e(g,f,L){if(!g.staticPath)return null;let $=`${g.staticPath}${f}`;if(await Bun.file($).exists()){let C=W($);return L.file($,C,200)}return null}function z(g){if(typeof g!=="string")throw new TypeError("Path must be a string. Received "+JSON.stringify(g))}function M(g,f){var L="",$=0,A=-1,C=0,E;for(var v=0;v<=g.length;++v){if(v<g.length)E=g.charCodeAt(v);else if(E===47)break;else E=47;if(E===47){if(A===v-1||C===1);else if(A!==v-1&&C===2){if(L.length<2||$!==2||L.charCodeAt(L.length-1)!==46||L.charCodeAt(L.length-2)!==46){if(L.length>2){var U=L.lastIndexOf("/");if(U!==L.length-1){if(U===-1)L="",$=0;else L=L.slice(0,U),$=L.length-1-L.lastIndexOf("/");A=v,C=0;continue}}else if(L.length===2||L.length===1){L="",$=0,A=v,C=0;continue}}if(f){if(L.length>0)L+="/..";else L="..";$=2}}else{if(L.length>0)L+="/"+g.slice(A+1,v);else L=g.slice(A+1,v);$=v-A-1}A=v,C=0}else if(E===46&&C!==-1)++C;else C=-1}return L}function g1(g,f){var L=f.dir||f.root,$=f.base||(f.name||"")+(f.ext||"");if(!L)return $;if(L===f.root)return L+$;return L+g+$}function N(){var g="",f=!1,L;for(var $=arguments.length-1;$>=-1&&!f;$--){var A;if($>=0)A=arguments[$];else{if(L===void 0)L=process.cwd();A=L}if(z(A),A.length===0)continue;g=A+"/"+g,f=A.charCodeAt(0)===47}if(g=M(g,!f),f)if(g.length>0)return"/"+g;else return"/";else if(g.length>0)return g;else return"."}function j(g){if(z(g),g.length===0)return".";var f=g.charCodeAt(0)===47,L=g.charCodeAt(g.length-1)===47;if(g=M(g,!f),g.length===0&&!f)g=".";if(g.length>0&&L)g+="/";if(f)return"/"+g;return g}function f1(g){return z(g),g.length>0&&g.charCodeAt(0)===47}function L1(){if(arguments.length===0)return".";var g;for(var f=0;f<arguments.length;++f){var L=arguments[f];if(z(L),L.length>0)if(g===void 0)g=L;else g+="/"+L}if(g===void 0)return".";return j(g)}function $1(g,f){if(z(g),z(f),g===f)return"";if(g=N(g),f=N(f),g===f)return"";var L=1;for(;L<g.length;++L)if(g.charCodeAt(L)!==47)break;var $=g.length,A=$-L,C=1;for(;C<f.length;++C)if(f.charCodeAt(C)!==47)break;var E=f.length,v=E-C,U=A<v?A:v,G=-1,S=0;for(;S<=U;++S){if(S===U){if(v>U){if(f.charCodeAt(C+S)===47)return f.slice(C+S+1);else if(S===0)return f.slice(C+S)}else if(A>U){if(g.charCodeAt(L+S)===47)G=S;else if(S===0)G=0}break}var K=g.charCodeAt(L+S),X=f.charCodeAt(C+S);if(K!==X)break;else if(K===47)G=S}var Z="";for(S=L+G+1;S<=$;++S)if(S===$||g.charCodeAt(S)===47)if(Z.length===0)Z+="..";else Z+="/..";if(Z.length>0)return Z+f.slice(C+G);else{if(C+=G,f.charCodeAt(C)===47)++C;return f.slice(C)}}function C1(g){return g}function A1(g){if(z(g),g.length===0)return".";var f=g.charCodeAt(0),L=f===47,$=-1,A=!0;for(var C=g.length-1;C>=1;--C)if(f=g.charCodeAt(C),f===47){if(!A){$=C;break}}else A=!1;if($===-1)return L?"/":".";if(L&&$===1)return"//";return g.slice(0,$)}function E1(g,f){if(f!==void 0&&typeof f!=="string")throw new TypeError('"ext" argument must be a string');z(g);var L=0,$=-1,A=!0,C;if(f!==void 0&&f.length>0&&f.length<=g.length){if(f.length===g.length&&f===g)return"";var E=f.length-1,v=-1;for(C=g.length-1;C>=0;--C){var U=g.charCodeAt(C);if(U===47){if(!A){L=C+1;break}}else{if(v===-1)A=!1,v=C+1;if(E>=0)if(U===f.charCodeAt(E)){if(--E===-1)$=C}else E=-1,$=v}}if(L===$)$=v;else if($===-1)$=g.length;return g.slice(L,$)}else{for(C=g.length-1;C>=0;--C)if(g.charCodeAt(C)===47){if(!A){L=C+1;break}}else if($===-1)A=!1,$=C+1;if($===-1)return"";return g.slice(L,$)}}function v1(g){z(g);var f=-1,L=0,$=-1,A=!0,C=0;for(var E=g.length-1;E>=0;--E){var v=g.charCodeAt(E);if(v===47){if(!A){L=E+1;break}continue}if($===-1)A=!1,$=E+1;if(v===46){if(f===-1)f=E;else if(C!==1)C=1}else if(f!==-1)C=-1}if(f===-1||$===-1||C===0||C===1&&f===$-1&&f===L+1)return"";return g.slice(f,$)}function G1(g){if(g===null||typeof g!=="object")throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof g);return g1("/",g)}function S1(g){z(g);var f={root:"",dir:"",base:"",ext:"",name:""};if(g.length===0)return f;var L=g.charCodeAt(0),$=L===47,A;if($)f.root="/",A=1;else A=0;var C=-1,E=0,v=-1,U=!0,G=g.length-1,S=0;for(;G>=A;--G){if(L=g.charCodeAt(G),L===47){if(!U){E=G+1;break}continue}if(v===-1)U=!1,v=G+1;if(L===46){if(C===-1)C=G;else if(S!==1)S=1}else if(C!==-1)S=-1}if(C===-1||v===-1||S===0||S===1&&C===v-1&&C===E+1){if(v!==-1)if(E===0&&$)f.base=f.name=g.slice(1,v);else f.base=f.name=g.slice(E,v)}else{if(E===0&&$)f.name=g.slice(1,C),f.base=g.slice(1,v);else f.name=g.slice(E,C),f.base=g.slice(E,v);f.ext=g.slice(C,v)}if(E>0)f.dir=g.slice(0,E-1);else if($)f.dir="/";return f}var U1="/",K1=":",X1=((g)=>(g.posix=g,g))({resolve:N,normalize:j,isAbsolute:f1,join:L1,relative:$1,_makeLong:C1,dirname:A1,basename:E1,extname:v1,format:G1,parse:S1,sep:U1,delimiter:K1,win32:null,posix:null}),V=X1;var{default:b}=(()=>({}));var Y={reset:"\x1B[0m",info:"\x1B[36m",warn:"\x1B[33m",error:"\x1B[31m",method:{GET:"\x1B[32m",POST:"\x1B[34m",PUT:"\x1B[35m",DELETE:"\x1B[31m",PATCH:"\x1B[36m"}},T=(g,f,L)=>{let $=Y[g]||Y.reset,A=L?.method?Y.method[L.method]||Y.reset:Y.reset,C=L?.status?L.status>=500?Y.error:L.status>=400?Y.warn:Y.info:Y.reset;console.log(`
${$}[${g.toUpperCase()}]${Y.reset} ${f} - ${A}${L?.method||""}${Y.reset}`);let E={timestamp:new Date().toISOString(),...L,status:L?.status?`${C}${L.status}${Y.reset}`:void 0,method:L?.method?`${A>$}${L.method}${Y.reset}`:void 0};console.log(JSON.stringify(E,null,2)+`
`)},q=(g)=>{let{app:f,logger:L,logLevel:$="info",onRequest:A,onSend:C,onError:E}=g||{};f?.addHooks("onRequest",(v,U)=>{v.startTime=Date.now(),L?.()??T($,"Incoming Request",{method:v.method,url:U.toString(),headers:{"user-agent":v.headers.get("user-agent"),"content-type":v.headers.get("content-type")}}),A?.(v,U)}),f?.addHooks("onSend",async(v)=>{let U=`${Date.now()-v.req.startTime}ms`;L?.()??T($,"Response Sent",{method:v.req.method,url:v.url.toString(),status:v.status,duration:U,reqId:v.get?.("requestId"),headers:{"content-type":v.headers.get("content-type")}});let G=await C?.(v);if(G instanceof Response)return G}),f?.addHooks("onError",async(v,U,G)=>{L?.()??T("error","Unhandled Error",{method:U.method,url:G.toString(),status:500,error:v.message});let S=await E?.(v,U,G);if(S instanceof Response)return S})},O=(g,f,L,$=0,A,C)=>{let E=Y.method[f]||Y.reset,v=$>=500?Y.error:$>=400?Y.warn:Y.info,U=C?`[${C}] `:"",G=g==="<--"?`${g} ${E}${f}${Y.reset} ${L} ${U}`:`${g} ${E}${f}${Y.reset} ${L} ${v}${$}${Y.reset} ${A??""} ${U}`;console.log(G)},Y1=(g)=>{let f=Date.now()-g;return f<1000?`${f}ms`:`${Math.round(f/1000)}s`},y=(g)=>{let{app:f,log:L,onRequest:$,onSend:A,onError:C}=g;f.addHooks("onRequest",(E,v)=>{E.startTime=Date.now(),L?.()??O("<--",E.method,v.pathname),$?.(E,v)}),f.addHooks("onSend",async(E)=>{let{method:v,url:U}=E.req,G=new URL(U).pathname,S=E.get?.("requestId");L?.()??O("-->",v,G,E.status,Y1(E.req.startTime),S);let K=await A?.(E);if(K instanceof Response)return K}),f.addHooks("onError",async(E,v,U)=>{L?.()??O(E.message,v.method,U.toString(),500);let G=await C?.(E,v,U);if(G instanceof Response)return G})};function w(g,f){if(!g)throw new Error("JWT library is not defined, please provide jwt to authenticateJwt Function");return(L)=>{try{let $=L.cookies?.accessToken??L.req?.headers?.get("Authorization");if(!$)return L.json({message:"Unauthorized",error:"No token provided"},401);if($.startsWith("Bearer "))$=$.slice(7);let A=g?.verify($,f);if(!A)return L.json({message:"Unauthorized",error:"Token could not be decoded"},401);L.set("user",A)}catch($){let A="Invalid token";if($.name==="TokenExpiredError")A="Token expired";else if($.name==="JsonWebTokenError")A="Malformed or tampered token";return L.json({message:"Unauthorized",error:A},401)}}}function m(g,f,L){if(!g)throw new Error("JWT library is not defined, please provide jwt to authenticateJwtDB Function");if(!f)throw new Error("User model is not defined, please provide UserModel to authenticateJwtDB Function");return async($)=>{try{let A=$.cookies?.accessToken??$.req?.headers?.get("Authorization");if(!A)return $.json({message:"Unauthorized",error:"No token provided"},401);if(A.startsWith("Bearer "))A=A.slice(7);let C=g?.verify(A,L);if(!C)return $.json({message:"Unauthorized",error:"Token could not be decoded"},401);let E=await f.findById(C._id).select("-password -refreshToken");if(!E)return $.json({message:"Unauthorized: User not found"},404);$.set("user",E);return}catch(A){let C="Invalid token";if(A.name==="TokenExpiredError")C="Token expired";else if(A.name==="JsonWebTokenError")C="Malformed or tampered token";return $.json({message:"Unauthorized",error:C},401)}}}class n{static instance;fecth;routes;tempRoutes;globalMiddlewares;middlewares;trie;hasOnReqHook;hasMiddleware;hasPreHandlerHook;hasPostHandlerHook;hasOnSendHook;hasOnError;hooks;corsConfig;FilterRoutes;filters;filterFunction;hasFilterEnabled;serverInstance;staticPath;staticFiles;user_jwt_secret;baseApiUrl;enableFileRouter;idleTimeOut;routeNotFoundFunc;prefixApiUrl;constructor({jwtSecret:g,baseApiUrl:f,enableFileRouting:L,idleTimeOut:$,prefixApiUrl:A}={}){if(!n.instance)n.instance=this;this.prefixApiUrl=A??"",this.fetch=this.fetch.bind(this),this.routes={},this.idleTimeOut=$??10,this.enableFileRouter=L??!1,this.baseApiUrl=f||"",this.user_jwt_secret=g||process.env.DIESEL_JWT_SECRET||"feault_diesel_secret_for_jwt",this.tempRoutes=new Map,this.globalMiddlewares=[],this.middlewares=new Map,this.trie=new D,this.corsConfig=null,this.hasMiddleware=!1,this.hasOnReqHook=!1,this.hasPreHandlerHook=!1,this.hasPostHandlerHook=!1,this.hasOnSendHook=!1,this.hasOnError=!1,this.hooks={onRequest:[],preHandler:[],postHandler:[],onSend:[],onError:[],onClose:[]},this.FilterRoutes=[],this.filters=new Set,this.filterFunction=[],this.hasFilterEnabled=!1,this.serverInstance=null,this.staticPath=null,this.staticFiles={},this.routeNotFoundFunc=()=>{}}static router(g){if(this.instance.prefixApiUrl=g,!this.instance)console.log("no instance"),this.instance=new n;return this.instance}setupFilter(){return this.hasFilterEnabled=!0,{publicRoutes:(...g)=>{return this.FilterRoutes=g,this.setupFilter()},permitAll:()=>{for(let g of this?.FilterRoutes){if(g.endsWith("/"))g=g.slice(0,-1);this.filters.add(g)}return this.FilterRoutes=null,this.setupFilter()},authenticate:(g)=>{if(g?.length)for(let f of g)this.filterFunction.push(f)},authenticateJwt:(g)=>{this.filterFunction.push(w(g,this.user_jwt_secret))},authenticateJwtDB:(g,f)=>{this.filterFunction.push(m(g,f,this.user_jwt_secret))}}}redirect(g,f,L){return this.any(g,($)=>{let A=$.params,C=f;if(A)for(let v in A)C=C.replace(`:${v}`,A[v]);let E=$.url.search;if(E)C+=E;return $.redirect(C,L)}),this}serveStatic(g){return this.staticPath=g,this}static(g){return this.staticPath=g,this}staticHtml(g){return this.staticFiles={...this.staticFiles,...g},this}addHooks(g,f){if(typeof g!=="string")throw new Error("hookName must be a string");if(typeof f!=="function")throw new Error("callback must be a instance of function");switch(g){case"onRequest":this.hooks.onRequest?.push(f);break;case"preHandler":this.hooks.preHandler?.push(f);break;case"postHandler":this.hooks.postHandler?.push(f);break;case"onSend":this.hooks.onSend?.push(f);break;case"onError":this.hooks.onError?.push(f);break;case"onClose":this.hooks.onClose?.push(f);break;default:throw new Error(`Unknown hook type: ${g}`)}return this}compile(){if(this?.globalMiddlewares?.length>0)this.hasMiddleware=!0;for(let[g,f]of this?.middlewares.entries())if(f.length>0){this.hasMiddleware=!0;break}if(this?.enableFileRouter){let g=process.cwd(),f=V.join(g,"src","routes");if(b?.existsSync(f))this.loadRoutes(f,"")}setTimeout(()=>{this.tempRoutes=null},2000)}async registerFileRoutes(g,f,L){let $=await import(g),A;if(L===".ts")A=V.basename(g,".ts");else if(L===".js")A=V.basename(g,".js");let C=f+"/"+A;if(C.endsWith("/index"))C=f;else if(C.endsWith("/api"))C=f;C=C.replace(/\[(.*?)\]/g,":$1");let E=["GET","POST","PUT","PATCH","DELETE","ANY","HEAD","OPTIONS","PROPFIND"];for(let v of E)if($[v]){let U=v.toLowerCase(),G=$[v];this[U](`${this.baseApiUrl}${C}`,G)}}async loadRoutes(g,f){let L=await b.promises.readdir(g);for(let $ of L){let A=V.join(g,$);if((await b.promises.stat(A)).isDirectory())await this.loadRoutes(A,f+"/"+$);else if($.endsWith(".ts"))await this.registerFileRoutes(A,f,".ts");else if($.endsWith(".js"))await this.registerFileRoutes(A,f,".js")}}useLogger(g){return y(g),this}useAdvancedLogger(g){return q(g),this}BunRoute(g,f,...L){if(!f||typeof f!=="string")throw new Error("give a path in string format");this.routes[f]=async($,A)=>{if(this.hasMiddleware){if(this.globalMiddlewares.length){let E=await F(this.globalMiddlewares,$,A);if(E)return E}let C=this.middlewares.get(f)||[];if(C?.length){let E=await F(C,$,A);if(E)return E}}if(g!==$.method)return new Response("Method Not Allowed",{status:405});if(L.length===1){let C=L[0]($,A);if(C instanceof Promise)return await C??new Response("Not Found",{status:404});if(C instanceof Response)return C}else for(let C=0;C<L.length;C++){let E=L[C]($,A);if(E instanceof Promise)return await E??new Response("Not Found",{status:404});if(E instanceof Response)return E}}}listen(g,...f){if(typeof Bun==="undefined")throw new Error(".listen() is designed to run on Bun only...");let L="0.0.0.0",$=void 0,A={};for(let E of f)if(typeof E==="string")L=E;else if(typeof E==="function")$=E;else if(typeof E==="object"&&E!==null)A=E;let C={port:g,hostname:L,idleTimeOut:this.idleTimeOut,fetch:this.fetch(),static:this.staticFiles};if(this.routes&&Object.keys(this.routes).length>0)C.routes=this.routes;if(A.cert&&A.key)C.certFile=A.cert,C.keyFile=A.key;if(this.serverInstance=Bun?.serve(C),$)$();return this.serverInstance}fetch(){return this.compile(),async(g,f)=>{let L=new URL(g.url);return _(g,f,L,this)}}close(g){if(this.serverInstance)this.serverInstance.stop(!0),this.serverInstance=null,g?g():console.log("Server has been stopped");else console.warn("Server is not running.")}route(g,f){g=g&&g.length>0?g:f?.prefixApiUrl;let L=f?.tempRoutes??new Map;for(let[$,A]of L.entries()){let C=$.replace(/::\w+$/,""),E=`${g}${C}`;if(!this.middlewares.has(E))this.middlewares.set(E,[]);A.handlers.slice(0,-1).forEach((S)=>{let K=this.middlewares.get(E);if(!K.includes(S))K.push(S)});let U=A.handlers[A.handlers.length-1],G=A.method;try{this.trie.insert(E,{handler:U,method:G})}catch(S){console.error(`Error inserting ${E}:`,S)}}return f=null,this}register(g,f){return this.route(g,f)}addRoute(g,f,L){if(typeof f!=="string")throw new Error(`Error in ${L[L.length-1]}: Path must be a string. Received: ${typeof f}`);if(typeof g!=="string")throw new Error(`Error in addRoute: Method must be a string. Received: ${typeof g}`);this.tempRoutes?.set(f+"::"+g,{method:g,handlers:L});let $=L.slice(0,-1),A=L[L.length-1];if(!this.middlewares.has(f))this.middlewares.set(f,[]);$.forEach((C)=>{if(f==="/")this.globalMiddlewares=[...new Set([...this.globalMiddlewares,...$])];else if(!this.middlewares.get(f)?.includes(C))this.middlewares.get(f)?.push(C)});try{if(g==="ANY"){let C=["GET","POST","PUT","DELETE","PATCH","OPTIONS","HEAD","PROPFIND"];for(let E of C)this.trie.insert(f,{handler:A,method:E})}this.trie.insert(f,{handler:A,method:g})}catch(C){console.error(`Error inserting ${f}:`,C)}}use(g,f){if(Array.isArray(g))g.forEach(($)=>{if(typeof $==="function")this.globalMiddlewares.push($)});if(typeof g==="function"){if(this.globalMiddlewares.push(g),Array.isArray(f))f.forEach(($)=>{this.globalMiddlewares.push($)});return this}return(Array.isArray(g)?g.filter(($)=>typeof $==="string"):[g].filter(($)=>typeof $==="string")).forEach(($)=>{if(!this.middlewares.has($))this.middlewares.set($,[]);if(f)(Array.isArray(f)?f:[f]).forEach((C)=>{this.middlewares.get($)?.push(C)})}),this}get(g,...f){return this.addRoute("GET",g,f),this}post(g,...f){return this.addRoute("POST",g,f),this}put(g,...f){return this.addRoute("PUT",g,f),this}patch(g,...f){return this.addRoute("PATCH",g,f),this}delete(g,...f){return this.addRoute("DELETE",g,f),this}any(g,...f){return this.addRoute("ANY",g,f),this}head(g,...f){return this.addRoute("HEAD",g,f),this}options(g,...f){return this.addRoute("OPTIONS",g,f),this}propfind(g,...f){return this.addRoute("PROPFIND",g,f),this}routeNotFound(g){return this.routeNotFoundFunc=g,this}on(g,f,...L){let $=Array.isArray(g)?g:[g];for(let A of $){let C=A.toUpperCase();if(C.toLocaleLowerCase()in this)this[C.toLocaleLowerCase()](f,...L);else this.addRoute(C,f,L)}}}export{n as default};
