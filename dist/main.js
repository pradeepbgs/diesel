var w=Object.create;var{getPrototypeOf:P,defineProperty:b,getOwnPropertyNames:k}=Object;var x=Object.prototype.hasOwnProperty;var u=(g,f,L)=>{L=g!=null?w(P(g)):{};let $=f||!g||!g.__esModule?b(L,"default",{value:g,enumerable:!0}):L;for(let C of k(g))if(!x.call($,C))b($,C,{get:()=>g[C],enumerable:!0});return $};var i=((g)=>typeof require!=="undefined"?require:typeof Proxy!=="undefined"?new Proxy(g,{get:(f,L)=>(typeof require!=="undefined"?require:f)[L]}):g)(function(g){if(typeof require!=="undefined")return require.apply(this,arguments);throw Error('Dynamic require of "'+g+'" is not supported')});class I{children;isEndOfWord;handler;isDynamic;pattern;path;method;constructor(){this.children={},this.isEndOfWord=!1,this.handler=[],this.isDynamic=!1,this.pattern="",this.path="",this.method=[]}}class W{root;constructor(){this.root=new I}insert(g,f){let L=this.root,$=g.split("/").filter(Boolean);if(g==="/"){L.isEndOfWord=!0,L.handler.push(f.handler),L.path=g,L.method.push(f.method);return}for(let C of $){let A=!1,E=C;if(C.startsWith(":"))A=!0,E=":";if(!L.children[E])L.children[E]=new I;L=L.children[E],L.isDynamic=A,L.pattern=C}L.isEndOfWord=!0,L.path=g,L.method.push(f.method),L.handler.push(f.handler)}search(g,f){let L=this.root,$=g.split("/").filter(Boolean),C=$.length;for(let D of $){let v=D;if(!L.children[v])if(L.children[":"])L=L.children[":"];else return null;else L=L.children[v]}let A=L.path.split("/").filter(Boolean);if(C!==A.length)return null;let E=L.method.indexOf(f);if(E!==-1)return{path:L.path,handler:L.handler[E],isDynamic:L.isDynamic,pattern:L.pattern,method:L.method[E]};return{path:L.path,handler:L.handler,isDynamic:L.isDynamic,pattern:L.pattern,method:L.method[E]}}}function J(g){switch(g.split(".").pop()?.toLowerCase()){case"js":return"application/javascript";case"css":return"text/css";case"html":return"text/html";case"json":return"application/json";case"png":return"image/png";case"jpg":case"jpeg":return"image/jpeg";case"svg":return"image/svg+xml";case"gif":return"image/gif";case"woff":return"font/woff";case"woff2":return"font/woff2";default:return"application/octet-stream"}}function Q(g,f,L){let $=null,C=null,A=null,E=null,D={};return{req:g,server:f,url:L,status:200,headers:new Headers({"Cache-Control":"no-cache"}),setHeader(v,U){return this.headers.set(v,U),this},removeHeader(v){return this.headers.delete(v),this},get ip(){return this.server.requestIP(this.req)?.address??null},get query(){if(!$)try{$=Object.fromEntries(this.url.searchParams)}catch(v){throw new Error("Failed to parse query parameters")}return $},get params(){if(!C&&this.req.routePattern)try{C=r(this.req.routePattern,this.url.pathname)}catch(v){throw new Error("Failed to extract route parameters")}return C??{}},get body(){if(this.req.method==="GET")return Promise.resolve({});if(!E)E=(async()=>{let v=await s(this.req);if(v.error)throw new Error(v.error);return Object.keys(v).length===0?null:v})();return E},set(v,U){return D[v]=U,this},get(v){return D[v]},text(v,U){if(U)this.status=U;if(!this.headers.has("Content-Type"))this.headers.set("Content-Type","text/plain; charset=utf-8");return new Response(v,{status:this.status,headers:this.headers})},send(v,U){if(U)this.status=U;let z=new Map([["string","text/plain; charset=utf-8"],["object","application/json; charset=utf-8"],["Uint8Array","application/octet-stream"],["ArrayBuffer","application/octet-stream"]]),G;if(v instanceof Uint8Array)G="Uint8Array";else if(v instanceof ArrayBuffer)G="ArrayBuffer";else G=typeof v;if(!this.headers.has("Content-Type"))this.headers.set("Content-Type",z.get(G)??"text/plain; charset=utf-8");let Y=G==="object"&&v!==null?JSON.stringify(v):v;return new Response(Y,{status:this.status,headers:this.headers})},json(v,U){if(U)this.status=U;if(!this.headers.has("Content-Type"))this.headers.set("Content-Type","application/json; charset=utf-8");return Response.json(v,{status:this.status,headers:this.headers})},file(v,U,z){if(z)this.status=z;let G=Bun.file(v);if(!this.headers.has("Content-Type"))this.headers.set("Content-Type",U??J(v));return new Response(G,{status:this.status,headers:this.headers})},async ejs(v,U={},z){if(z)this.status=z;let G;try{G=await import("ejs"),G=G.default||G}catch(Y){return console.error("EJS not installed! Please run `bun add ejs`"),new Response("EJS not installed! Please run `bun add ejs`",{status:500})}try{let Y=await Bun.file(v).text(),Z=G.render(Y,U),c=new Headers({"Content-Type":"text/html; charset=utf-8"});return new Response(Z,{status:this.status,headers:c})}catch(Y){return console.error("EJS Rendering Error:",Y),new Response("Error rendering template",{status:500})}},redirect(v,U){if(U)this.status=U;else this.status=302;return this.headers.set("Location",v),new Response(null,{status:this.status,headers:this.headers})},stream(v){let U=new Headers(this.headers),z=new ReadableStream({async start(G){await v(G),G.close()}});return new Response(z,{headers:U})},yieldStream(v){return new Response({async*[Symbol.asyncIterator](){yield*v()}},{headers:this.headers})},setCookie(v,U,z={}){let G=`${encodeURIComponent(v)}=${encodeURIComponent(U)}`;if(z.maxAge)G+=`; Max-Age=${z.maxAge}`;if(z.expires)G+=`; Expires=${z.expires.toUTCString()}`;if(z.path)G+=`; Path=${z.path}`;if(z.domain)G+=`; Domain=${z.domain}`;if(z.secure)G+="; Secure";if(z.httpOnly)G+="; HttpOnly";if(z.sameSite)G+=`; SameSite=${z.sameSite}`;return this.headers.append("Set-Cookie",G),this},get cookies(){if(!A){let v=this.req.headers.get("cookie");A=v?o(v):{}}return A}}}function o(g){return Object.fromEntries(g.split(";").map((f)=>{let[L,...$]=f.trim().split("=");return[L,decodeURIComponent($.join("="))]}))}function r(g,f){let L={},$=g.split("/"),[C]=f.split("?"),A=C.split("/");if($.length!==A.length)return null;for(let E=0;E<$.length;E++)if($[E].startsWith(":"))L[$[E].slice(1)]=A[E];return L}async function s(g){let f=g.headers.get("Content-Type");if(!f)return{};if(g.headers.get("Content-Length")==="0"||!g.body)return{};try{if(f.startsWith("application/json"))return await g.json();if(f.startsWith("application/x-www-form-urlencoded")){let $=await g.text();return Object.fromEntries(new URLSearchParams($))}if(f.startsWith("multipart/form-data")){let $=await g.formData(),C={};for(let[A,E]of $.entries())C[A]=E;return C}return{error:"Unknown request body type"}}catch($){return{error:"Invalid request body format"}}}async function _(g,f,L,$){let C=Q(g,f,L),A=$.trie.search(L.pathname,g.method);g.routePattern=A?.path;try{if($.hasMiddleware){if($.globalMiddlewares.length){let U=await m($.globalMiddlewares,C,f);if(U)return U}let v=$.middlewares.get(L.pathname)||[];if(v?.length){let U=await m(v,C,f);if(U)return U}}if($.hasFilterEnabled){let v=g.routePattern??L.pathname,U=await l($,v,C,f),z=U instanceof Promise?await U:U;if(z)return z}if(!A?.handler||A.method!==g.method){if($.staticPath){let U=await p($,L.pathname,C);if(U)return U;let z=$.trie.search("*",g.method);if(z?.handler)return await z.handler(C)}let v=$.routeNotFoundFunc(C);if(v)return v;return F(404,`Route not found for ${L.pathname}`)}if($.hooks.preHandler?.length&&Array.isArray($.hooks.preHandler)){let v=$.hooks.preHandler;for(let U=0;U<v.length;U++){let z=v[U](C),G=z instanceof Promise?await z:z;if(G)return G}}let E=A.handler(C);return(E instanceof Promise?await E:E)??F(204,"")}catch(E){if($.hooks.onError&&Array.isArray($.hooks.onError)){let D=$.hooks.onError;for(let v=0;v<D.length;v++){let U=$.hooks.onError[v](E,g,L,f),z=U instanceof Promise?await U:U;if(z)return z}}return F(500,"Internal Server Error")}finally{if($.hooks.onSend&&Array.isArray($.hooks.onSend)){let E=$.hooks.onSend;for(let D=0;D<E.length;D++){let v=E[D](C),U=v instanceof Promise?await v:v;if(U)return U}}}}async function m(g,f,L){for(let $ of g){let C=await $(f,L);if(C)return C}return null}async function V(g,f,L){for(let $ of g){let C=await $(f,L);if(C)return C}}async function l(g,f,L,$){if(f.endsWith("/"))f=f.slice(0,-1);if(!g.filters.has(f))if(g.filterFunction.length)for(let C of g.filterFunction){let A=await C(L,$);if(A)return A}else return Response.json({error:"Protected route, authentication required"},{status:401})}async function V1(g,f,L,$){if(!g.filters.has(f))if(g.filterFunction.length)for(let C of g.filterFunction){let A=await C(L,$);if(A)return A}else return Response.json({error:"Protected route, authentication required"},{status:401})}function F(g,f){return new Response(JSON.stringify({error:f}),{status:g,headers:{"Content-Type":"application/json"}})}async function p(g,f,L){if(!g.staticPath)return null;let $=`${g.staticPath}${f}`;if(await Bun.file($).exists()){let A=J($);return L.file($,A,200)}return null}function X(g){if(typeof g!=="string")throw new TypeError("Path must be a string. Received "+JSON.stringify(g))}function y(g,f){var L="",$=0,C=-1,A=0,E;for(var D=0;D<=g.length;++D){if(D<g.length)E=g.charCodeAt(D);else if(E===47)break;else E=47;if(E===47){if(C===D-1||A===1);else if(C!==D-1&&A===2){if(L.length<2||$!==2||L.charCodeAt(L.length-1)!==46||L.charCodeAt(L.length-2)!==46){if(L.length>2){var v=L.lastIndexOf("/");if(v!==L.length-1){if(v===-1)L="",$=0;else L=L.slice(0,v),$=L.length-1-L.lastIndexOf("/");C=D,A=0;continue}}else if(L.length===2||L.length===1){L="",$=0,C=D,A=0;continue}}if(f){if(L.length>0)L+="/..";else L="..";$=2}}else{if(L.length>0)L+="/"+g.slice(C+1,D);else L=g.slice(C+1,D);$=D-C-1}C=D,A=0}else if(E===46&&A!==-1)++A;else A=-1}return L}function h(g,f){var L=f.dir||f.root,$=f.base||(f.name||"")+(f.ext||"");if(!L)return $;if(L===f.root)return L+$;return L+g+$}function B(){var g="",f=!1,L;for(var $=arguments.length-1;$>=-1&&!f;$--){var C;if($>=0)C=arguments[$];else{if(L===void 0)L=process.cwd();C=L}if(X(C),C.length===0)continue;g=C+"/"+g,f=C.charCodeAt(0)===47}if(g=y(g,!f),f)if(g.length>0)return"/"+g;else return"/";else if(g.length>0)return g;else return"."}function j(g){if(X(g),g.length===0)return".";var f=g.charCodeAt(0)===47,L=g.charCodeAt(g.length-1)===47;if(g=y(g,!f),g.length===0&&!f)g=".";if(g.length>0&&L)g+="/";if(f)return"/"+g;return g}function d(g){return X(g),g.length>0&&g.charCodeAt(0)===47}function t(){if(arguments.length===0)return".";var g;for(var f=0;f<arguments.length;++f){var L=arguments[f];if(X(L),L.length>0)if(g===void 0)g=L;else g+="/"+L}if(g===void 0)return".";return j(g)}function a(g,f){if(X(g),X(f),g===f)return"";if(g=B(g),f=B(f),g===f)return"";var L=1;for(;L<g.length;++L)if(g.charCodeAt(L)!==47)break;var $=g.length,C=$-L,A=1;for(;A<f.length;++A)if(f.charCodeAt(A)!==47)break;var E=f.length,D=E-A,v=C<D?C:D,U=-1,z=0;for(;z<=v;++z){if(z===v){if(D>v){if(f.charCodeAt(A+z)===47)return f.slice(A+z+1);else if(z===0)return f.slice(A+z)}else if(C>v){if(g.charCodeAt(L+z)===47)U=z;else if(z===0)U=0}break}var G=g.charCodeAt(L+z),Y=f.charCodeAt(A+z);if(G!==Y)break;else if(G===47)U=z}var Z="";for(z=L+U+1;z<=$;++z)if(z===$||g.charCodeAt(z)===47)if(Z.length===0)Z+="..";else Z+="/..";if(Z.length>0)return Z+f.slice(A+U);else{if(A+=U,f.charCodeAt(A)===47)++A;return f.slice(A)}}function e(g){return g}function g1(g){if(X(g),g.length===0)return".";var f=g.charCodeAt(0),L=f===47,$=-1,C=!0;for(var A=g.length-1;A>=1;--A)if(f=g.charCodeAt(A),f===47){if(!C){$=A;break}}else C=!1;if($===-1)return L?"/":".";if(L&&$===1)return"//";return g.slice(0,$)}function f1(g,f){if(f!==void 0&&typeof f!=="string")throw new TypeError('"ext" argument must be a string');X(g);var L=0,$=-1,C=!0,A;if(f!==void 0&&f.length>0&&f.length<=g.length){if(f.length===g.length&&f===g)return"";var E=f.length-1,D=-1;for(A=g.length-1;A>=0;--A){var v=g.charCodeAt(A);if(v===47){if(!C){L=A+1;break}}else{if(D===-1)C=!1,D=A+1;if(E>=0)if(v===f.charCodeAt(E)){if(--E===-1)$=A}else E=-1,$=D}}if(L===$)$=D;else if($===-1)$=g.length;return g.slice(L,$)}else{for(A=g.length-1;A>=0;--A)if(g.charCodeAt(A)===47){if(!C){L=A+1;break}}else if($===-1)C=!1,$=A+1;if($===-1)return"";return g.slice(L,$)}}function L1(g){X(g);var f=-1,L=0,$=-1,C=!0,A=0;for(var E=g.length-1;E>=0;--E){var D=g.charCodeAt(E);if(D===47){if(!C){L=E+1;break}continue}if($===-1)C=!1,$=E+1;if(D===46){if(f===-1)f=E;else if(A!==1)A=1}else if(f!==-1)A=-1}if(f===-1||$===-1||A===0||A===1&&f===$-1&&f===L+1)return"";return g.slice(f,$)}function $1(g){if(g===null||typeof g!=="object")throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof g);return h("/",g)}function A1(g){X(g);var f={root:"",dir:"",base:"",ext:"",name:""};if(g.length===0)return f;var L=g.charCodeAt(0),$=L===47,C;if($)f.root="/",C=1;else C=0;var A=-1,E=0,D=-1,v=!0,U=g.length-1,z=0;for(;U>=C;--U){if(L=g.charCodeAt(U),L===47){if(!v){E=U+1;break}continue}if(D===-1)v=!1,D=U+1;if(L===46){if(A===-1)A=U;else if(z!==1)z=1}else if(A!==-1)z=-1}if(A===-1||D===-1||z===0||z===1&&A===D-1&&A===E+1){if(D!==-1)if(E===0&&$)f.base=f.name=g.slice(1,D);else f.base=f.name=g.slice(E,D)}else{if(E===0&&$)f.name=g.slice(1,A),f.base=g.slice(1,D);else f.name=g.slice(E,A),f.base=g.slice(E,D);f.ext=g.slice(A,D)}if(E>0)f.dir=g.slice(0,E-1);else if($)f.dir="/";return f}var C1="/",E1=":",v1=((g)=>(g.posix=g,g))({resolve:B,normalize:j,isAbsolute:d,join:t,relative:a,_makeLong:e,dirname:g1,basename:f1,extname:L1,format:$1,parse:A1,sep:C1,delimiter:E1,win32:null,posix:null}),S=v1;var{default:O}=(()=>({}));var K={reset:"\x1B[0m",info:"\x1B[36m",warn:"\x1B[33m",error:"\x1B[31m",method:{GET:"\x1B[32m",POST:"\x1B[34m",PUT:"\x1B[35m",DELETE:"\x1B[31m",PATCH:"\x1B[36m"}},N=(g,f,L)=>{let $=K[g]||K.reset,C=L?.method?K.method[L.method]||K.reset:K.reset,A=L?.status?L.status>=500?K.error:L.status>=400?K.warn:K.info:K.reset;console.log(`
${$}[${g.toUpperCase()}]${K.reset} ${f} - ${C}${L?.method||""}${K.reset}`);let E={timestamp:new Date().toISOString(),...L,status:L?.status?`${A}${L.status}${K.reset}`:void 0,method:L?.method?`${C>$}${L.method}${K.reset}`:void 0};console.log(JSON.stringify(E,null,2)+`
`)},n=(g)=>{let{app:f,logger:L,logLevel:$="info",onRequest:C,onSend:A,onError:E}=g||{};f?.addHooks("onRequest",(D,v)=>{D.startTime=Date.now(),L?.()??N($,"Incoming Request",{method:D.method,url:v.toString(),headers:{"user-agent":D.headers.get("user-agent"),"content-type":D.headers.get("content-type")}}),C?.(D,v)}),f?.addHooks("onSend",async(D)=>{let v=`${Date.now()-D.req.startTime}ms`;L?.()??N($,"Response Sent",{method:D.req.method,url:D.url.toString(),status:D.status,duration:v,reqId:D.get?.("requestId"),headers:{"content-type":D.headers.get("content-type")}});let U=await A?.(D);if(U instanceof Response)return U}),f?.addHooks("onError",async(D,v,U)=>{L?.()??N("error","Unhandled Error",{method:v.method,url:U.toString(),status:500,error:D.message});let z=await E?.(D,v,U);if(z instanceof Response)return z})},T=(g,f,L,$=0,C,A)=>{let E=K.method[f]||K.reset,D=$>=500?K.error:$>=400?K.warn:K.info,v=A?`[${A}] `:"",U=g==="<--"?`${g} ${E}${f}${K.reset} ${L} ${v}`:`${g} ${E}${f}${K.reset} ${L} ${D}${$}${K.reset} ${C??""} ${v}`;console.log(U)},D1=(g)=>{let f=Date.now()-g;return f<1000?`${f}ms`:`${Math.round(f/1000)}s`},H=(g)=>{let{app:f,log:L,onRequest:$,onSend:C,onError:A}=g;f.addHooks("onRequest",(E,D)=>{E.startTime=Date.now(),L?.()??T("<--",E.method,D.pathname),$?.(E,D)}),f.addHooks("onSend",async(E)=>{let{method:D,url:v}=E.req,U=new URL(v).pathname,z=E.get?.("requestId");L?.()??T("-->",D,U,E.status,D1(E.req.startTime),z);let G=await C?.(E);if(G instanceof Response)return G}),f.addHooks("onError",async(E,D,v)=>{L?.()??T(E.message,D.method,v.toString(),500);let U=await A?.(E,D,v);if(U instanceof Response)return U})};function R(g,f){if(!g)throw new Error("JWT library is not defined, please provide jwt to authenticateJwt Function");return(L)=>{try{let $=L.cookies?.accessToken??L.req?.headers?.get("Authorization");if(!$)return L.json({message:"Unauthorized",error:"No token provided"},401);if($.startsWith("Bearer "))$=$.slice(7);let C=g?.verify($,f);if(!C)return L.json({message:"Unauthorized",error:"Token could not be decoded"},401);L.set("user",C)}catch($){let C="Invalid token";if($.name==="TokenExpiredError")C="Token expired";else if($.name==="JsonWebTokenError")C="Malformed or tampered token";return L.json({message:"Unauthorized",error:C},401)}}}function q(g,f,L){if(!g)throw new Error("JWT library is not defined, please provide jwt to authenticateJwtDB Function");if(!f)throw new Error("User model is not defined, please provide UserModel to authenticateJwtDB Function");return async($)=>{try{let C=$.cookies?.accessToken??$.req?.headers?.get("Authorization");if(!C)return $.json({message:"Unauthorized",error:"No token provided"},401);if(C.startsWith("Bearer "))C=C.slice(7);let A=g?.verify(C,L);if(!A)return $.json({message:"Unauthorized",error:"Token could not be decoded"},401);let E=await f.findById(A._id).select("-password -refreshToken");if(!E)return $.json({message:"Unauthorized: User not found"},404);$.set("user",E);return}catch(C){let A="Invalid token";if(C.name==="TokenExpiredError")A="Token expired";else if(C.name==="JsonWebTokenError")A="Malformed or tampered token";return $.json({message:"Unauthorized",error:A},401)}}}class M{fecth;routes;tempRoutes;globalMiddlewares;middlewares;trie;hasOnReqHook;hasMiddleware;hasPreHandlerHook;hasPostHandlerHook;hasOnSendHook;hasOnError;hooks;corsConfig;FilterRoutes;filters;filterFunction;hasFilterEnabled;serverInstance;staticPath;staticFiles;user_jwt_secret;baseApiUrl;enableFileRouter;idleTimeOut;routeNotFoundFunc;constructor({jwtSecret:g,baseApiUrl:f,enableFileRouting:L,idleTimeOut:$}={}){this.fetch=this.fetch.bind(this),this.routes={},this.idleTimeOut=$??10,this.enableFileRouter=L??!1,this.baseApiUrl=f||"",this.user_jwt_secret=g||process.env.DIESEL_JWT_SECRET||"feault_diesel_secret_for_jwt",this.tempRoutes=new Map,this.globalMiddlewares=[],this.middlewares=new Map,this.trie=new W,this.corsConfig=null,this.hasMiddleware=!1,this.hasOnReqHook=!1,this.hasPreHandlerHook=!1,this.hasPostHandlerHook=!1,this.hasOnSendHook=!1,this.hasOnError=!1,this.hooks={onRequest:[],preHandler:[],postHandler:[],onSend:[],onError:[],onClose:[]},this.FilterRoutes=[],this.filters=new Set,this.filterFunction=[],this.hasFilterEnabled=!1,this.serverInstance=null,this.staticPath=null,this.staticFiles={},this.routeNotFoundFunc=()=>{}}setupFilter(){return this.hasFilterEnabled=!0,{publicRoutes:(...g)=>{return this.FilterRoutes=g,this.setupFilter()},permitAll:()=>{for(let g of this?.FilterRoutes){if(g.endsWith("/"))g=g.slice(0,-1);this.filters.add(g)}return this.FilterRoutes=null,this.setupFilter()},authenticate:(g)=>{if(g?.length)for(let f of g)this.filterFunction.push(f)},authenticateJwt:(g)=>{this.filterFunction.push(R(g,this.user_jwt_secret))},authenticateJwtDB:(g,f)=>{this.filterFunction.push(q(g,f,this.user_jwt_secret))}}}redirect(g,f,L){return this.any(g,($)=>{let C=$.params,A=f;if(C)for(let D in C)A=A.replace(`:${D}`,C[D]);let E=$.url.search;if(E)A+=E;return $.redirect(A,L)}),this}serveStatic(g){return this.staticPath=g,this}static(g){return this.staticPath=g,this}staticHtml(g){return this.staticFiles={...this.staticFiles,...g},this}addHooks(g,f){if(typeof g!=="string")throw new Error("hookName must be a string");if(typeof f!=="function")throw new Error("callback must be a instance of function");switch(g){case"onRequest":this.hooks.onRequest?.push(f);break;case"preHandler":this.hooks.preHandler?.push(f);break;case"postHandler":this.hooks.postHandler?.push(f);break;case"onSend":this.hooks.onSend?.push(f);break;case"onError":this.hooks.onError?.push(f);break;case"onClose":this.hooks.onClose?.push(f);break;default:throw new Error(`Unknown hook type: ${g}`)}return this}compile(){if(this?.globalMiddlewares?.length>0)this.hasMiddleware=!0;for(let[g,f]of this?.middlewares.entries())if(f.length>0){this.hasMiddleware=!0;break}if(this?.enableFileRouter){let g=process.cwd(),f=S.join(g,"src","routes");if(O?.existsSync(f))this.loadRoutes(f,"")}setTimeout(()=>{this.tempRoutes=null},2000)}async registerFileRoutes(g,f,L){let $=await import(g),C;if(L===".ts")C=S.basename(g,".ts");else if(L===".js")C=S.basename(g,".js");let A=f+"/"+C;if(A.endsWith("/index"))A=f;else if(A.endsWith("/api"))A=f;A=A.replace(/\[(.*?)\]/g,":$1");let E=["GET","POST","PUT","PATCH","DELETE","ANY","HEAD","OPTIONS","PROPFIND"];for(let D of E)if($[D]){let v=D.toLowerCase(),U=$[D];this[v](`${this.baseApiUrl}${A}`,U)}}async loadRoutes(g,f){let L=await O.promises.readdir(g);for(let $ of L){let C=S.join(g,$);if((await O.promises.stat(C)).isDirectory())this.loadRoutes(C,f+"/"+$);else if($.endsWith(".ts"))this.registerFileRoutes(C,f,".ts");else if($.endsWith(".js"))this.registerFileRoutes(C,f,".js")}}useLogger(g){return H(g),this}useAdvancedLogger(g){return n(g),this}BunRoute(g,f,...L){if(!f||typeof f!=="string")throw new Error("give a path in string format");if(L.length===1){let $=L[0];this.routes[f]=async(C,A)=>{if(this.hasMiddleware){if(this.globalMiddlewares.length){let v=await V(this.globalMiddlewares,C,A);if(v)return v}let D=this.middlewares.get(f)||[];if(D?.length){let v=await V(D,C,A);if(v)return v}}if(g!==C.method)return new Response("Method Not Allowed",{status:405});let E=await $(C,A);if(E instanceof Promise)return await E??new Response("Not Found",{status:404});return E??new Response("Not Found",{status:404})}}else this.routes[f]=async($,C)=>{if(this.hasMiddleware){if(this.globalMiddlewares.length){let E=await V(this.globalMiddlewares,$,C);if(E)return E}let A=this.middlewares.get(f)||[];if(A?.length){let E=await V(A,$,C);if(E)return E}}if(g!==$.method)return new Response("Method Not Allowed",{status:405});for(let A=0;A<L.length;A++){let E=L[A]($,C);if(E instanceof Promise)return await E??new Response("Not Found",{status:404});return E??new Response("Not Found",{status:404})}}}listen(g,...f){if(typeof Bun==="undefined")throw new Error(".listen() is designed to run on Bun only...");let L="0.0.0.0",$=void 0,C={};for(let E of f)if(typeof E==="string")L=E;else if(typeof E==="function")$=E;else if(typeof E==="object"&&E!==null)C=E;this.compile();let A={port:g,hostname:L,idleTimeOut:this.idleTimeOut,fetch:this.fetch(),static:this.staticFiles};if(this.routes&&Object.keys(this.routes).length>0)A.routes=this.routes;if(C.cert&&C.key)A.certFile=C.cert,A.keyFile=C.key;if(this.serverInstance=Bun?.serve(A),$)return $();return this.serverInstance}fetch(){return this.compile(),async(g,f)=>{let L=new URL(g.url);if(this.hooks.onRequest){let $=this.hooks.onRequest;for(let C=0;C<$.length;C++)await $[C](g,L,f)}return _(g,f,L,this)}}close(g){if(this.serverInstance)this.serverInstance.stop(!0),this.serverInstance=null,g?g():console.log("Server has been stopped");else console.warn("Server is not running.")}route(g,f){if(!g||typeof g!=="string")throw new Error("Path must be a string");let L=Object.fromEntries(f.tempRoutes);return Object.entries(L).forEach(([C,A])=>{let E=C.replace(/::\w+$/,""),D=`${g}${E}`;if(!this.middlewares.has(D))this.middlewares.set(D,[]);A.handlers.slice(0,-1).forEach((G)=>{if(!this.middlewares.get(D)?.includes(G))this.middlewares.get(D)?.push(G)});let U=A.handlers[A.handlers.length-1],z=A.method;try{this.trie.insert(D,{handler:U,method:z})}catch(G){console.error(`Error inserting ${D}:`,G)}}),f=null,this}register(g,f){return this.route(g,f)}addRoute(g,f,L){if(typeof f!=="string")throw new Error(`Error in ${L[L.length-1]}: Path must be a string. Received: ${typeof f}`);if(typeof g!=="string")throw new Error(`Error in addRoute: Method must be a string. Received: ${typeof g}`);this.tempRoutes?.set(f+"::"+g,{method:g,handlers:L});let $=L.slice(0,-1),C=L[L.length-1];if(!this.middlewares.has(f))this.middlewares.set(f,[]);$.forEach((A)=>{if(f==="/")this.globalMiddlewares=[...new Set([...this.globalMiddlewares,...$])];else if(!this.middlewares.get(f)?.includes(A))this.middlewares.get(f)?.push(A)});try{if(g==="ANY"){let A=["GET","POST","PUT","DELETE","PATCH","OPTIONS","HEAD","PROPFIND"];for(let E of A)this.trie.insert(f,{handler:C,method:E})}this.trie.insert(f,{handler:C,method:g})}catch(A){console.error(`Error inserting ${f}:`,A)}}use(g,f){if(Array.isArray(g))g.forEach(($)=>{if(typeof $==="function")this.globalMiddlewares.push($)});if(typeof g==="function"){if(this.globalMiddlewares.push(g),Array.isArray(f))f.forEach(($)=>{this.globalMiddlewares.push($)});return this}return(Array.isArray(g)?g.filter(($)=>typeof $==="string"):[g].filter(($)=>typeof $==="string")).forEach(($)=>{if(!this.middlewares.has($))this.middlewares.set($,[]);if(f)(Array.isArray(f)?f:[f]).forEach((A)=>{this.middlewares.get($)?.push(A)})}),this}get(g,...f){return this.addRoute("GET",g,f),this}post(g,...f){return this.addRoute("POST",g,f),this}put(g,...f){return this.addRoute("PUT",g,f),this}patch(g,...f){return this.addRoute("PATCH",g,f),this}delete(g,...f){return this.addRoute("DELETE",g,f),this}any(g,...f){return this.addRoute("ANY",g,f),this}head(g,...f){return this.addRoute("HEAD",g,f),this}options(g,...f){return this.addRoute("OPTIONS",g,f),this}propfind(g,...f){return this.addRoute("PROPFIND",g,f),this}routeNotFound(g){return this.routeNotFoundFunc=g,this}}export{M as default};
