var P=Object.create;var{getPrototypeOf:u,defineProperty:O,getOwnPropertyNames:w}=Object;var x=Object.prototype.hasOwnProperty;var k=(f,g,L)=>{L=f!=null?P(u(f)):{};let $=g||!f||!f.__esModule?O(L,"default",{value:f,enumerable:!0}):L;for(let A of w(f))if(!x.call($,A))O($,A,{get:()=>f[A],enumerable:!0});return $};var o=((f)=>typeof require!=="undefined"?require:typeof Proxy!=="undefined"?new Proxy(f,{get:(g,L)=>(typeof require!=="undefined"?require:g)[L]}):f)(function(f){if(typeof require!=="undefined")return require.apply(this,arguments);throw Error('Dynamic require of "'+f+'" is not supported')});class W{children;isEndOfWord;handler;isDynamic;pattern;path;method;constructor(){this.children={},this.isEndOfWord=!1,this.handler=[],this.isDynamic=!1,this.pattern="",this.path="",this.method=[]}}class N{root;constructor(){this.root=new W}insert(f,g){let L=this.root,$=f.split("/").filter(Boolean);if(f==="/"){L.isEndOfWord=!0,L.handler.push(g.handler),L.path=f,L.method.push(g.method);return}for(let A of $){let C=!1,v=A;if(A.startsWith(":"))C=!0,v=":";if(!L.children[v])L.children[v]=new W;L=L.children[v],L.isDynamic=C,L.pattern=A}L.isEndOfWord=!0,L.path=f,L.method.push(g.method),L.handler.push(g.handler)}search(f,g){let L=this.root,$=f.split("/").filter(Boolean),A=$.length;for(let D of $){let E=D;if(!L.children[E])if(L.children[":"])L=L.children[":"];else return null;else L=L.children[E]}let C=L.path.split("/").filter(Boolean);if(A!==C.length)return null;let v=L.method.indexOf(g);if(v!==-1)return{path:L.path,handler:L.handler[v],isDynamic:L.isDynamic,pattern:L.pattern,method:L.method[v]};return{path:L.path,handler:L.handler,isDynamic:L.isDynamic,pattern:L.pattern,method:L.method[v]}}}function S(f){switch(f.split(".").pop()?.toLowerCase()){case"js":return"application/javascript";case"css":return"text/css";case"html":return"text/html";case"json":return"application/json";case"png":return"image/png";case"jpg":case"jpeg":return"image/jpeg";case"svg":return"image/svg+xml";case"gif":return"image/gif";case"woff":return"font/woff";case"woff2":return"font/woff2";default:return"application/octet-stream"}}function J(f,g,L){let $=null,A=null,C=null,v=null,D={};return{req:f,server:g,url:L,status:200,headers:new Headers({"Cache-Control":"no-cache"}),setHeader(E,U){return this.headers.set(E,U),this},removeHeader(E){return this.headers.delete(E),this},get ip(){return this.server.requestIP(this.req)?.address??null},get query(){if(!$)try{$=Object.fromEntries(this.url.searchParams)}catch(E){throw new Error("Failed to parse query parameters")}return $},get params(){if(!A&&this.req.routePattern)try{A=r(this.req.routePattern,this.url.pathname)}catch(E){throw new Error("Failed to extract route parameters")}return A??{}},get body(){if(this.req.method==="GET")return Promise.resolve({});if(!v)v=(async()=>{let E=await s(this.req);if(E.error)throw new Error(E.error);return Object.keys(E).length===0?null:E})();return v},set(E,U){return D[E]=U,this},get(E){return D[E]},text(E,U){if(U)this.status=U;if(!this.headers.has("Content-Type"))this.headers.set("Content-Type","text/plain; charset=utf-8");return new Response(E,{status:this.status,headers:this.headers})},send(E,U){if(U)this.status=U;let z=new Map([["string","text/plain; charset=utf-8"],["object","application/json; charset=utf-8"],["Uint8Array","application/octet-stream"],["ArrayBuffer","application/octet-stream"]]),G;if(E instanceof Uint8Array)G="Uint8Array";else if(E instanceof ArrayBuffer)G="ArrayBuffer";else G=typeof E;if(!this.headers.has("Content-Type"))this.headers.set("Content-Type",z.get(G)??"text/plain; charset=utf-8");let X=G==="object"&&E!==null?JSON.stringify(E):E;return new Response(X,{status:this.status,headers:this.headers})},json(E,U){if(U)this.status=U;if(!this.headers.has("Content-Type"))this.headers.set("Content-Type","application/json; charset=utf-8");return Response.json(E,{status:this.status,headers:this.headers})},file(E,U,z){if(z)this.status=z;let G=Bun.file(E);if(!this.headers.has("Content-Type"))this.headers.set("Content-Type",U??S(E));return new Response(G,{status:this.status,headers:this.headers})},async ejs(E,U={},z){if(z)this.status=z;let G;try{G=await import("ejs"),G=G.default||G}catch(X){return console.error("EJS not installed! Please run `bun add ejs`"),new Response("EJS not installed! Please run `bun add ejs`",{status:500})}try{let X=await Bun.file(E).text(),Z=G.render(X,U),M=new Headers({"Content-Type":"text/html; charset=utf-8"});return new Response(Z,{status:this.status,headers:M})}catch(X){return console.error("EJS Rendering Error:",X),new Response("Error rendering template",{status:500})}},redirect(E,U){if(U)this.status=U;else this.status=302;return this.headers.set("Location",E),new Response(null,{status:this.status,headers:this.headers})},stream(E){let U=new Headers(this.headers),z=new ReadableStream({async start(G){await E(G),G.close()}});return new Response(z,{headers:U})},yieldStream(E){return new Response({async*[Symbol.asyncIterator](){yield*E()}},{headers:this.headers})},setCookie(E,U,z={}){let G=`${encodeURIComponent(E)}=${encodeURIComponent(U)}`;if(z.maxAge)G+=`; Max-Age=${z.maxAge}`;if(z.expires)G+=`; Expires=${z.expires.toUTCString()}`;if(z.path)G+=`; Path=${z.path}`;if(z.domain)G+=`; Domain=${z.domain}`;if(z.secure)G+="; Secure";if(z.httpOnly)G+="; HttpOnly";if(z.sameSite)G+=`; SameSite=${z.sameSite}`;return this.headers.append("Set-Cookie",G),this},get cookies(){if(!C){let E=this.req.headers.get("cookie");C=E?i(E):{}}return C}}}function i(f){return Object.fromEntries(f.split(";").map((g)=>{let[L,...$]=g.trim().split("=");return[L,decodeURIComponent($.join("="))]}))}function r(f,g){let L={},$=f.split("/"),[A]=g.split("?"),C=A.split("/");if($.length!==C.length)return null;for(let v=0;v<$.length;v++)if($[v].startsWith(":"))L[$[v].slice(1)]=C[v];return L}async function s(f){let g=f.headers.get("Content-Type");if(!g)return{};if(f.headers.get("Content-Length")==="0"||!f.body)return{};try{if(g.startsWith("application/json"))return await f.json();if(g.startsWith("application/x-www-form-urlencoded")){let $=await f.text();return Object.fromEntries(new URLSearchParams($))}if(g.startsWith("multipart/form-data")){let $=await f.formData(),A={};for(let[C,v]of $.entries())A[C]=v;return A}return{error:"Unknown request body type"}}catch($){return{error:"Invalid request body format"}}}async function I(f,g,L,$){let A=J(f,g,L),C=$.trie.search(L.pathname,f.method);f.routePattern=C?.path;try{if($.hasMiddleware){if($.globalMiddlewares.length){let U=await b($.globalMiddlewares,A,g);if(U)return U}let E=$.middlewares.get(L.pathname)||[];if(E?.length){let U=await b(E,A,g);if(U)return U}}if($.hasFilterEnabled){let E=f.routePattern??L.pathname,U=await l($,E,A,g),z=U instanceof Promise?await U:U;if(z)return z}if(!C?.handler||C.method!==f.method){if($.staticPath){let U=await p($,L.pathname,A);if(U)return U;let z=$.trie.search("*",f.method);if(z?.handler)return await z.handler(A)}let E=$.routeNotFoundFunc(A);if(E)return E;return Q(404,`Route not found for ${L.pathname}`)}if($.hooks.preHandler?.length&&Array.isArray($.hooks.preHandler)){let E=$.hooks.preHandler;for(let U=0;U<E.length;U++){let z=E[U](A),G=z instanceof Promise?await z:z;if(G)return G}}let v=C.handler(A);return(v instanceof Promise?await v:v)??Q(204,"")}catch(v){if($.hooks.onError&&Array.isArray($.hooks.onError)){let D=$.hooks.onError;for(let E=0;E<D.length;E++){let U=$.hooks.onError[E](v,f,L,g),z=U instanceof Promise?await U:U;if(z)return z}}return Q(500,"Internal Server Error")}finally{if($.hooks.onSend&&Array.isArray($.hooks.onSend)){let v=$.hooks.onSend;for(let D=0;D<v.length;D++){let E=v[D](A),U=E instanceof Promise?await E:E;if(U)return U}}}}async function b(f,g,L){for(let $ of f){let A=await $(g,L);if(A)return A}return null}async function V(f,g,L){for(let $ of f){let A=await $(g,L);if(A)return A}}async function l(f,g,L,$){if(g.endsWith("/"))g=g.slice(0,-1);if(!f.filters.has(g))if(f.filterFunction.length)for(let A of f.filterFunction){let C=await A(L,$);if(C)return C}else return Response.json({error:"Protected route, authentication required"},{status:401})}async function V1(f,g,L,$){if(!f.filters.has(g))if(f.filterFunction.length)for(let A of f.filterFunction){let C=await A(L,$);if(C)return C}else return Response.json({error:"Protected route, authentication required"},{status:401})}function Q(f,g){return new Response(JSON.stringify({error:g}),{status:f,headers:{"Content-Type":"application/json"}})}async function p(f,g,L){if(!f.staticPath)return null;let $=`${f.staticPath}${g}`;if(await Bun.file($).exists()){let C=S($);return L.file($,C,200)}return null}function Y(f){if(typeof f!=="string")throw new TypeError("Path must be a string. Received "+JSON.stringify(f))}function y(f,g){var L="",$=0,A=-1,C=0,v;for(var D=0;D<=f.length;++D){if(D<f.length)v=f.charCodeAt(D);else if(v===47)break;else v=47;if(v===47){if(A===D-1||C===1);else if(A!==D-1&&C===2){if(L.length<2||$!==2||L.charCodeAt(L.length-1)!==46||L.charCodeAt(L.length-2)!==46){if(L.length>2){var E=L.lastIndexOf("/");if(E!==L.length-1){if(E===-1)L="",$=0;else L=L.slice(0,E),$=L.length-1-L.lastIndexOf("/");A=D,C=0;continue}}else if(L.length===2||L.length===1){L="",$=0,A=D,C=0;continue}}if(g){if(L.length>0)L+="/..";else L="..";$=2}}else{if(L.length>0)L+="/"+f.slice(A+1,D);else L=f.slice(A+1,D);$=D-A-1}A=D,C=0}else if(v===46&&C!==-1)++C;else C=-1}return L}function h(f,g){var L=g.dir||g.root,$=g.base||(g.name||"")+(g.ext||"");if(!L)return $;if(L===g.root)return L+$;return L+f+$}function T(){var f="",g=!1,L;for(var $=arguments.length-1;$>=-1&&!g;$--){var A;if($>=0)A=arguments[$];else{if(L===void 0)L=process.cwd();A=L}if(Y(A),A.length===0)continue;f=A+"/"+f,g=A.charCodeAt(0)===47}if(f=y(f,!g),g)if(f.length>0)return"/"+f;else return"/";else if(f.length>0)return f;else return"."}function m(f){if(Y(f),f.length===0)return".";var g=f.charCodeAt(0)===47,L=f.charCodeAt(f.length-1)===47;if(f=y(f,!g),f.length===0&&!g)f=".";if(f.length>0&&L)f+="/";if(g)return"/"+f;return f}function d(f){return Y(f),f.length>0&&f.charCodeAt(0)===47}function t(){if(arguments.length===0)return".";var f;for(var g=0;g<arguments.length;++g){var L=arguments[g];if(Y(L),L.length>0)if(f===void 0)f=L;else f+="/"+L}if(f===void 0)return".";return m(f)}function a(f,g){if(Y(f),Y(g),f===g)return"";if(f=T(f),g=T(g),f===g)return"";var L=1;for(;L<f.length;++L)if(f.charCodeAt(L)!==47)break;var $=f.length,A=$-L,C=1;for(;C<g.length;++C)if(g.charCodeAt(C)!==47)break;var v=g.length,D=v-C,E=A<D?A:D,U=-1,z=0;for(;z<=E;++z){if(z===E){if(D>E){if(g.charCodeAt(C+z)===47)return g.slice(C+z+1);else if(z===0)return g.slice(C+z)}else if(A>E){if(f.charCodeAt(L+z)===47)U=z;else if(z===0)U=0}break}var G=f.charCodeAt(L+z),X=g.charCodeAt(C+z);if(G!==X)break;else if(G===47)U=z}var Z="";for(z=L+U+1;z<=$;++z)if(z===$||f.charCodeAt(z)===47)if(Z.length===0)Z+="..";else Z+="/..";if(Z.length>0)return Z+g.slice(C+U);else{if(C+=U,g.charCodeAt(C)===47)++C;return g.slice(C)}}function e(f){return f}function f1(f){if(Y(f),f.length===0)return".";var g=f.charCodeAt(0),L=g===47,$=-1,A=!0;for(var C=f.length-1;C>=1;--C)if(g=f.charCodeAt(C),g===47){if(!A){$=C;break}}else A=!1;if($===-1)return L?"/":".";if(L&&$===1)return"//";return f.slice(0,$)}function g1(f,g){if(g!==void 0&&typeof g!=="string")throw new TypeError('"ext" argument must be a string');Y(f);var L=0,$=-1,A=!0,C;if(g!==void 0&&g.length>0&&g.length<=f.length){if(g.length===f.length&&g===f)return"";var v=g.length-1,D=-1;for(C=f.length-1;C>=0;--C){var E=f.charCodeAt(C);if(E===47){if(!A){L=C+1;break}}else{if(D===-1)A=!1,D=C+1;if(v>=0)if(E===g.charCodeAt(v)){if(--v===-1)$=C}else v=-1,$=D}}if(L===$)$=D;else if($===-1)$=f.length;return f.slice(L,$)}else{for(C=f.length-1;C>=0;--C)if(f.charCodeAt(C)===47){if(!A){L=C+1;break}}else if($===-1)A=!1,$=C+1;if($===-1)return"";return f.slice(L,$)}}function L1(f){Y(f);var g=-1,L=0,$=-1,A=!0,C=0;for(var v=f.length-1;v>=0;--v){var D=f.charCodeAt(v);if(D===47){if(!A){L=v+1;break}continue}if($===-1)A=!1,$=v+1;if(D===46){if(g===-1)g=v;else if(C!==1)C=1}else if(g!==-1)C=-1}if(g===-1||$===-1||C===0||C===1&&g===$-1&&g===L+1)return"";return f.slice(g,$)}function $1(f){if(f===null||typeof f!=="object")throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof f);return h("/",f)}function C1(f){Y(f);var g={root:"",dir:"",base:"",ext:"",name:""};if(f.length===0)return g;var L=f.charCodeAt(0),$=L===47,A;if($)g.root="/",A=1;else A=0;var C=-1,v=0,D=-1,E=!0,U=f.length-1,z=0;for(;U>=A;--U){if(L=f.charCodeAt(U),L===47){if(!E){v=U+1;break}continue}if(D===-1)E=!1,D=U+1;if(L===46){if(C===-1)C=U;else if(z!==1)z=1}else if(C!==-1)z=-1}if(C===-1||D===-1||z===0||z===1&&C===D-1&&C===v+1){if(D!==-1)if(v===0&&$)g.base=g.name=f.slice(1,D);else g.base=g.name=f.slice(v,D)}else{if(v===0&&$)g.name=f.slice(1,C),g.base=f.slice(1,D);else g.name=f.slice(v,C),g.base=f.slice(v,D);g.ext=f.slice(C,D)}if(v>0)g.dir=f.slice(0,v-1);else if($)g.dir="/";return g}var A1="/",E1=":",v1=((f)=>(f.posix=f,f))({resolve:T,normalize:m,isAbsolute:d,join:t,relative:a,_makeLong:e,dirname:f1,basename:g1,extname:L1,format:$1,parse:C1,sep:A1,delimiter:E1,win32:null,posix:null}),F=v1;var{default:B}=(()=>({}));var K={reset:"\x1B[0m",info:"\x1B[36m",warn:"\x1B[33m",error:"\x1B[31m",method:{GET:"\x1B[32m",POST:"\x1B[34m",PUT:"\x1B[35m",DELETE:"\x1B[31m",PATCH:"\x1B[36m"}},n=(f,g,L)=>{let $=K[f]||K.reset,A=L?.method?K.method[L.method]||K.reset:K.reset,C=L?.status?L.status>=500?K.error:L.status>=400?K.warn:K.info:K.reset;console.log(`
${$}[${f.toUpperCase()}]${K.reset} ${g} - ${A}${L?.method||""}${K.reset}`);let v={timestamp:new Date().toISOString(),...L,status:L?.status?`${C}${L.status}${K.reset}`:void 0,method:L?.method?`${A>$}${L.method}${K.reset}`:void 0};console.log(JSON.stringify(v,null,2)+`
`)},H=(f)=>{let{app:g,logger:L,logLevel:$="info",onRequest:A,onSend:C,onError:v,routeNotFound:D}=f||{};g?.addHooks("onRequest",(E,U)=>{E.startTime=Date.now(),L?.()??n($,"Incoming Request",{method:E.method,url:U.toString(),headers:{"user-agent":E.headers.get("user-agent"),"content-type":E.headers.get("content-type")}}),A?.(E,U)}),g?.addHooks("onSend",async(E)=>{let U=`${Date.now()-E.req.startTime}ms`;L?.()??n($,"Response Sent",{method:E.req.method,url:E.url.toString(),status:E.status,duration:U,reqId:E.get?.("requestId"),headers:{"content-type":E.headers.get("content-type")}});let z=await C?.(E);if(z instanceof Response)return z}),g?.addHooks("routeNotFound",async(E)=>{L?.()&&L();let U=await D?.(E);if(U instanceof Response)return U}),g?.addHooks("onError",async(E,U,z)=>{L?.()??n("error","Unhandled Error",{method:U.method,url:z.toString(),status:500,error:E.message});let G=await v?.(E,U,z);if(G instanceof Response)return G})},_=(f,g,L,$=0,A,C)=>{let v=K.method[g]||K.reset,D=$>=500?K.error:$>=400?K.warn:K.info,E=C?`[${C}] `:"",U=f==="<--"?`${f} ${v}${g}${K.reset} ${L} ${E}`:`${f} ${v}${g}${K.reset} ${L} ${D}${$}${K.reset} ${A??""} ${E}`;console.log(U)},D1=(f)=>{let g=Date.now()-f;return g<1000?`${g}ms`:`${Math.round(g/1000)}s`},j=(f)=>{let{app:g,log:L,onRequest:$,onSend:A,onError:C,routeNotFound:v}=f;g.addHooks("onRequest",(D,E)=>{D.startTime=Date.now(),L?.()??_("<--",D.method,E.pathname),$?.(D,E)}),g.addHooks("onSend",async(D)=>{let{method:E,url:U}=D.req,z=new URL(U).pathname,G=D.get?.("requestId");L?.()??_("-->",E,z,D.status,D1(D.req.startTime),G);let X=await A?.(D);if(X instanceof Response)return X}),g.addHooks("routeNotFound",async(D)=>{L?.()&&L();let E=await v?.(D);if(E instanceof Response)return E}),g.addHooks("onError",async(D,E,U)=>{L?.()??_(D.message,E.method,U.toString(),500);let z=await C?.(D,E,U);if(z instanceof Response)return z})};function R(f,g){if(!f)throw new Error("JWT library is not defined, please provide jwt to authenticateJwt Function");return(L)=>{try{let $=L.cookies?.accessToken??L.req?.headers?.get("Authorization");if(!$)return L.json({message:"Unauthorized",error:"No token provided"},401);if($.startsWith("Bearer "))$=$.slice(7);let A=f?.verify($,g);if(!A)return L.json({message:"Unauthorized",error:"Token could not be decoded"},401);L.set("user",A)}catch($){let A="Invalid token";if($.name==="TokenExpiredError")A="Token expired";else if($.name==="JsonWebTokenError")A="Malformed or tampered token";return L.json({message:"Unauthorized",error:A},401)}}}function c(f,g,L){if(!f)throw new Error("JWT library is not defined, please provide jwt to authenticateJwtDB Function");if(!g)throw new Error("User model is not defined, please provide UserModel to authenticateJwtDB Function");return async($)=>{try{let A=$.cookies?.accessToken??$.req?.headers?.get("Authorization");if(!A)return $.json({message:"Unauthorized",error:"No token provided"},401);if(A.startsWith("Bearer "))A=A.slice(7);let C=f?.verify(A,L);if(!C)return $.json({message:"Unauthorized",error:"Token could not be decoded"},401);let v=await g.findById(C._id).select("-password -refreshToken");if(!v)return $.json({message:"Unauthorized: User not found"},404);$.set("user",v);return}catch(A){let C="Invalid token";if(A.name==="TokenExpiredError")C="Token expired";else if(A.name==="JsonWebTokenError")C="Malformed or tampered token";return $.json({message:"Unauthorized",error:C},401)}}}class q{routes;tempRoutes;globalMiddlewares;middlewares;trie;hasOnReqHook;hasMiddleware;hasPreHandlerHook;hasPostHandlerHook;hasOnSendHook;hasOnError;hooks;corsConfig;FilterRoutes;filters;filterFunction;hasFilterEnabled;serverInstance;staticPath;staticFiles;user_jwt_secret;baseApiUrl;enableFileRouter;idleTimeOut;routeNotFoundFunc;constructor({jwtSecret:f,baseApiUrl:g,enableFileRouting:L,idleTimeOut:$}={}){this.routes={},this.idleTimeOut=$??10,this.enableFileRouter=L??!1,this.baseApiUrl=g||"",this.user_jwt_secret=f||process.env.DIESEL_JWT_SECRET||"feault_diesel_secret_for_jwt",this.tempRoutes=new Map,this.globalMiddlewares=[],this.middlewares=new Map,this.trie=new N,this.corsConfig=null,this.hasMiddleware=!1,this.hasOnReqHook=!1,this.hasPreHandlerHook=!1,this.hasPostHandlerHook=!1,this.hasOnSendHook=!1,this.hasOnError=!1,this.hooks={onRequest:[],preHandler:[],postHandler:[],onSend:[],onError:[],onClose:[]},this.FilterRoutes=[],this.filters=new Set,this.filterFunction=[],this.hasFilterEnabled=!1,this.serverInstance=null,this.staticPath=null,this.staticFiles={},this.routeNotFoundFunc=()=>{}}setupFilter(){return this.hasFilterEnabled=!0,{publicRoutes:(...f)=>{return this.FilterRoutes=f,this.setupFilter()},permitAll:()=>{for(let f of this?.FilterRoutes){if(f.endsWith("/"))f=f.slice(0,-1);this.filters.add(f)}return this.FilterRoutes=null,this.setupFilter()},authenticate:(f)=>{if(f?.length)for(let g of f)this.filterFunction.push(g)},authenticateJwt:(f)=>{this.filterFunction.push(R(f,this.user_jwt_secret))},authenticateJwtDB:(f,g)=>{this.filterFunction.push(c(f,g,this.user_jwt_secret))}}}redirect(f,g,L){return this.any(f,($)=>{let A=$.params,C=g;if(A)for(let D in A)C=C.replace(`:${D}`,A[D]);let v=$.url.search;if(v)C+=v;return $.redirect(C,L)}),this}serveStatic(f){return this.staticPath=f,this}static(f){return this.staticPath=f,this}staticHtml(f){return this.staticFiles={...this.staticFiles,...f},this}addHooks(f,g){if(typeof f!=="string")throw new Error("hookName must be a string");if(typeof g!=="function")throw new Error("callback must be a instance of function");switch(f){case"onRequest":this.hooks.onRequest?.push(g);break;case"preHandler":this.hooks.preHandler?.push(g);break;case"postHandler":this.hooks.postHandler?.push(g);break;case"onSend":this.hooks.onSend?.push(g);break;case"onError":this.hooks.onError?.push(g);break;case"onClose":this.hooks.onClose?.push(g);break;default:throw new Error(`Unknown hook type: ${f}`)}return this}compile(){if(this.globalMiddlewares.length>0)this.hasMiddleware=!0;for(let[f,g]of this.middlewares.entries())if(g.length>0){this.hasMiddleware=!0;break}if(this.enableFileRouter){let f=process.cwd(),g=F.join(f,"src","routes");if(B?.existsSync(g))this.loadRoutes(g,"")}setTimeout(()=>{this.tempRoutes=null},2000)}async registerFileRoutes(f,g,L){let $=await import(f),A;if(L===".ts")A=F.basename(f,".ts");else if(L===".js")A=F.basename(f,".js");let C=g+"/"+A;if(C.endsWith("/index"))C=g;else if(C.endsWith("/api"))C=g;C=C.replace(/\[(.*?)\]/g,":$1");let v=["GET","POST","PUT","PATCH","DELETE","ANY","HEAD","OPTIONS","PROPFIND"];for(let D of v)if($[D]){let E=D.toLowerCase(),U=$[D];this[E](`${this.baseApiUrl}${C}`,U)}}async loadRoutes(f,g){let L=await B.promises.readdir(f);for(let $ of L){let A=F.join(f,$);if((await B.promises.stat(A)).isDirectory())this.loadRoutes(A,g+"/"+$);else if($.endsWith(".ts"))this.registerFileRoutes(A,g,".ts");else if($.endsWith(".js"))this.registerFileRoutes(A,g,".js")}}useLogger(f){return j(f),this}useAdvancedLogger(f){return H(f),this}BunRoute(f,g,...L){if(!g||typeof g!=="string")throw new Error("give a path in string format");if(L.length===1){let $=L[0];this.routes[g]=async(A,C)=>{if(this.hasMiddleware){if(this.globalMiddlewares.length){let E=await V(this.globalMiddlewares,A,C);if(E)return E}let D=this.middlewares.get(g)||[];if(D?.length){let E=await V(D,A,C);if(E)return E}}if(f!==A.method)return new Response("Method Not Allowed",{status:405});let v=await $(A,C);if(v instanceof Promise)return await v??new Response("Not Found",{status:404});return v??new Response("Not Found",{status:404})}}else this.routes[g]=async($,A)=>{if(this.hasMiddleware){if(this.globalMiddlewares.length){let v=await V(this.globalMiddlewares,$,A);if(v)return v}let C=this.middlewares.get(g)||[];if(C?.length){let v=await V(C,$,A);if(v)return v}}if(f!==$.method)return new Response("Method Not Allowed",{status:405});for(let C=0;C<L.length;C++){let v=L[C]($,A);if(v instanceof Promise)return await v??new Response("Not Found",{status:404});return v??new Response("Not Found",{status:404})}}}listen(f,...g){if(typeof Bun==="undefined")throw new Error(".listen() is designed to run on Bun only...");let L="0.0.0.0",$=void 0,A={};for(let v of g)if(typeof v==="string")L=v;else if(typeof v==="function")$=v;else if(typeof v==="object"&&v!==null)A=v;this.compile();let C={port:f,hostname:L,idleTimeOut:this.idleTimeOut,fetch:async(v,D)=>{let E=new URL(v.url);if(this.hooks.onRequest){let U=this.hooks.onRequest;for(let z=0;z<U.length;z++)await U[z](v,E,D)}return I(v,D,E,this)},static:this.staticFiles};if(this.routes&&Object.keys(this.routes).length>0)C.routes=this.routes;if(A.cert&&A.key)C.certFile=A.cert,C.keyFile=A.key;if(this.serverInstance=Bun?.serve(C),$)return $();return this.serverInstance}close(f){if(this.serverInstance)this.serverInstance.stop(!0),this.serverInstance=null,f?f():console.log("Server has been stopped");else console.warn("Server is not running.")}route(f,g){if(!f||typeof f!=="string")throw new Error("Path must be a string");let L=Object.fromEntries(g.tempRoutes);return Object.entries(L).forEach(([A,C])=>{let v=A.replace(/::\w+$/,""),D=`${f}${v}`;if(!this.middlewares.has(D))this.middlewares.set(D,[]);C.handlers.slice(0,-1).forEach((G)=>{if(!this.middlewares.get(D)?.includes(G))this.middlewares.get(D)?.push(G)});let U=C.handlers[C.handlers.length-1],z=C.method;try{this.trie.insert(D,{handler:U,method:z})}catch(G){console.error(`Error inserting ${D}:`,G)}}),g=null,this}register(f,g){return this.route(f,g)}addRoute(f,g,L){if(typeof g!=="string")throw new Error(`Error in ${L[L.length-1]}: Path must be a string. Received: ${typeof g}`);if(typeof f!=="string")throw new Error(`Error in addRoute: Method must be a string. Received: ${typeof f}`);this.tempRoutes?.set(g+"::"+f,{method:f,handlers:L});let $=L.slice(0,-1),A=L[L.length-1];if(!this.middlewares.has(g))this.middlewares.set(g,[]);$.forEach((C)=>{if(g==="/")this.globalMiddlewares=[...new Set([...this.globalMiddlewares,...$])];else if(!this.middlewares.get(g)?.includes(C))this.middlewares.get(g)?.push(C)});try{if(f==="ANY"){let C=["GET","POST","PUT","DELETE","PATCH","OPTIONS","HEAD","PROPFIND"];for(let v of C)this.trie.insert(g,{handler:A,method:v})}this.trie.insert(g,{handler:A,method:f})}catch(C){console.error(`Error inserting ${g}:`,C)}}use(f,g){if(Array.isArray(f))f.forEach(($)=>{if(typeof $==="function")this.globalMiddlewares.push($)});if(typeof f==="function"){if(this.globalMiddlewares.push(f),Array.isArray(g))g.forEach(($)=>{this.globalMiddlewares.push($)});return this}return(Array.isArray(f)?f.filter(($)=>typeof $==="string"):[f].filter(($)=>typeof $==="string")).forEach(($)=>{if(!this.middlewares.has($))this.middlewares.set($,[]);if(g)(Array.isArray(g)?g:[g]).forEach((C)=>{this.middlewares.get($)?.push(C)})}),this}get(f,...g){return this.addRoute("GET",f,g),this}post(f,...g){return this.addRoute("POST",f,g),this}put(f,...g){return this.addRoute("PUT",f,g),this}patch(f,...g){return this.addRoute("PATCH",f,g),this}delete(f,...g){return this.addRoute("DELETE",f,g),this}any(f,...g){return this.addRoute("ANY",f,g),this}head(f,...g){return this.addRoute("HEAD",f,g),this}options(f,...g){return this.addRoute("OPTIONS",f,g),this}propfind(f,...g){return this.addRoute("PROPFIND",f,g),this}routeNotFound(f){return this.routeNotFoundFunc=f,this}}export{q as default};
